@using PlayerRatings.Localization
@model PlayerRatings.ViewModels.Tournament.TournamentDetailsViewModel
@inject Microsoft.Extensions.Localization.IStringLocalizer<LocalizationKey> LocString

@{
    ViewData["Title"] = Model.FullName;
}

<h2>@ViewData["Title"]</h2>
<hr />

<div class="form-group" style="display: inline-flex; gap: 4px; align-items: center; flex-wrap: wrap;">
    <a asp-action="Index" asp-route-leagueId="@Model.LeagueId" class="btn btn-default btn-sm" title="@LocString[nameof(LocalizationKey.BackToTournaments)]">‚Ü©</a>
    @if (Model.IsAdmin)
    {
        <a asp-controller="Matches" asp-action="Create" 
           asp-route-leagueId="@Model.LeagueId" 
           asp-route-tournamentId="@Model.Id"
           asp-route-lastMatchDateTime="@((Model.StartDate ?? DateTimeOffset.UtcNow).ToString("o"))"
           class="btn btn-success btn-sm" title="@LocString[nameof(LocalizationKey.AddNewResult)]">+</a>
        <a asp-action="ImportH9" asp-route-id="@Model.Id" class="btn btn-info btn-sm" title="@LocString[nameof(LocalizationKey.Import)]">üì•</a>
        <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-primary btn-sm" title="@LocString[nameof(LocalizationKey.Edit)]">‚úèÔ∏è</a>
        <a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-danger btn-sm" title="@LocString[nameof(LocalizationKey.Delete)]">üóëÔ∏è</a>
    }
</div>

<div class="panel panel-default" style="margin-top: 20px;">
    <div class="panel-body">
        <div class="row">
            @if (!string.IsNullOrEmpty(Model.Photo))
            {
                <div class="col-md-3">
                    <img src="@Model.Photo" alt="@Model.FullName" style="max-width: 100%; max-height: 200px; border-radius: 4px; cursor: pointer;" onclick="showPhotoModal(this.src)" title="@LocString[nameof(LocalizationKey.ClickToEnlarge)]" />
                </div>
            }
            <div class="@(string.IsNullOrEmpty(Model.Photo) ? "col-md-6" : "col-md-4")">
                <dl>
                    @if (!string.IsNullOrEmpty(Model.Ordinal))
                    {
                        <dt>@LocString[nameof(LocalizationKey.Ordinal)]</dt>
                        <dd>@Model.Ordinal</dd>
                    }
                    
                    <dt>@LocString[nameof(LocalizationKey.TournamentName)]</dt>
                    <dd>@Model.Name</dd>
                    
                    @if (!string.IsNullOrEmpty(Model.Group))
                    {
                        <dt>@(Model.IsTitleTournament ? LocString[nameof(LocalizationKey.Title)] : LocString[nameof(LocalizationKey.Group)])</dt>
                        <dd>@Model.Group</dd>
                    }
                    
                    @if (!string.IsNullOrEmpty(Model.TournamentType))
                    {
                        <dt>@LocString[nameof(LocalizationKey.Type)]</dt>
                        <dd>@Model.TournamentType</dd>
                    }
                </dl>
            </div>
            <div class="@(string.IsNullOrEmpty(Model.Photo) ? "col-md-6" : "col-md-5")">
                <dl>
                    @if (!string.IsNullOrEmpty(Model.Organizer))
                    {
                        <dt>@LocString[nameof(LocalizationKey.Organizer)]</dt>
                        <dd>@Model.Organizer</dd>
                    }
                    
                    @if (!string.IsNullOrEmpty(Model.Location))
                    {
                        <dt>@LocString[nameof(LocalizationKey.Location)]</dt>
                        <dd>@Model.Location</dd>
                    }
                    
                    @if (Model.StartDate.HasValue)
                    {
                        <dt>@LocString[nameof(LocalizationKey.Dates)]</dt>
                        <dd>
                            @Model.StartDate.Value.ToString("dd MMM yyyy")
                            @if (Model.EndDate.HasValue && Model.EndDate.Value.Date != Model.StartDate.Value.Date)
                            {
                                <text> - @Model.EndDate.Value.ToString("dd MMM yyyy")</text>
                            }
                        </dd>
                    }
                    
                    @if (Model.Factor.HasValue)
                    {
                        <dt>@LocString[nameof(LocalizationKey.Factor)]</dt>
                        <dd>@Model.Factor.Value.ToString("F1")</dd>
                    }
                </dl>
            </div>
        </div>
        
        @if (!string.IsNullOrEmpty(Model.Notes))
        {
            <div class="row" style="margin-top: 10px;">
                <div class="col-md-12">
                    <dt>@LocString[nameof(LocalizationKey.Notes)]</dt>
                    <dd style="white-space: pre-wrap;">@Model.Notes</dd>
                </div>
            </div>
        }
        
        @if (Model.ExternalLinksList.Any())
        {
            <div class="row" style="margin-top: 10px;">
                <div class="col-md-12">
                    <dt>@LocString[nameof(LocalizationKey.ExternalLinks)]</dt>
                    <dd>
                        @foreach (var link in Model.ExternalLinksList)
                        {
                            <a href="@link.Trim()" target="_blank" rel="noopener noreferrer" style="margin-right: 10px;">@link.Trim()</a>
                        }
                    </dd>
                </div>
            </div>
        }
    </div>
</div>

@* Show StandingsPhoto as separate section if no rounds exist but photo exists *@
@{
    bool IsImageFile(string url) => !string.IsNullOrEmpty(url) && 
        !url.EndsWith(".pdf", StringComparison.OrdinalIgnoreCase) &&
        !url.EndsWith(".txt", StringComparison.OrdinalIgnoreCase) &&
        !url.EndsWith(".xls", StringComparison.OrdinalIgnoreCase) &&
        !url.EndsWith(".xlsx", StringComparison.OrdinalIgnoreCase);
    
    string GetFileIcon(string url) {
        if (string.IsNullOrEmpty(url)) return "";
        if (url.EndsWith(".pdf", StringComparison.OrdinalIgnoreCase)) return "üìÑ";
        if (url.EndsWith(".txt", StringComparison.OrdinalIgnoreCase)) return "üìù";
        if (url.EndsWith(".xls", StringComparison.OrdinalIgnoreCase) || url.EndsWith(".xlsx", StringComparison.OrdinalIgnoreCase)) return "üìä";
        return "";
    }
    
    string GetFileLabel(string url) {
        if (string.IsNullOrEmpty(url)) return "";
        if (url.EndsWith(".pdf", StringComparison.OrdinalIgnoreCase)) return "PDF";
        if (url.EndsWith(".txt", StringComparison.OrdinalIgnoreCase)) return "TXT";
        if (url.EndsWith(".xls", StringComparison.OrdinalIgnoreCase)) return "XLS";
        if (url.EndsWith(".xlsx", StringComparison.OrdinalIgnoreCase)) return "XLSX";
        return "";
    }
}
@if (Model.MaxRounds == 0 && !string.IsNullOrEmpty(Model.StandingsPhoto) && IsImageFile(Model.StandingsPhoto))
{
    <div style="margin-top: 20px;">
        <div style="margin-top: 10px;">
            <a href="@Model.StandingsPhoto" target="_blank">
                <img src="@Model.StandingsPhoto" alt="@LocString[nameof(LocalizationKey.Standings)]" style="max-width: 100%; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" />
            </a>
        </div>
    </div>
}

@if (Model.SupportsPersonalAward && Model.Players.Any())
{
    var hasAnyPromotion = Model.Players.Any(p => !string.IsNullOrEmpty(p.PromotionRanking));
    var showPromoColumn = hasAnyPromotion || Model.IsAdmin; // Always show for Admin
    var hasFemaleAward = Model.SupportsFemaleAward && Model.Players.Any(p => p.IsFemale);
    // Only show residence column for tournaments from 2023 onwards
    var showResidence = Model.StartDate.HasValue && Model.StartDate.Value >= new DateTimeOffset(2023, 1, 1, 0, 0, 0, TimeSpan.Zero);
    // Build player index lookup (PlayerId -> sequential index)
    var playerIndex = new Dictionary<string, int>();
    var idx = 1;
    foreach (var player in Model.Players)
    {
        playerIndex[player.PlayerId] = idx++;
    }
    
    <div style="margin-top: 20px;">
        <h4 style="display: inline-block;">@LocString[nameof(LocalizationKey.Standings)]</h4>
        @if (!string.IsNullOrEmpty(Model.StandingsPhoto))
        {
            var isImage = IsImageFile(Model.StandingsPhoto);
            <a href="@Model.StandingsPhoto" target="_blank" style="margin-left: 10px;">
                @if (!isImage)
                {
                    <span style="font-size: 1.2em; vertical-align: middle;" title="@GetFileLabel(Model.StandingsPhoto)">@GetFileIcon(Model.StandingsPhoto)</span>
                }
                else
                {
                    <img src="@Model.StandingsPhoto" alt="@LocString[nameof(LocalizationKey.Standings)]" style="max-height: 30px; vertical-align: middle; border-radius: 3px;" />
                }
            </a>
            @if (Model.IsAdmin)
            {
                <a href="@Url.Action("EditPhoto", new { tournamentId = Model.Id, photoType = "standings_photo" })" 
                   target="_blank" class="btn btn-xs btn-link" style="vertical-align: middle;">‚úèÔ∏è</a>
            }
        }
        else if (Model.IsAdmin)
        {
            <a href="@Url.Action("EditPhoto", new { tournamentId = Model.Id, photoType = "standings_photo" })" 
               target="_blank" class="btn btn-xs btn-default" style="margin-left: 10px; vertical-align: middle;" 
               title="@LocString[nameof(LocalizationKey.AddPhoto)]">+ üì∑</a>
        }
        <div style="overflow-x: auto;">
            <table class="table table-condensed table-bordered" style="background: white;">
                <thead>
                    <tr style="background-color: #f5f5f5;">
                        <th style="width: 30px; text-align: center;">#</th>
                        <th style="width: 40px; text-align: center;">@LocString[nameof(LocalizationKey.Pos)]</th>
                        <th style="white-space: nowrap;">@LocString[nameof(LocalizationKey.Player)]</th>
                        @if (Model.IsAdmin)
                        {
                            <th style="width: 40px; text-align: center;" title="@LocString[nameof(LocalizationKey.Photo)]">üì∑</th>
                        }
                        @if (showResidence)
                        {
                            <th style="width: 80px;">@LocString[nameof(LocalizationKey.Residence)]</th>
                        }
                        @for (var r = 1; r <= Model.MaxRounds; r++)
                        {
                            <th style="width: 60px; text-align: center;">R@(r)</th>
                        }
                        <th style="width: 40px; text-align: center;" title="@LocString[nameof(LocalizationKey.NumberOfWins)]">@LocString[nameof(LocalizationKey.NbW)]</th>
                        <th style="width: 50px; text-align: center;" title="@LocString[nameof(LocalizationKey.SOS)]">@LocString[nameof(LocalizationKey.SOS)]</th>
                        <th style="width: 60px; text-align: center;" title="@LocString[nameof(LocalizationKey.SOSOS)]">@LocString[nameof(LocalizationKey.SOSOS)]</th>
                        <th style="width: 55px; text-align: center;" title="@LocString[nameof(LocalizationKey.Before)]">@LocString[nameof(LocalizationKey.Before)]</th>
                        <th style="width: 55px; text-align: center;" title="@LocString[nameof(LocalizationKey.After)]">@LocString[nameof(LocalizationKey.After)]</th>
                        <th style="width: 45px; text-align: center;" title="@LocString[nameof(LocalizationKey.ShiftRating)]">+/-</th>
                        @if (hasFemaleAward)
                        {
                            <th style="width: 45px; text-align: center;" title="@LocString[nameof(LocalizationKey.FemaleAward)]">‚ôÄ</th>
                        }
                        @if (showPromoColumn)
                        {
                            <th style="width: 90px;">@LocString[nameof(LocalizationKey.Promo)]</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @{ var rowIdx = 0; }
                    @foreach (var p in Model.Players)
                    {
                        rowIdx++;
                        <tr>
                            <td style="text-align: center; font-weight: bold;">@rowIdx</td>
                            <td style="text-align: center;">
                                @if (p.IsCalculatedPosition)
                                {
                                    <span class="text-muted">(@p.DisplayPosition)</span>
                                }
                                else
                                {
                                    @p.DisplayPosition
                                }
                            </td>
                            <td style="white-space: nowrap;">
                                <a asp-controller="Leagues" asp-action="Player" asp-route-id="@Model.LeagueId" asp-route-playerId="@p.PlayerId">@p.PlayerName</a>@if (!string.IsNullOrEmpty(p.PlayerRanking)){<text> </text><span style="color: rgb(255, 99, 132); font-weight: bold;">@p.PlayerRanking</span>}
                            </td>
                            @if (Model.IsAdmin)
                            {
                                <td style="text-align: center;">
                                    @if (!string.IsNullOrEmpty(p.Photo))
                                    {
                                        <a href="@p.Photo" target="_blank" title="@LocString[nameof(LocalizationKey.Photo)]">
                                            <img src="@p.Photo" alt="" style="max-width: 30px; max-height: 30px; border-radius: 3px; cursor: pointer;" />
                                        </a>
                                        <a href="@Url.Action("EditPhoto", new { tournamentId = Model.Id, playerId = p.PlayerId, photoType = "photo" })" 
                                           target="_blank" class="btn btn-xs btn-link" style="padding: 0; margin-left: 2px;">‚úèÔ∏è</a>
                                    }
                                    else
                                    {
                                        <a href="@Url.Action("EditPhoto", new { tournamentId = Model.Id, playerId = p.PlayerId, photoType = "photo" })" 
                                           target="_blank" class="btn btn-xs btn-default" title="@LocString[nameof(LocalizationKey.AddPhoto)]">+</a>
                                    }
                                </td>
                            }
                            @if (showResidence)
                            {
                                <td style="font-size: 0.9em;">@p.Residence</td>
                            }
                            @for (var r = 1; r <= Model.MaxRounds; r++)
                            {
                                <td style="text-align: center;">
                                    @if (p.RoundResults.TryGetValue(r, out var result))
                                    {
                                        var color = result.Won == true ? "green" : (result.Won == false ? "red" : "gray");
                                        var symbol = result.Won == true ? "+" : (result.Won == false ? "-" : "=");
                                        @if (string.IsNullOrEmpty(result.OpponentId))
                                        {
                                            // Bye round - no opponent
                                            <span title="@result.OpponentName (@result.Score)" style="font-style: italic; color: #999;">0</span>
                                            <span style="color: @color; font-weight: bold;">@symbol</span>
                                        }
                                        else
                                        {
                                            var oppIdx = playerIndex.TryGetValue(result.OpponentId, out var oi) ? oi : 0;
                                            <span title="@result.OpponentName (@result.Score)">@oppIdx</span>
                                            <span style="color: @color; font-weight: bold;">@symbol</span>
                                        }
                                    }
                                    else if (Model.IsAdmin)
                                    {
                                        // Use first match date for this round, or tournament start date as fallback
                                        var roundDate = Model.RoundDates.TryGetValue(r, out var rd) 
                                            ? rd 
                                            : (Model.StartDate ?? DateTimeOffset.UtcNow);
                                        <a asp-controller="Matches" asp-action="Create" 
                                           asp-route-leagueId="@Model.LeagueId"
                                           asp-route-tournamentId="@Model.Id"
                                           asp-route-round="@r"
                                           asp-route-lastMatchDateTime="@roundDate.ToString("o")"
                                           asp-route-factor="0"
                                           asp-route-firstPlayerId="@p.PlayerId"
                                           asp-route-secondPlayerId="BYE"
                                           target="_blank"
                                           class="btn btn-xs btn-default" title="Add match for @p.PlayerName in Round @r">+</a>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                            }
                            <td style="text-align: center; font-weight: bold;">@(p.Wins % 1 == 0 ? ((int)p.Wins).ToString() : p.Wins.ToString("0.#"))</td>
                            <td style="text-align: center;">@(p.SOS % 1 == 0 ? ((int)p.SOS).ToString() : p.SOS.ToString("0.#"))</td>
                            <td style="text-align: center;">@(p.SOSOS % 1 == 0 ? ((int)p.SOSOS).ToString() : p.SOSOS.ToString("0.#"))</td>
                            <td style="text-align: center; font-size: 0.9em;">
                                @if (p.ShowRatingBefore && p.RatingBefore.HasValue)
                                {
                                    @p.RatingBefore.Value.ToString("F1")
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td style="text-align: center; font-size: 0.9em;">
                                @if (p.ShowRatingAfter && p.RatingAfter.HasValue)
                                {
                                    @p.RatingAfter.Value.ToString("F1")
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td style="text-align: center; font-size: 0.9em;">
                                @if (p.RatingChange.HasValue)
                                {
                                    var change = p.RatingChange.Value;
                                    var color = change > 0 ? "green" : (change < 0 ? "red" : "gray");
                                    var prefix = change > 0 ? "+" : "";
                                    <span style="color: @color; font-weight: bold;">@prefix@change.ToString("F1")</span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            @if (hasFemaleAward)
                            {
                                <td style="text-align: center;">
                                    @if (p.IsFemale && p.FemalePosition.HasValue)
                                    {
                                        @if (p.FemalePosition == 1)
                                        {
                                            <span style="color: #d63384;" title="@LocString[nameof(LocalizationKey.FemaleChampion)]">üëë</span>
                                        }
                                        else
                                        {
                                            <span style="color: #d63384; font-weight: bold;">@p.FemalePosition</span>
                                        }
                                    }
                                    else if (p.IsFemale)
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                            }
                            @if (showPromoColumn)
                            {
                                <td>
                                    @if (!string.IsNullOrEmpty(p.PromotionRanking))
                                    {
                                        <span class="label label-success">@p.PromotionRanking</span>
                                        @if (p.PromotionBonus.HasValue)
                                        {
                                            <span style="color: #5cb85c; font-size: 0.85em; margin-left: 2px;">+@p.PromotionBonus.Value.ToString("F1")</span>
                                        }
                                    }
                                    else if (Model.IsAdmin)
                                    {
                                        <a href="@Url.Action("EditRankingHistory", "Leagues", new { id = Model.LeagueId, playerId = p.PlayerId, tournamentId = Model.Id, organization = Model.Organizer, rankingDate = Model.EndDate?.ToString("yyyy-MM-dd") })" 
                                           target="_blank" class="btn btn-xs btn-default" title="@LocString[nameof(LocalizationKey.AddPromotion)]">+</a>
                                    }
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

@if (Model.SupportsTeamAward && Model.TeamStandings.Any())
{
    <div style="margin-top: 20px;">
        <h4 style="display: inline-block;">@LocString[nameof(LocalizationKey.TeamStandings)]</h4>
        @if (!Model.SupportsPersonalAward && !string.IsNullOrEmpty(Model.StandingsPhoto))
        {
            var isImageTeam = IsImageFile(Model.StandingsPhoto);
            <a href="@Model.StandingsPhoto" target="_blank" style="margin-left: 10px;">
                @if (!isImageTeam)
                {
                    <span style="font-size: 1.2em; vertical-align: middle;" title="@GetFileLabel(Model.StandingsPhoto)">@GetFileIcon(Model.StandingsPhoto)</span>
                }
                else
                {
                    <img src="@Model.StandingsPhoto" alt="@LocString[nameof(LocalizationKey.Standings)]" style="max-height: 30px; vertical-align: middle; border-radius: 3px;" />
                }
            </a>
            @if (Model.IsAdmin)
            {
                <a href="@Url.Action("EditPhoto", new { tournamentId = Model.Id, photoType = "standings_photo" })" 
                   target="_blank" class="btn btn-xs btn-link" style="vertical-align: middle;">‚úèÔ∏è</a>
            }
        }
        else if (!Model.SupportsPersonalAward && Model.IsAdmin)
        {
            <a href="@Url.Action("EditPhoto", new { tournamentId = Model.Id, photoType = "standings_photo" })" 
               target="_blank" class="btn btn-xs btn-default" style="margin-left: 10px; vertical-align: middle;" 
               title="@LocString[nameof(LocalizationKey.AddPhoto)]">+ üì∑</a>
        }
        <div style="overflow-x: auto;">
            <table class="table table-condensed table-bordered" style="background: white;">
                <thead>
                    <tr style="background-color: #f5f5f5;">
                        <th style="width: 30px; text-align: center;">#</th>
                        <th style="width: 40px; text-align: center;">@LocString[nameof(LocalizationKey.Pos)]</th>
                        @if (Model.SupportsPersonalAward)
                        {
                            <th style="white-space: nowrap;">@LocString[nameof(LocalizationKey.Team)]</th>
                            <th style="width: 60px; text-align: center;" title="@LocString[nameof(LocalizationKey.SumOfPlayerPositions)]">@LocString[nameof(LocalizationKey.SumPos)]</th>
                            <th style="width: 60px; text-align: center;">@LocString[nameof(LocalizationKey.PlayerPos)]</th>
                            <th>@LocString[nameof(LocalizationKey.Player)]</th>
                        }
                        else
                        {
                            <th style="width: 30px; text-align: center;" title="@LocString[nameof(LocalizationKey.Player)] Index">#P</th>
                            <th style="white-space: nowrap;">@LocString[nameof(LocalizationKey.Team)]</th>
                        }
                        @if (Model.IsAdmin)
                        {
                            <th style="width: 40px; text-align: center;" title="@LocString[nameof(LocalizationKey.Photo)]">üì∑</th>
                        }
                        @if (!Model.SupportsPersonalAward)
                        {
                            @for (var r = 1; r <= Model.MaxRounds; r++)
                            {
                                <th style="width: 100px; text-align: center;">R@(r)</th>
                            }
                        }
                        @if (!Model.SupportsPersonalAward)
                        {
                            <th style="width: 40px; text-align: center;" title="@LocString[nameof(LocalizationKey.NumberOfWins)]">@LocString[nameof(LocalizationKey.NbW)]</th>
                            <th style="width: 50px; text-align: center;" title="@LocString[nameof(LocalizationKey.TeamSOS)]">@LocString[nameof(LocalizationKey.SOS)]</th>
                            <th style="width: 60px; text-align: center;" title="@LocString[nameof(LocalizationKey.TeamSOSOS)]">@LocString[nameof(LocalizationKey.SOSOS)]</th>
                            <th style="width: 50px; text-align: center;" title="@LocString[nameof(LocalizationKey.TotalWinsOfPlayers)]">@LocString[nameof(LocalizationKey.Wins)]</th>
                        }
                        @if (!Model.SupportsPersonalAward)
                        {
                            <th style="width: 55px; text-align: center;" title="@LocString[nameof(LocalizationKey.Before)]">@LocString[nameof(LocalizationKey.Before)]</th>
                            <th style="width: 55px; text-align: center;" title="@LocString[nameof(LocalizationKey.After)]">@LocString[nameof(LocalizationKey.After)]</th>
                            <th style="width: 45px; text-align: center;" title="@LocString[nameof(LocalizationKey.ShiftRating)]">+/-</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var team in Model.TeamStandings)
                    {
                        var isFirstRow = true;
                        var allPlayers = team.Players.ToList();
                        var playerCount = allPlayers.Count;
                        @foreach (var player in allPlayers)
                        {
                            <tr>
                                @if (isFirstRow)
                                {
                                    <td rowspan="@playerCount" style="text-align: center; font-weight: bold; vertical-align: middle;">@team.Index</td>
                                    <td rowspan="@playerCount" style="text-align: center; vertical-align: middle;">@(team.Position?.ToString() ?? "-")</td>
                                    @if (Model.SupportsPersonalAward)
                                    {
                                        // Count players marked as counting for team award (top 3)
                                        var countingPlayers = team.Players.Count(p => p.CountsForTeamAward);
                                        // Display sum without penalty (subtract 10000 for 2-player teams)
                                        var displaySum = countingPlayers == 2 ? team.SumOfPlayerPositions - 10000 : team.SumOfPlayerPositions;
                                        
                                        <td rowspan="@playerCount" style="white-space: nowrap; vertical-align: middle;" class="team-name">@team.TeamName</td>
                                        <td rowspan="@playerCount" style="text-align: center; font-weight: bold; vertical-align: middle;">@displaySum</td>
                                    }
                                }
                                @if (Model.SupportsPersonalAward)
                                {
                                    <td style="text-align: center;">
                                        @if (player.CountsForTeamAward)
                                        {
                                            <strong>@(player.PersonalPosition?.ToString() ?? "-")</strong>
                                        }
                                        else
                                        {
                                            <span style="color: #888;">@(player.PersonalPosition?.ToString() ?? "-")</span>
                                        }
                                    </td>
                                    <td style="white-space: nowrap;">
                                        <a asp-controller="Leagues" asp-action="Player" asp-route-id="@Model.LeagueId" asp-route-playerId="@player.PlayerId">@player.PlayerName</a>
                                    </td>
                                }
                                else
                                {
                                    @* Player index column (team mode) *@
                                    <td style="text-align: center; font-size: 0.9em; color: #888;">
                                        @if (isFirstRow)
                                        {
                                            <div style="border-bottom: 1px solid #ddd; padding-bottom: 2px; margin-bottom: 2px;">&nbsp;</div>
                                        }
                                        @player.PlayerIndex
                                    </td>
                                    @* Merged Team / Player column *@
                                    <td style="white-space: nowrap;">
                                        @if (isFirstRow)
                                        {
                                            <strong class="team-name">@team.TeamName</strong>
                                            <hr style="margin: 4px 0; border-top: 1px solid #ddd;" />
                                        }
                                        <span style="padding-left: 15px;">
                                            <a asp-controller="Leagues" asp-action="Player" asp-route-id="@Model.LeagueId" asp-route-playerId="@player.PlayerId">@player.PlayerName</a>
                                        </span>
                                    </td>
                                }
                                @if (Model.IsAdmin && isFirstRow)
                                {
                                    var firstPlayer = allPlayers.First();
                                    var teamPhoto = firstPlayer.TeamPhoto;
                                    <td rowspan="@playerCount" style="text-align: center; vertical-align: middle;">
                                        @if (!string.IsNullOrEmpty(teamPhoto))
                                        {
                                            <a href="@teamPhoto" target="_blank"><img src="@teamPhoto" alt="" style="max-width: 30px; max-height: 30px; border-radius: 2px;" /></a>
                                            <a href="@Url.Action("EditPhoto", new { tournamentId = Model.Id, playerId = firstPlayer.PlayerId, photoType = "teamphoto" })" 
                                               target="_blank" class="btn btn-xs btn-link" style="padding: 0;">‚úèÔ∏è</a>
                                        }
                                        else
                                        {
                                            <a href="@Url.Action("EditPhoto", new { tournamentId = Model.Id, playerId = firstPlayer.PlayerId, photoType = "teamphoto" })" 
                                               target="_blank" class="btn btn-xs btn-default" title="@LocString[nameof(LocalizationKey.AddPhoto)]">+</a>
                                        }
                                    </td>
                                }
                                @if (!Model.SupportsPersonalAward)
                                {
                                    @for (var r = 1; r <= Model.MaxRounds; r++)
                                    {
                                        <td style="text-align: center; font-size: 0.85em;">
                                            @if (isFirstRow && team.TeamRoundResults.TryGetValue(r, out var teamResult))
                                            {
                                                var teamColor = teamResult.Won == true ? "green" : (teamResult.Won == false ? "red" : "gray");
                                                var teamSymbol = teamResult.Won == true ? "+" : (teamResult.Won == false ? "-" : "=");
                                                var totalRoundPoints = teamResult.RoundPoints + teamResult.RoundMainPlayerBonus;
                                                var pointsDisplay = totalRoundPoints % 1 == 0 ? ((int)totalRoundPoints).ToString() : totalRoundPoints.ToString("0.#");
                                                <div style="font-weight: bold; border-bottom: 1px solid #ddd; padding-bottom: 2px; margin-bottom: 2px;">
                                                    <span title="vs @teamResult.OpponentTeamName">@teamResult.OpponentTeamIndex</span>
                                                    <span style="color: @teamColor;">@teamSymbol</span>
                                                    <span style="font-size: 0.8em; color: #666;">(@pointsDisplay)</span>
                                                </div>
                                            }
                                            @if (player.RoundResults.TryGetValue(r, out var result))
                                            {
                                                // Add separator for first player when there's a result but no team result
                                                if (isFirstRow && !team.TeamRoundResults.ContainsKey(r))
                                                {
                                                    <div style="border-bottom: 1px solid #ddd; padding-bottom: 2px; margin-bottom: 2px;">&nbsp;</div>
                                                }
                                                var color = result.Won == true ? "green" : (result.Won == false ? "red" : "gray");
                                                var symbol = result.Won == true ? "+" : (result.Won == false ? "-" : "=");
                                                var mainPlayerStyle = result.IsMainPlayer ? "background-color: #fffacd; padding: 1px 3px; border-radius: 3px;" : "";
                                                var mainPlayerTitle = result.IsMainPlayer ? " ‚òÖ Main Player (1.5 pts)" : "";
                                                <span style="@mainPlayerStyle" title="@result.OpponentName (@result.Score)@mainPlayerTitle">
                                                    @if (result.IsMainPlayer) { <text>‚òÖ</text> }
                                                    @(result.OpponentIndex > 0 ? result.OpponentIndex.ToString() : result.OpponentName)
                                                </span>
                                                <span style="color: @color; font-weight: bold;">@symbol</span>
                                            }
                                            else if (Model.IsAdmin)
                                            {
                                                // Add match button for team standings when no result exists
                                                // Add separator for first player to align with player name row
                                                if (isFirstRow && !team.TeamRoundResults.ContainsKey(r))
                                                {
                                                    <div style="border-bottom: 1px solid #ddd; padding-bottom: 2px; margin-bottom: 2px;">&nbsp;</div>
                                                }
                                                var roundDate = Model.RoundDates.TryGetValue(r, out var rd) 
                                                    ? rd 
                                                    : (Model.StartDate ?? DateTimeOffset.UtcNow);
                                                <a asp-controller="Matches" asp-action="Create" 
                                                   asp-route-leagueId="@Model.LeagueId"
                                                   asp-route-tournamentId="@Model.Id"
                                                   asp-route-round="@r"
                                                   asp-route-lastMatchDateTime="@roundDate.ToString("o")"
                                                   asp-route-factor="0"
                                                   asp-route-firstPlayerId="@player.PlayerId"
                                                   asp-route-secondPlayerId="BYE"
                                                   target="_blank"
                                                   class="btn btn-xs btn-default" title="Add match for @player.PlayerName in Round @r">+</a>
                                            }
                                            else
                                            {
                                                // Add separator for first player to align with player name row
                                                if (isFirstRow && !team.TeamRoundResults.ContainsKey(r))
                                                {
                                                    <div style="border-bottom: 1px solid #ddd; padding-bottom: 2px; margin-bottom: 2px;">&nbsp;</div>
                                                }
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                    }
                                }
                                @if (isFirstRow && !Model.SupportsPersonalAward)
                                {
                                    <td rowspan="@playerCount" style="text-align: center; font-weight: bold; vertical-align: middle;">@(team.TeamWins % 1 == 0 ? ((int)team.TeamWins).ToString() : team.TeamWins.ToString("0.#"))</td>
                                    <td rowspan="@playerCount" style="text-align: center; vertical-align: middle;">@(team.TeamSOS % 1 == 0 ? ((int)team.TeamSOS).ToString() : team.TeamSOS.ToString("0.#"))</td>
                                    <td rowspan="@playerCount" style="text-align: center; vertical-align: middle;">@(team.TeamSOSOS % 1 == 0 ? ((int)team.TeamSOSOS).ToString() : team.TeamSOSOS.ToString("0.#"))</td>
                                    <td rowspan="@playerCount" style="text-align: center; font-weight: bold; vertical-align: middle;">@(team.TotalPlayerWins % 1 == 0 ? ((int)team.TotalPlayerWins).ToString() : team.TotalPlayerWins.ToString("0.#"))</td>
                                }
                                @if (!Model.SupportsPersonalAward)
                                {
                                    <td style="text-align: center; font-size: 0.85em;">
                                        @if (isFirstRow)
                                        {
                                            <div style="border-bottom: 1px solid #ddd; padding-bottom: 2px; margin-bottom: 2px;">&nbsp;</div>
                                        }
                                        @if (player.ShowRatingBefore && player.RatingBefore.HasValue)
                                        {
                                            @player.RatingBefore.Value.ToString("F1")
                                        }
                                        else
                                        {
                                            <span>-</span>
                                        }
                                    </td>
                                    <td style="text-align: center; font-size: 0.85em;">
                                        @if (isFirstRow)
                                        {
                                            <div style="border-bottom: 1px solid #ddd; padding-bottom: 2px; margin-bottom: 2px;">&nbsp;</div>
                                        }
                                        @if (player.ShowRatingAfter && player.RatingAfter.HasValue)
                                        {
                                            @player.RatingAfter.Value.ToString("F1")
                                        }
                                        else
                                        {
                                            <span>-</span>
                                        }
                                    </td>
                                    <td style="text-align: center; font-size: 0.85em;">
                                        @if (isFirstRow)
                                        {
                                            <div style="border-bottom: 1px solid #ddd; padding-bottom: 2px; margin-bottom: 2px;">&nbsp;</div>
                                        }
                                        @if (player.RatingDelta.HasValue)
                                        {
                                            var deltaColor = player.RatingDelta.Value > 0 ? "green" : (player.RatingDelta.Value < 0 ? "red" : "gray");
                                            var deltaPrefix = player.RatingDelta.Value > 0 ? "+" : "";
                                            <span style="color: @deltaColor;">@deltaPrefix@player.RatingDelta.Value.ToString("F1")</span>
                                        }
                                        else
                                        {
                                            <span>-</span>
                                        }
                                    </td>
                                }
                                @{isFirstRow = false;}
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
}

@if (Model.Matches.Any())
{
    // Check if any matches have photos/game records (for non-admin column visibility)
    var hasAnyMatchPhoto = Model.Matches.Any(m => !string.IsNullOrEmpty(m.MatchPhoto));
    var hasAnyResultPhoto = Model.Matches.Any(m => !string.IsNullOrEmpty(m.MatchResultPhoto));
    var hasAnyGameRecord = Model.Matches.Any(m => !string.IsNullOrEmpty(m.GameRecord));
    var showMatchPhotoCol = Model.IsAdmin || hasAnyMatchPhoto;
    var showResultPhotoCol = Model.IsAdmin || hasAnyResultPhoto;
    var showGameRecordCol = Model.IsAdmin || hasAnyGameRecord;
    
    <div style="margin-top: 20px;">
        <h4>@LocString[nameof(LocalizationKey.Matches)] (@Model.Matches.Count)</h4>
        @if (Model.IsAdmin)
        {
            <p class="text-muted" style="font-size: 0.85em; margin-bottom: 10px;">
                <em>@LocString[nameof(LocalizationKey.MatchesNotRatedNote)]</em>
            </p>
        }
        <table class="table table-striped table-condensed">
            <thead>
                <tr>
                    <th>@LocString[nameof(LocalizationKey.Match)]</th>
                    <th>@LocString[nameof(LocalizationKey.Score)]</th>
                    <th style="text-align: center;">@LocString[nameof(LocalizationKey.Round)]</th>
                    <th>@LocString[nameof(LocalizationKey.Date)]</th>
                    @if (Model.IsAdmin)
                    {
                        <th style="text-align: center;">@LocString[nameof(LocalizationKey.Factor)]</th>
                        <th style="text-align: center;">@LocString[nameof(LocalizationKey.ShiftRating)]</th>
                    }
                    @if (showMatchPhotoCol)
                    {
                        <th style="text-align: center; width: 40px;" title="@LocString[nameof(LocalizationKey.MatchPhoto)]">üì∑</th>
                    }
                    @if (showResultPhotoCol)
                    {
                        <th style="text-align: center; width: 40px;" title="@LocString[nameof(LocalizationKey.ResultPhoto)]">üì∑</th>
                    }
                    @if (showGameRecordCol)
                    {
                        <th style="text-align: center; width: 40px;" title="@LocString[nameof(LocalizationKey.GameRecordLink)]">üìã</th>
                    }
                    @if (Model.IsAdmin)
                    {
                        <th></th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var m in Model.Matches)
                {
                    <tr>
                        <td style="white-space: nowrap;">
                            @if (!string.IsNullOrEmpty(m.FirstPlayerId))
                            {
                                <a asp-controller="Leagues" asp-action="Player" asp-route-id="@Model.LeagueId" asp-route-playerId="@m.FirstPlayerId">@m.FirstPlayerName</a>
                                @if (!string.IsNullOrEmpty(m.FirstPlayerRanking)){
                                <text> </text>
                                    <span style="color: rgb(255, 99, 132); font-weight: bold;">@m.FirstPlayerRanking</span>
                                }
                                @if (Model.IsAdmin && !string.IsNullOrEmpty(m.FirstPlayerRatingBefore))
                                {
                                    <span style="color: #666; font-size: 0.85em;">(@m.FirstPlayerRatingBefore)</span>
                                }
                            }
                            else
                            {
                                <span class="text-muted" style="font-style: italic;">BYE</span>
                            }
                            <span style="margin: 0 5px;">vs</span>
                            @if (!string.IsNullOrEmpty(m.SecondPlayerId))
                            {
                                <a asp-controller="Leagues" asp-action="Player" asp-route-id="@Model.LeagueId" asp-route-playerId="@m.SecondPlayerId">@m.SecondPlayerName</a>
                                @if (!string.IsNullOrEmpty(m.SecondPlayerRanking))
                                {
                                    <text> </text>
                                    <span style="color: rgb(255, 99, 132); font-weight: bold;">@m.SecondPlayerRanking</span>
                                }
                                @if (Model.IsAdmin && !string.IsNullOrEmpty(m.SecondPlayerRatingBefore))
                                {
                                    <span style="color: #666; font-size: 0.85em;">(@m.SecondPlayerRatingBefore)</span>
                                }
                            }
                            else
                            {
                                <span class="text-muted" style="font-style: italic;">BYE</span>
                            }
                        </td>
                        <td>@m.GetScore()</td>
                        <td style="text-align: center;">@(m.Round.HasValue ? $"R{m.Round}" : "-")</td>
                        <td>@m.Date.ToString("dd/MM/yyyy")</td>
                        @if (Model.IsAdmin)
                        {
                            <td style="text-align: center;">
                                <input type="number" step="1" min="0" max="2" 
                                       class="factor-input" 
                                       data-match-id="@m.Id"
                                       value="@(m.Factor ?? 1)" 
                                       style="width: 50px; text-align: center; padding: 2px 4px; border: 1px solid #ddd; border-radius: 3px;" />
                            </td>
                            <td style="text-align: center;">
                                @(string.IsNullOrEmpty(m.ShiftRating) ? "-" : m.ShiftRating)
                            </td>
                        }
                        @if (showMatchPhotoCol)
                        {
                        <td style="text-align: center;">
                            @if (!string.IsNullOrEmpty(m.MatchPhoto))
                            {
                                <a href="@m.MatchPhoto" target="_blank"><img src="@m.MatchPhoto" alt="" style="max-width: 25px; max-height: 25px; border-radius: 2px;" /></a>
                                @if (Model.IsAdmin)
                                {
                                    <a href="@Url.Action("EditPhoto", new { tournamentId = Model.Id, matchId = m.Id, photoType = "matchphoto" })" 
                                       target="_blank" class="btn btn-xs btn-link" style="padding: 0;">‚úèÔ∏è</a>
                                }
                            }
                            else if (Model.IsAdmin)
                            {
                                <a href="@Url.Action("EditPhoto", new { tournamentId = Model.Id, matchId = m.Id, photoType = "matchphoto" })" 
                                   target="_blank" class="btn btn-xs btn-default" title="@LocString[nameof(LocalizationKey.AddPhoto)]">+</a>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        }
                        @if (showResultPhotoCol)
                        {
                        <td style="text-align: center;">
                            @if (!string.IsNullOrEmpty(m.MatchResultPhoto))
                            {
                                <a href="@m.MatchResultPhoto" target="_blank"><img src="@m.MatchResultPhoto" alt="" style="max-width: 25px; max-height: 25px; border-radius: 2px;" /></a>
                                @if (Model.IsAdmin)
                                {
                                    <a href="@Url.Action("EditPhoto", new { tournamentId = Model.Id, matchId = m.Id, photoType = "matchresultphoto" })" 
                                       target="_blank" class="btn btn-xs btn-link" style="padding: 0;">‚úèÔ∏è</a>
                                }
                            }
                            else if (Model.IsAdmin)
                            {
                                <a href="@Url.Action("EditPhoto", new { tournamentId = Model.Id, matchId = m.Id, photoType = "matchresultphoto" })" 
                                   target="_blank" class="btn btn-xs btn-default" title="@LocString[nameof(LocalizationKey.AddPhoto)]">+</a>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        }
                        @if (showGameRecordCol)
                        {
                        <td style="text-align: center;">
                            @if (!string.IsNullOrEmpty(m.GameRecord))
                            {
                                <a href="@m.GameRecord" target="_blank" title="@LocString[nameof(LocalizationKey.GameRecordLink)]">üîó</a>
                                @if (Model.IsAdmin)
                                {
                                    <a href="@Url.Action("EditPhoto", new { tournamentId = Model.Id, matchId = m.Id, photoType = "gamerecord" })" 
                                       target="_blank" class="btn btn-xs btn-link" style="padding: 0;">‚úèÔ∏è</a>
                                }
                            }
                            else if (Model.IsAdmin)
                            {
                                <a href="@Url.Action("EditPhoto", new { tournamentId = Model.Id, matchId = m.Id, photoType = "gamerecord" })" 
                                   target="_blank" class="btn btn-xs btn-default" title="@LocString[nameof(LocalizationKey.AddGameRecord)]">+</a>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        }
                        @if (Model.IsAdmin)
                        {
                            <td>
                                <a asp-controller="Matches" asp-action="Edit" asp-route-id="@m.Id" target="_blank" title="@LocString[nameof(LocalizationKey.Edit)]">‚úèÔ∏è</a>
                                <a asp-controller="Matches" asp-action="Delete" asp-route-id="@m.Id" target="_blank" title="@LocString[nameof(LocalizationKey.Delete)]">üóëÔ∏è</a>
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@section Scripts {
    <script>
        // Inline factor editing
        document.querySelectorAll('.factor-input').forEach(function(input) {
            var originalValue = input.value;
            
            input.addEventListener('change', function() {
                var matchId = this.getAttribute('data-match-id');
                var newValue = this.value;
                var inputEl = this;
                
                // Visual feedback - show loading
                inputEl.style.borderColor = '#ffc107';
                inputEl.disabled = true;
                
                fetch('@Url.Action("UpdateFactor", "Matches")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'id=' + encodeURIComponent(matchId) + '&factor=' + encodeURIComponent(newValue)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        inputEl.style.borderColor = '#28a745';
                        originalValue = newValue;
                        setTimeout(function() {
                            inputEl.style.borderColor = '#ddd';
                        }, 1500);
                    } else {
                        inputEl.style.borderColor = '#dc3545';
                        inputEl.value = originalValue;
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    inputEl.style.borderColor = '#dc3545';
                    inputEl.value = originalValue;
                    alert('Error updating factor');
                })
                .finally(function() {
                    inputEl.disabled = false;
                });
            });
            
            // Reset border on focus
            input.addEventListener('focus', function() {
                this.style.borderColor = '#667eea';
            });
            
            input.addEventListener('blur', function() {
                if (this.style.borderColor === 'rgb(102, 126, 234)') {
                    this.style.borderColor = '#ddd';
                }
            });
        });
    </script>
}

