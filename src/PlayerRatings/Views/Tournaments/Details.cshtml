@using PlayerRatings.Localization
@model PlayerRatings.ViewModels.Tournament.TournamentDetailsViewModel

@{
    ViewData["Title"] = Model.FullName;
}

<h2>@ViewData["Title"]</h2>
<hr />

<div class="form-group">
    <a asp-action="Index" asp-route-leagueId="@Model.LeagueId" class="btn btn-default">
        ‚Üê Back to Tournaments
    </a>
    @if (Model.IsAdmin)
    {
        <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-primary">Edit</a>
        <a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-danger">Delete</a>
    }
</div>

<div class="panel panel-default" style="margin-top: 20px;">
    <div class="panel-body">
        <div class="row">
            <div class="col-md-6">
                <dl>
                    <dt>Tournament Name</dt>
                    <dd>@Model.Name</dd>
                    
                    @if (!string.IsNullOrEmpty(Model.Ordinal))
                    {
                        <dt>Ordinal</dt>
                        <dd>@Model.Ordinal</dd>
                    }
                    
                    @if (!string.IsNullOrEmpty(Model.Group))
                    {
                        <dt>Group</dt>
                        <dd>@Model.Group</dd>
                    }
                    
                    @if (!string.IsNullOrEmpty(Model.TournamentType))
                    {
                        <dt>Type</dt>
                        <dd>@Model.TournamentType</dd>
                    }
                </dl>
            </div>
            <div class="col-md-6">
                <dl>
                    @if (!string.IsNullOrEmpty(Model.Organizer))
                    {
                        <dt>Organizer</dt>
                        <dd>@Model.Organizer</dd>
                    }
                    
                    @if (!string.IsNullOrEmpty(Model.Location))
                    {
                        <dt>Location</dt>
                        <dd>@Model.Location</dd>
                    }
                    
                    @if (Model.StartDate.HasValue)
                    {
                        <dt>Dates</dt>
                        <dd>
                            @Model.StartDate.Value.ToString("dd MMM yyyy")
                            @if (Model.EndDate.HasValue && Model.EndDate.Value.Date != Model.StartDate.Value.Date)
                            {
                                <text> - @Model.EndDate.Value.ToString("dd MMM yyyy")</text>
                            }
                        </dd>
                    }
                    
                    @if (Model.Factor.HasValue)
                    {
                        <dt>Factor</dt>
                        <dd>@Model.Factor.Value.ToString("F1")</dd>
                    }
                </dl>
            </div>
        </div>
    </div>
</div>

@if (Model.Players.Any() && Model.MaxRounds > 0)
{
    var hasAnyPromotion = Model.Players.Any(p => !string.IsNullOrEmpty(p.PromotionRanking));
    // Build player index lookup (PlayerId -> sequential index)
    var playerIndex = new Dictionary<string, int>();
    var idx = 1;
    foreach (var player in Model.Players)
    {
        playerIndex[player.PlayerId] = idx++;
    }
    
    <div style="margin-top: 20px;">
        <h4>Standings</h4>
        <div style="overflow-x: auto;">
            <table class="table table-condensed table-bordered" style="background: white;">
                <thead>
                    <tr style="background-color: #f5f5f5;">
                        <th style="width: 30px; text-align: center;">#</th>
                        <th style="width: 40px; text-align: center;">Pos</th>
                        <th style="white-space: nowrap;">Player</th>
                        <th style="width: 80px;">Residence</th>
                        @for (var r = 1; r <= Model.MaxRounds; r++)
                        {
                            <th style="width: 60px; text-align: center;">R@(r)</th>
                        }
                        <th style="width: 40px; text-align: center;" title="Number of Wins">NbW</th>
                        <th style="width: 50px; text-align: center;" title="Sum of Opponents' Scores">SOS</th>
                        <th style="width: 60px; text-align: center;" title="Sum of Opponents' SOS">SOSOS</th>
                        <th style="width: 55px; text-align: center;" title="Rating Before Tournament">Before</th>
                        <th style="width: 55px; text-align: center;" title="Rating After Tournament">After</th>
                        <th style="width: 45px; text-align: center;" title="Rating Change">+/-</th>
                        @if (hasAnyPromotion)
                        {
                            <th style="width: 70px;">Promotion</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @{ var rowIdx = 0; }
                    @foreach (var p in Model.Players)
                    {
                        rowIdx++;
                        <tr>
                            <td style="text-align: center; font-weight: bold;">@rowIdx</td>
                            <td style="text-align: center;">
                                @if (p.IsCalculatedPosition)
                                {
                                    <span class="text-muted">(@p.DisplayPosition)</span>
                                }
                                else
                                {
                                    @p.DisplayPosition
                                }
                            </td>
                            <td style="white-space: nowrap;">
                                <a asp-controller="Leagues" asp-action="Player" asp-route-id="@Model.LeagueId" asp-route-playerId="@p.PlayerId">@p.PlayerName</a>@if (!string.IsNullOrEmpty(p.PlayerRanking)){<text> </text><span style="color: rgb(255, 99, 132); font-weight: bold;">@p.PlayerRanking</span>}
                            </td>
                            <td style="font-size: 0.9em;">@p.Residence</td>
                            @for (var r = 1; r <= Model.MaxRounds; r++)
                            {
                                <td style="text-align: center;">
                                    @if (p.RoundResults.TryGetValue(r, out var result))
                                    {
                                        var color = result.Won == true ? "green" : (result.Won == false ? "red" : "gray");
                                        var symbol = result.Won == true ? "+" : (result.Won == false ? "-" : "=");
                                        var oppIdx = playerIndex.TryGetValue(result.OpponentId, out var oi) ? oi : 0;
                                        <span title="@result.OpponentName (@result.Score)">@oppIdx</span>
                                        <span style="color: @color; font-weight: bold;">@symbol</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                            }
                            <td style="text-align: center; font-weight: bold;">@p.Wins</td>
                            <td style="text-align: center;">@p.SOS</td>
                            <td style="text-align: center;">@p.SOSOS</td>
                            <td style="text-align: center; font-size: 0.9em;">
                                @if (p.ShowRatingBefore && p.RatingBefore.HasValue)
                                {
                                    @p.RatingBefore.Value.ToString("F1")
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td style="text-align: center; font-size: 0.9em;">
                                @if (p.ShowRatingAfter && p.RatingAfter.HasValue)
                                {
                                    @p.RatingAfter.Value.ToString("F1")
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td style="text-align: center; font-size: 0.9em;">
                                @if (p.RatingChange.HasValue)
                                {
                                    var change = p.RatingChange.Value;
                                    var color = change > 0 ? "green" : (change < 0 ? "red" : "gray");
                                    var prefix = change > 0 ? "+" : "";
                                    <span style="color: @color; font-weight: bold;">@prefix@change.ToString("F1")</span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            @if (hasAnyPromotion)
                            {
                                <td>
                                    @if (!string.IsNullOrEmpty(p.PromotionRanking))
                                    {
                                        <span class="label label-success">@p.PromotionRanking</span>
                                        @if (p.PromotionBonus.HasValue)
                                        {
                                            <span style="color: #5cb85c; font-size: 0.85em; margin-left: 2px;">+@p.PromotionBonus.Value.ToString("F1")</span>
                                        }
                                    }
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

@if (Model.IsAdmin && Model.Matches.Any())
{
    <div style="margin-top: 20px;">
        <h4>Matches (@Model.Matches.Count)</h4>
        <table class="table table-striped table-condensed">
            <thead>
                <tr>
                    <th>Match</th>
                    <th>Score</th>
                    <th style="text-align: center;">Round</th>
                    <th>Date</th>
                    <th style="text-align: center;">Factor</th>
                    <th style="text-align: center;">@LocString[nameof(LocalizationKey.ShiftRating)]</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var m in Model.Matches)
                {
                    <tr>
                        <td style="white-space: nowrap;">
                            <a asp-controller="Leagues" asp-action="Player" asp-route-id="@Model.LeagueId" asp-route-playerId="@m.FirstPlayerId">@m.FirstPlayerName</a>
                            @if (!string.IsNullOrEmpty(m.FirstPlayerRatingBefore))
                            {
                                <span style="color: #666; font-size: 0.85em;">(@m.FirstPlayerRatingBefore)</span>
                            }
                            <span style="margin: 0 5px;">vs</span>
                            <a asp-controller="Leagues" asp-action="Player" asp-route-id="@Model.LeagueId" asp-route-playerId="@m.SecondPlayerId">@m.SecondPlayerName</a>
                            @if (!string.IsNullOrEmpty(m.SecondPlayerRatingBefore))
                            {
                                <span style="color: #666; font-size: 0.85em;">(@m.SecondPlayerRatingBefore)</span>
                            }
                        </td>
                        <td>@m.GetScore()</td>
                        <td style="text-align: center;">@(m.Round.HasValue ? $"R{m.Round}" : "-")</td>
                        <td>@m.Date.ToString("dd/MM/yyyy")</td>
                        <td style="text-align: center;">@(m.Factor.HasValue ? m.Factor.Value.ToString("0.#") : "-")</td>
                        <td style="text-align: center;">
                            @(string.IsNullOrEmpty(m.ShiftRating) ? "-" : m.ShiftRating)
                        </td>
                        <td>
                            <a asp-controller="Matches" asp-action="Edit" asp-route-id="@m.Id">Edit</a>
                            |
                            <a asp-controller="Matches" asp-action="Delete" asp-route-id="@m.Id">Delete</a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
