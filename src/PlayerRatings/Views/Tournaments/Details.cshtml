@using PlayerRatings.Localization
@model PlayerRatings.ViewModels.Tournament.TournamentDetailsViewModel
@inject Microsoft.Extensions.Localization.IStringLocalizer<LocalizationKey> LocString

@{
    ViewData["Title"] = Model.FullName;
}

<h2>@ViewData["Title"]</h2>
<hr />

<div class="form-group">
    <a asp-action="Index" asp-route-leagueId="@Model.LeagueId" class="btn btn-default">
        ‚Üê @LocString[nameof(LocalizationKey.BackToTournaments)]
    </a>
    @if (Model.IsAdmin)
    {
        <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-primary">@LocString[nameof(LocalizationKey.Edit)]</a>
        <a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-danger">@LocString[nameof(LocalizationKey.Delete)]</a>
    }
</div>

<div class="panel panel-default" style="margin-top: 20px;">
    <div class="panel-body">
        <div class="row">
            @if (!string.IsNullOrEmpty(Model.Photo))
            {
                <div class="col-md-3">
                    <img src="@Model.Photo" alt="@Model.FullName" style="max-width: 100%; max-height: 200px; border-radius: 4px;" />
                </div>
            }
            <div class="@(string.IsNullOrEmpty(Model.Photo) ? "col-md-6" : "col-md-4")">
                <dl>
                    <dt>@LocString[nameof(LocalizationKey.TournamentName)]</dt>
                    <dd>@Model.Name</dd>
                    
                    @if (!string.IsNullOrEmpty(Model.Ordinal))
                    {
                        <dt>@LocString[nameof(LocalizationKey.Ordinal)]</dt>
                        <dd>@Model.Ordinal</dd>
                    }
                    
                    @if (!string.IsNullOrEmpty(Model.Group))
                    {
                        <dt>@LocString[nameof(LocalizationKey.Group)]</dt>
                        <dd>@Model.Group</dd>
                    }
                    
                    @if (!string.IsNullOrEmpty(Model.TournamentType))
                    {
                        <dt>@LocString[nameof(LocalizationKey.Type)]</dt>
                        <dd>@Model.TournamentType</dd>
                    }
                </dl>
            </div>
            <div class="@(string.IsNullOrEmpty(Model.Photo) ? "col-md-6" : "col-md-5")">
                <dl>
                    @if (!string.IsNullOrEmpty(Model.Organizer))
                    {
                        <dt>@LocString[nameof(LocalizationKey.Organizer)]</dt>
                        <dd>@Model.Organizer</dd>
                    }
                    
                    @if (!string.IsNullOrEmpty(Model.Location))
                    {
                        <dt>@LocString[nameof(LocalizationKey.Location)]</dt>
                        <dd>@Model.Location</dd>
                    }
                    
                    @if (Model.StartDate.HasValue)
                    {
                        <dt>@LocString[nameof(LocalizationKey.Dates)]</dt>
                        <dd>
                            @Model.StartDate.Value.ToString("dd MMM yyyy")
                            @if (Model.EndDate.HasValue && Model.EndDate.Value.Date != Model.StartDate.Value.Date)
                            {
                                <text> - @Model.EndDate.Value.ToString("dd MMM yyyy")</text>
                            }
                        </dd>
                    }
                    
                    @if (Model.Factor.HasValue)
                    {
                        <dt>@LocString[nameof(LocalizationKey.Factor)]</dt>
                        <dd>@Model.Factor.Value.ToString("F1")</dd>
                    }
                </dl>
            </div>
        </div>
        
        @if (!string.IsNullOrEmpty(Model.Notes))
        {
            <div class="row" style="margin-top: 10px;">
                <div class="col-md-12">
                    <dt>@LocString[nameof(LocalizationKey.Notes)]</dt>
                    <dd style="white-space: pre-wrap;">@Model.Notes</dd>
                </div>
            </div>
        }
        
        @if (Model.ExternalLinksList.Any())
        {
            <div class="row" style="margin-top: 10px;">
                <div class="col-md-12">
                    <dt>@LocString[nameof(LocalizationKey.ExternalLinks)]</dt>
                    <dd>
                        @foreach (var link in Model.ExternalLinksList)
                        {
                            <a href="@link.Trim()" target="_blank" rel="noopener noreferrer" style="margin-right: 10px;">@link.Trim()</a>
                        }
                    </dd>
                </div>
            </div>
        }
    </div>
</div>

@if (Model.SupportsPersonalAward && Model.Players.Any() && Model.MaxRounds > 0)
{
    var hasAnyPromotion = Model.Players.Any(p => !string.IsNullOrEmpty(p.PromotionRanking));
    var hasFemaleAward = Model.SupportsFemaleAward && Model.Players.Any(p => p.IsFemale);
    // Build player index lookup (PlayerId -> sequential index)
    var playerIndex = new Dictionary<string, int>();
    var idx = 1;
    foreach (var player in Model.Players)
    {
        playerIndex[player.PlayerId] = idx++;
    }
    
    <div style="margin-top: 20px;">
        <h4 style="display: inline-block;">@LocString[nameof(LocalizationKey.Standings)]</h4>
        @if (!string.IsNullOrEmpty(Model.StandingsPhoto))
        {
            <a href="@Model.StandingsPhoto" target="_blank" style="margin-left: 10px;">
                <img src="@Model.StandingsPhoto" alt="@LocString[nameof(LocalizationKey.Standings)]" style="max-height: 30px; vertical-align: middle; border-radius: 3px;" />
                <span style="font-size: 0.85em; color: #666;">@LocString[nameof(LocalizationKey.ViewOriginal)]</span>
            </a>
        }
        <div style="overflow-x: auto;">
            <table class="table table-condensed table-bordered" style="background: white;">
                <thead>
                    <tr style="background-color: #f5f5f5;">
                        <th style="width: 30px; text-align: center;">#</th>
                        <th style="width: 40px; text-align: center;">@LocString[nameof(LocalizationKey.Pos)]</th>
                        <th style="white-space: nowrap;">@LocString[nameof(LocalizationKey.Player)]</th>
                        <th style="width: 80px;">@LocString[nameof(LocalizationKey.Residence)]</th>
                        @for (var r = 1; r <= Model.MaxRounds; r++)
                        {
                            <th style="width: 60px; text-align: center;">R@(r)</th>
                        }
                        <th style="width: 40px; text-align: center;" title="@LocString[nameof(LocalizationKey.NumberOfWins)]">@LocString[nameof(LocalizationKey.NbW)]</th>
                        <th style="width: 50px; text-align: center;" title="@LocString[nameof(LocalizationKey.SOS)]">@LocString[nameof(LocalizationKey.SOS)]</th>
                        <th style="width: 60px; text-align: center;" title="@LocString[nameof(LocalizationKey.SOSOS)]">@LocString[nameof(LocalizationKey.SOSOS)]</th>
                        <th style="width: 55px; text-align: center;" title="@LocString[nameof(LocalizationKey.Before)]">@LocString[nameof(LocalizationKey.Before)]</th>
                        <th style="width: 55px; text-align: center;" title="@LocString[nameof(LocalizationKey.After)]">@LocString[nameof(LocalizationKey.After)]</th>
                        <th style="width: 45px; text-align: center;" title="@LocString[nameof(LocalizationKey.ShiftRating)]">+/-</th>
                        @if (hasFemaleAward)
                        {
                            <th style="width: 45px; text-align: center;" title="@LocString[nameof(LocalizationKey.FemaleAward)]">‚ôÄ</th>
                        }
                        @if (hasAnyPromotion)
                        {
                            <th style="width: 70px;">@LocString[nameof(LocalizationKey.Promo)]</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @{ var rowIdx = 0; }
                    @foreach (var p in Model.Players)
                    {
                        rowIdx++;
                        <tr>
                            <td style="text-align: center; font-weight: bold;">@rowIdx</td>
                            <td style="text-align: center;">
                                @if (p.IsCalculatedPosition)
                                {
                                    <span class="text-muted">(@p.DisplayPosition)</span>
                                }
                                else
                                {
                                    @p.DisplayPosition
                                }
                            </td>
                            <td style="white-space: nowrap;">
                                <a asp-controller="Leagues" asp-action="Player" asp-route-id="@Model.LeagueId" asp-route-playerId="@p.PlayerId">@p.PlayerName</a>@if (!string.IsNullOrEmpty(p.PlayerRanking)){<text> </text><span style="color: rgb(255, 99, 132); font-weight: bold;">@p.PlayerRanking</span>}
                            </td>
                            <td style="font-size: 0.9em;">@p.Residence</td>
                            @for (var r = 1; r <= Model.MaxRounds; r++)
                            {
                                <td style="text-align: center;">
                                    @if (p.RoundResults.TryGetValue(r, out var result))
                                    {
                                        var color = result.Won == true ? "green" : (result.Won == false ? "red" : "gray");
                                        var symbol = result.Won == true ? "+" : (result.Won == false ? "-" : "=");
                                        @if (string.IsNullOrEmpty(result.OpponentId))
                                        {
                                            // Bye round - no opponent
                                            <span title="@result.OpponentName (@result.Score)" style="font-style: italic; color: #999;">0</span>
                                            <span style="color: @color; font-weight: bold;">@symbol</span>
                                        }
                                        else
                                        {
                                            var oppIdx = playerIndex.TryGetValue(result.OpponentId, out var oi) ? oi : 0;
                                            <span title="@result.OpponentName (@result.Score)">@oppIdx</span>
                                            <span style="color: @color; font-weight: bold;">@symbol</span>
                                        }
                                    }
                                    else if (Model.IsAdmin)
                                    {
                                        // Use first match date for this round, or tournament start date as fallback
                                        var roundDate = Model.RoundDates.TryGetValue(r, out var rd) 
                                            ? rd 
                                            : (Model.StartDate ?? DateTimeOffset.Now);
                                        <a asp-controller="Matches" asp-action="Create" 
                                           asp-route-leagueId="@Model.LeagueId"
                                           asp-route-tournamentId="@Model.Id"
                                           asp-route-round="@r"
                                           asp-route-lastMatchDateTime="@roundDate.ToString("o")"
                                           asp-route-factor="0"
                                           asp-route-firstPlayerId="@p.PlayerId"
                                           class="btn btn-xs btn-default" title="Add match for @p.PlayerName in Round @r">+</a>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                            }
                            <td style="text-align: center; font-weight: bold;">@(p.Wins % 1 == 0 ? ((int)p.Wins).ToString() : p.Wins.ToString("0.#"))</td>
                            <td style="text-align: center;">@(p.SOS % 1 == 0 ? ((int)p.SOS).ToString() : p.SOS.ToString("0.#"))</td>
                            <td style="text-align: center;">@(p.SOSOS % 1 == 0 ? ((int)p.SOSOS).ToString() : p.SOSOS.ToString("0.#"))</td>
                            <td style="text-align: center; font-size: 0.9em;">
                                @if (p.ShowRatingBefore && p.RatingBefore.HasValue)
                                {
                                    @p.RatingBefore.Value.ToString("F1")
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td style="text-align: center; font-size: 0.9em;">
                                @if (p.ShowRatingAfter && p.RatingAfter.HasValue)
                                {
                                    @p.RatingAfter.Value.ToString("F1")
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td style="text-align: center; font-size: 0.9em;">
                                @if (p.RatingChange.HasValue)
                                {
                                    var change = p.RatingChange.Value;
                                    var color = change > 0 ? "green" : (change < 0 ? "red" : "gray");
                                    var prefix = change > 0 ? "+" : "";
                                    <span style="color: @color; font-weight: bold;">@prefix@change.ToString("F1")</span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            @if (hasFemaleAward)
                            {
                                <td style="text-align: center;">
                                    @if (p.IsFemale && p.FemalePosition.HasValue)
                                    {
                                        @if (p.FemalePosition == 1)
                                        {
                                            <span style="color: #d63384;" title="Female Champion">üëë</span>
                                        }
                                        else
                                        {
                                            <span style="color: #d63384; font-weight: bold;">@p.FemalePosition</span>
                                        }
                                    }
                                    else if (p.IsFemale)
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                            }
                            @if (hasAnyPromotion)
                            {
                                <td>
                                    @if (!string.IsNullOrEmpty(p.PromotionRanking))
                                    {
                                        <span class="label label-success">@p.PromotionRanking</span>
                                        @if (p.PromotionBonus.HasValue)
                                        {
                                            <span style="color: #5cb85c; font-size: 0.85em; margin-left: 2px;">+@p.PromotionBonus.Value.ToString("F1")</span>
                                        }
                                    }
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

@if (Model.SupportsTeamAward && Model.TeamStandings.Any())
{
    <div style="margin-top: 20px;">
        <h4>@LocString[nameof(LocalizationKey.TeamStandings)]</h4>
        <div style="overflow-x: auto;">
            <table class="table table-condensed table-bordered" style="background: white;">
                <thead>
                    <tr style="background-color: #f5f5f5;">
                        <th style="width: 30px; text-align: center;">#</th>
                        <th style="width: 40px; text-align: center;">@LocString[nameof(LocalizationKey.Pos)]</th>
                        <th style="white-space: nowrap;">@LocString[nameof(LocalizationKey.Team)]</th>
                        @if (Model.SupportsPersonalAward)
                        {
                            <th style="width: 50px; text-align: center;">@LocString[nameof(LocalizationKey.PlPos)]</th>
                        }
                        <th>@LocString[nameof(LocalizationKey.Player)]</th>
                        @if (!Model.SupportsPersonalAward)
                        {
                            @for (var r = 1; r <= Model.MaxRounds; r++)
                            {
                                <th style="width: 60px; text-align: center;">R@(r) @LocString[nameof(LocalizationKey.Team)]</th>
                            }
                        }
                        @if (!Model.SupportsPersonalAward)
                        {
                            @for (var r = 1; r <= Model.MaxRounds; r++)
                            {
                                <th style="width: 80px; text-align: center;">R@(r) @LocString[nameof(LocalizationKey.Player)]</th>
                            }
                        }
                        @if (!Model.SupportsPersonalAward)
                        {
                            <th style="width: 40px; text-align: center;" title="@LocString[nameof(LocalizationKey.NumberOfWins)]">@LocString[nameof(LocalizationKey.NbW)]</th>
                            <th style="width: 50px; text-align: center;" title="@LocString[nameof(LocalizationKey.TeamSOS)]">@LocString[nameof(LocalizationKey.SOS)]</th>
                            <th style="width: 60px; text-align: center;" title="@LocString[nameof(LocalizationKey.TeamSOSOS)]">@LocString[nameof(LocalizationKey.SOSOS)]</th>
                        }
                        <th style="width: 50px; text-align: center;" title="@LocString[nameof(LocalizationKey.TotalWinsOfPlayers)]">@LocString[nameof(LocalizationKey.Wins)]</th>
                        @if (Model.SupportsPersonalAward)
                        {
                            <th style="width: 60px; text-align: center;" title="@LocString[nameof(LocalizationKey.SumOfPlayerPositions)]">@LocString[nameof(LocalizationKey.SumPos)]</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var team in Model.TeamStandings.Where(t => t.Players.Count(p => p.CountsForTeamAward) >= 2))
                    {
                        var isFirstRow = true;
                        var qualifiedPlayers = team.Players.Where(p => p.CountsForTeamAward).Take(3).ToList();
                        var playerCount = qualifiedPlayers.Count;
                        @foreach (var player in qualifiedPlayers)
                        {
                            <tr>
                                @if (isFirstRow)
                                {
                                    <td rowspan="@playerCount" style="text-align: center; font-weight: bold; vertical-align: middle;">@team.Index</td>
                                    <td rowspan="@playerCount" style="text-align: center; vertical-align: middle;">@(team.Position?.ToString() ?? "-")</td>
                                    <td rowspan="@playerCount" style="white-space: nowrap; vertical-align: middle;">@team.TeamName</td>
                                }
                                @if (Model.SupportsPersonalAward)
                                {
                                    <td style="text-align: center;">
                                        <strong>@(player.PersonalPosition?.ToString() ?? "-")</strong>
                                    </td>
                                }
                                <td style="white-space: nowrap;">
                                    <a asp-controller="Leagues" asp-action="Player" asp-route-id="@Model.LeagueId" asp-route-playerId="@player.PlayerId">@player.PlayerName</a>
                                </td>
                                @if (!Model.SupportsPersonalAward && isFirstRow)
                                {
                                    @for (var r = 1; r <= Model.MaxRounds; r++)
                                    {
                                        <td rowspan="@playerCount" style="text-align: center; vertical-align: middle;">
                                            @if (team.TeamRoundResults.TryGetValue(r, out var teamResult))
                                            {
                                                var color = teamResult.Won == true ? "green" : (teamResult.Won == false ? "red" : "gray");
                                                var symbol = teamResult.Won == true ? "+" : (teamResult.Won == false ? "-" : "=");
                                                <span title="vs @teamResult.OpponentTeamName (@teamResult.Score)">@teamResult.OpponentTeamIndex</span>
                                                <span style="color: @color; font-weight: bold;">@symbol</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                    }
                                }
                                @if (!Model.SupportsPersonalAward)
                                {
                                    @for (var r = 1; r <= Model.MaxRounds; r++)
                                    {
                                        <td style="text-align: center; font-size: 0.85em;">
                                            @if (player.RoundResults.TryGetValue(r, out var result))
                                            {
                                                var color = result.Won == true ? "green" : (result.Won == false ? "red" : "gray");
                                                var symbol = result.Won == true ? "+" : (result.Won == false ? "-" : "=");
                                                <span title="@result.OpponentName (@result.Score)">@result.OpponentName</span>
                                                <span style="color: @color; font-weight: bold;">@symbol</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                    }
                                }
                                @if (isFirstRow)
                                {
                                    @if (!Model.SupportsPersonalAward)
                                    {
                                        <td rowspan="@playerCount" style="text-align: center; font-weight: bold; vertical-align: middle;">@(team.TeamWins % 1 == 0 ? ((int)team.TeamWins).ToString() : team.TeamWins.ToString("0.#"))</td>
                                        <td rowspan="@playerCount" style="text-align: center; vertical-align: middle;">@(team.TeamSOS % 1 == 0 ? ((int)team.TeamSOS).ToString() : team.TeamSOS.ToString("0.#"))</td>
                                        <td rowspan="@playerCount" style="text-align: center; vertical-align: middle;">@(team.TeamSOSOS % 1 == 0 ? ((int)team.TeamSOSOS).ToString() : team.TeamSOSOS.ToString("0.#"))</td>
                                    }
                                    <td rowspan="@playerCount" style="text-align: center; font-weight: bold; vertical-align: middle;">@(team.TotalPlayerWins % 1 == 0 ? ((int)team.TotalPlayerWins).ToString() : team.TotalPlayerWins.ToString("0.#"))</td>
                                    @if (Model.SupportsPersonalAward)
                                    {
                                        <td rowspan="@playerCount" style="text-align: center; font-weight: bold; vertical-align: middle;">@team.SumOfPlayerPositions</td>
                                    }
                                }
                                @{isFirstRow = false;}
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
}

@if (Model.IsAdmin && Model.Matches.Any())
{
    <div style="margin-top: 20px;">
        <h4>@LocString[nameof(LocalizationKey.Matches)] (@Model.Matches.Count)</h4>
        <p class="text-muted" style="font-size: 0.85em; margin-bottom: 10px;">
            <em>@LocString[nameof(LocalizationKey.MatchesNotRatedNote)]</em>
        </p>
        <table class="table table-striped table-condensed">
            <thead>
                <tr>
                    <th>@LocString[nameof(LocalizationKey.Match)]</th>
                    <th>@LocString[nameof(LocalizationKey.Score)]</th>
                    <th style="text-align: center;">@LocString[nameof(LocalizationKey.Round)]</th>
                    <th>@LocString[nameof(LocalizationKey.Date)]</th>
                    <th style="text-align: center;">@LocString[nameof(LocalizationKey.Factor)]</th>
                    <th style="text-align: center;">@LocString[nameof(LocalizationKey.ShiftRating)]</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var m in Model.Matches)
                {
                    <tr>
                        <td style="white-space: nowrap;">
                            @if (!string.IsNullOrEmpty(m.FirstPlayerId))
                            {
                                <a asp-controller="Leagues" asp-action="Player" asp-route-id="@Model.LeagueId" asp-route-playerId="@m.FirstPlayerId">@m.FirstPlayerName</a>
                                @if (!string.IsNullOrEmpty(m.FirstPlayerRatingBefore))
                                {
                                    <span style="color: #666; font-size: 0.85em;">(@m.FirstPlayerRatingBefore)</span>
                                }
                            }
                            else
                            {
                                <span class="text-muted" style="font-style: italic;">BYE</span>
                            }
                            <span style="margin: 0 5px;">vs</span>
                            @if (!string.IsNullOrEmpty(m.SecondPlayerId))
                            {
                                <a asp-controller="Leagues" asp-action="Player" asp-route-id="@Model.LeagueId" asp-route-playerId="@m.SecondPlayerId">@m.SecondPlayerName</a>
                                @if (!string.IsNullOrEmpty(m.SecondPlayerRatingBefore))
                                {
                                    <span style="color: #666; font-size: 0.85em;">(@m.SecondPlayerRatingBefore)</span>
                                }
                            }
                            else
                            {
                                <span class="text-muted" style="font-style: italic;">BYE</span>
                            }
                        </td>
                        <td>@m.GetScore()</td>
                        <td style="text-align: center;">@(m.Round.HasValue ? $"R{m.Round}" : "-")</td>
                        <td>@m.Date.ToString("dd/MM/yyyy")</td>
                        <td style="text-align: center;">@(m.Factor.HasValue ? m.Factor.Value.ToString("0.#") : "-")</td>
                        <td style="text-align: center;">
                            @(string.IsNullOrEmpty(m.ShiftRating) ? "-" : m.ShiftRating)
                        </td>
                        <td>
                            <a asp-controller="Matches" asp-action="Edit" asp-route-id="@m.Id">@LocString[nameof(LocalizationKey.Edit)]</a>
                            |
                            <a asp-controller="Matches" asp-action="Delete" asp-route-id="@m.Id">@LocString[nameof(LocalizationKey.Delete)]</a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
