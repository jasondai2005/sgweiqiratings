@using PlayerRatings.Localization
@model PlayerRatings.ViewModels.Tournament.TournamentEditViewModel

@{
    ViewData["Title"] = "Edit Tournament";
    
    var months = new[] {
        new { Value = 1, Text = "January" },
        new { Value = 2, Text = "February" },
        new { Value = 3, Text = "March" },
        new { Value = 4, Text = "April" },
        new { Value = 5, Text = "May" },
        new { Value = 6, Text = "June" },
        new { Value = 7, Text = "July" },
        new { Value = 8, Text = "August" },
        new { Value = 9, Text = "September" },
        new { Value = 10, Text = "October" },
        new { Value = 11, Text = "November" },
        new { Value = 12, Text = "December" }
    };
    
    var currentYear = DateTime.Now.Year;
    var years = Enumerable.Range(currentYear - 5, 7).Reverse().ToList();
}

<div class="form-horizontal">
    <h2>@LocString[nameof(LocalizationKey.Tournament)]: @Model.Name</h2>
    <h5 class="text-muted">@Model.LeagueName</h5>
    <hr />
    
    <div class="form-group">
        <div class="col-md-12">
            <a asp-action="Index" asp-route-leagueId="@Model.LeagueId" class="btn btn-default">
                ‚Üê Back to Tournaments
            </a>
            <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-default">
                View Details
            </a>
        </div>
    </div>
</div>

<div class="row" style="margin-top: 20px;">
    <!-- Left Column: Tournament Info -->
    <div class="col-md-5">
        <form asp-action="Edit" method="post" class="form-horizontal">
            <input type="hidden" asp-for="Id" />
            <input type="hidden" asp-for="LeagueId" />
            <input type="hidden" asp-for="FilterMonth" />
            <input type="hidden" asp-for="FilterYear" />
            
            <div class="panel panel-default">
                <div class="panel-heading">Tournament Information</div>
                <div class="panel-body">
                    <div class="form-group">
                        <label asp-for="Name" class="col-sm-3 control-label">Name</label>
                        <div class="col-sm-9">
                            <input asp-for="Name" class="form-control" />
                            <span asp-validation-for="Name" class="text-danger"></span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label asp-for="Ordinal" class="col-sm-3 control-label">Ordinal</label>
                        <div class="col-sm-9">
                            <input asp-for="Ordinal" class="form-control" placeholder="e.g., 4th or 2026" />
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label asp-for="Group" class="col-sm-3 control-label">Group</label>
                        <div class="col-sm-9">
                            <input asp-for="Group" class="form-control" />
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label asp-for="TournamentType" class="col-sm-3 control-label">Type</label>
                        <div class="col-sm-9">
                            <select asp-for="TournamentType" class="form-control">
                                <option value="">--</option>
                                @foreach (var type in PlayerRatings.ViewModels.Tournament.TournamentEditViewModel.CommonTypes)
                                {
                                    <option value="@type">@type</option>
                                }
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label asp-for="Organizer" class="col-sm-3 control-label">Organizer</label>
                        <div class="col-sm-9">
                            <input asp-for="Organizer" class="form-control" />
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label asp-for="Location" class="col-sm-3 control-label">Location</label>
                        <div class="col-sm-9">
                            <input asp-for="Location" class="form-control" />
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label asp-for="StartDate" class="col-sm-3 control-label">Start</label>
                        <div class="col-sm-9">
                            <input asp-for="StartDate" type="date" class="form-control" />
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label asp-for="EndDate" class="col-sm-3 control-label">End</label>
                        <div class="col-sm-9">
                            <input asp-for="EndDate" type="date" class="form-control" />
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label asp-for="Factor" class="col-sm-3 control-label">Factor</label>
                        <div class="col-sm-9">
                            <input asp-for="Factor" type="number" step="0.1" class="form-control" />
                        </div>
                    </div>
                </div>
                <div class="panel-footer">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </form>
        
        
        <!-- Players Section -->
        <div class="panel panel-default">
            <div class="panel-heading">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Players (@Model.AvailablePlayers.Count)</span>
                    <div>
                        @if (Model.AvailablePlayers.Any())
                        {
                            <form asp-action="CalculatePositions" method="post" style="display: inline;">
                                <input type="hidden" name="tournamentId" value="@Model.Id" />
                                <input type="hidden" name="filterMonth" value="@Model.FilterMonth" />
                                <input type="hidden" name="filterYear" value="@Model.FilterYear" />
                                <button type="submit" class="btn btn-xs btn-default" title="Swiss-system: Undefeated first, then wins ‚Üí SOS ‚Üí SOSOS">
                                    Calculate
                                </button>
                            </form>
                        }
                    </div>
                </div>
            </div>
            <div class="panel-body" style="padding: 0;">
                @if (!Model.AvailablePlayers.Any())
                {
                    <p class="text-muted" style="padding: 15px; margin: 0;">Add matches or players below.</p>
                }
                else
                {
                    <form asp-controller="Tournaments" asp-action="SavePositions" method="post" id="savePositionsForm">
                        <input type="hidden" name="tournamentId" value="@Model.Id" />
                        <input type="hidden" name="filterMonth" value="@Model.FilterMonth" />
                        <input type="hidden" name="filterYear" value="@Model.FilterYear" />
                        <table class="table table-condensed" style="margin-bottom: 0;">
                            <thead>
                                <tr>
                                    <th style="width: 55px;">Pos</th>
                                    <th>Player</th>
                                    <th style="width: 30px;">W</th>
                                    <th style="width: 30px;">L</th>
                                    <th style="width: 35px;" title="SOS">SOS</th>
                                    <th style="width: 30px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                @{ var playerIdx = 0; }
                                @foreach (var p in Model.AvailablePlayers)
                                {
                                    var rowStyle = p.IsUndefeated ? "background-color: #fff9c4;" : "";
                                    <tr style="@rowStyle">
                                        <td>
                                            <input type="hidden" name="playerIds[@playerIdx]" value="@p.PlayerId" />
                                            <input type="number" name="positionValues[@playerIdx]" 
                                                   class="form-control input-sm" 
                                                   value="@p.Position" 
                                                   style="width: 45px; padding: 2px 4px;" />
                                        </td>
                                        <td style="white-space: nowrap;">
                                            @p.PlayerName
                                            @if (p.IsUndefeated)
                                            {
                                                <span title="Undefeated">üèÜ</span>
                                            }
                                        </td>
                                        <td>@p.Wins</td>
                                        <td>@p.Losses</td>
                                        <td title="SOS: @p.SOS, SOSOS: @p.SOSOS">@p.SOS</td>
                                        <td>
                                            <form asp-action="RemovePlayer" method="post" style="display: inline;">
                                                <input type="hidden" name="tournamentId" value="@Model.Id" />
                                                <input type="hidden" name="playerId" value="@p.PlayerId" />
                                                <input type="hidden" name="filterMonth" value="@Model.FilterMonth" />
                                                <input type="hidden" name="filterYear" value="@Model.FilterYear" />
                                                <button type="submit" class="btn btn-xs btn-danger" title="Remove">√ó</button>
                                            </form>
                                        </td>
                                    </tr>
                                    playerIdx++;
                                }
                            </tbody>
                        </table>
                    </form>
                }
            </div>
            @if (Model.AvailablePlayers.Any())
            {
                <div class="panel-footer">
                    <button type="submit" form="savePositionsForm" class="btn btn-sm btn-primary">Save Positions</button>
                </div>
            }
        </div>
        
        <!-- Add Player Section -->
        @if (Model.LeaguePlayers.Any())
        {
            <div class="panel panel-default">
                <div class="panel-heading">Add Player</div>
                <div class="panel-body">
                    <form asp-action="AddPlayer" method="post" class="form-inline">
                        <input type="hidden" name="tournamentId" value="@Model.Id" />
                        <input type="hidden" name="filterMonth" value="@Model.FilterMonth" />
                        <input type="hidden" name="filterYear" value="@Model.FilterYear" />
                        <select name="playerId" class="form-control input-sm" style="width: 180px;">
                            @foreach (var p in Model.LeaguePlayers)
                            {
                                <option value="@p.PlayerId">@p.PlayerName</option>
                            }
                        </select>
                        <button type="submit" class="btn btn-sm btn-default">Add</button>
                    </form>
                </div>
            </div>
        }
    </div>
    
    <!-- Right Column: Match Selection -->
    <div class="col-md-7">
        <div class="panel panel-default">
            <div class="panel-heading">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Select Matches</span>
                    <form asp-action="Edit" method="get" style="display: flex; gap: 5px;">
                        <input type="hidden" name="id" value="@Model.Id" />
                        <select name="filterMonth" class="form-control input-sm" style="width: 110px;">
                            @foreach (var m in months)
                            {
                                <option value="@m.Value" selected="@(m.Value == Model.FilterMonth)">@m.Text</option>
                            }
                        </select>
                        <select name="filterYear" class="form-control input-sm" style="width: 80px;">
                            @foreach (var y in years)
                            {
                                <option value="@y" selected="@(y == Model.FilterYear)">@y</option>
                            }
                        </select>
                        <button type="submit" class="btn btn-sm btn-default">Filter</button>
                    </form>
                </div>
            </div>
            <div class="panel-body" style="padding: 0;">
                <form asp-action="AddMatches" method="post" id="addMatchesForm">
                    <input type="hidden" name="tournamentId" value="@Model.Id" />
                    <input type="hidden" name="filterMonth" value="@Model.FilterMonth" />
                    <input type="hidden" name="filterYear" value="@Model.FilterYear" />
                    
                    @if (!Model.AvailableMatches.Any())
                    {
                        <p class="text-muted" style="padding: 15px; margin: 0;">No matches found for the selected month.</p>
                    }
                    else
                    {
                        <!-- Bulk Actions -->
                        <div style="padding: 10px; background: #f5f5f5; border-bottom: 1px solid #ddd;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <label style="margin: 0;">
                                    <input type="checkbox" id="selectAllMatches" /> Select All
                                </label>
                                <span style="color: #999;">|</span>
                                <label style="margin: 0;">Set Round for selected:</label>
                                <input type="number" id="bulkRoundInput" class="form-control input-sm" style="width: 60px;" placeholder="R#" />
                                <button type="button" id="applyBulkRound" class="btn btn-xs btn-default">Apply</button>
                            </div>
                        </div>
                        
                        <table class="table table-condensed table-hover" style="margin-bottom: 0;">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"></th>
                                    <th>Date</th>
                                    <th>Match</th>
                                    <th class="text-center">Score</th>
                                    <th style="width: 60px;">Round</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{ var index = 0; }
                                @foreach (var m in Model.AvailableMatches)
                                {
                                    var isInOther = m.CurrentTournamentId.HasValue && m.CurrentTournamentId != Model.Id;
                                    var isInThis = m.IsSelected;
                                    var rowClass = isInThis ? "success" : (isInOther ? "active" : "");
                                    
                                    <tr class="@rowClass">
                                        <td>
                                            @if (!isInOther)
                                            {
                                                <input type="checkbox" name="matchIds" value="@m.Id" class="match-checkbox" 
                                                       checked="@isInThis" data-index="@index" />
                                            }
                                        </td>
                                        <td>@m.Date.ToString("dd MMM")</td>
                                        <td>
                                            @(string.IsNullOrEmpty(m.FirstPlayerName) ? "BYE" : m.FirstPlayerName) vs @(string.IsNullOrEmpty(m.SecondPlayerName) ? "BYE" : m.SecondPlayerName)
                                            @if (!string.IsNullOrEmpty(m.MatchName))
                                            {
                                                <br /><small class="text-muted">@m.MatchName</small>
                                            }
                                        </td>
                                        <td class="text-center">@m.FirstPlayerScore : @m.SecondPlayerScore</td>
                                        <td>
                                            @if (!isInOther)
                                            {
                                                <input type="number" name="rounds" value="@m.Round" class="form-control input-sm round-input"
                                                       style="width: 50px;" data-index="@index" placeholder="R#" />
                                            }
                                        </td>
                                        <td>
                                            @if (isInThis)
                                            {
                                                <span class="label label-success">In Tournament</span>
                                                <form asp-action="RemoveMatch" method="post" style="display: inline;">
                                                    <input type="hidden" name="tournamentId" value="@Model.Id" />
                                                    <input type="hidden" name="matchId" value="@m.Id" />
                                                    <input type="hidden" name="filterMonth" value="@Model.FilterMonth" />
                                                    <input type="hidden" name="filterYear" value="@Model.FilterYear" />
                                                    <button type="submit" class="btn btn-xs btn-link text-danger" style="padding: 0;">Remove</button>
                                                </form>
                                            }
                                            else if (isInOther)
                                            {
                                                <span class="label label-default" title="@m.CurrentTournamentName">In Another</span>
                                            }
                                        </td>
                                    </tr>
                                    index++;
                                }
                            </tbody>
                        </table>
                    }
                </form>
            </div>
            @if (Model.AvailableMatches.Any(m => !m.CurrentTournamentId.HasValue || m.CurrentTournamentId == Model.Id))
            {
                <div class="panel-footer">
                    <button type="submit" form="addMatchesForm" class="btn btn-primary">Add Selected Matches</button>
                    @if (Model.AvailableMatches.Any(m => m.IsSelected))
                    {
                        <button type="button" id="saveRoundsBtn" class="btn btn-success" style="margin-left: 10px;">Save Rounds</button>
                        <span style="margin-left: 20px; border-left: 1px solid #ddd; padding-left: 20px;">
                            <label style="font-weight: normal;">Shift selected by</label>
                            <input type="number" id="shiftHours" class="form-control" style="width: 70px; display: inline-block; margin: 0 5px;" value="0" />
                            <label style="font-weight: normal;">hours</label>
                            <button type="button" id="shiftTimesBtn" class="btn btn-default" style="margin-left: 5px;">Apply</button>
                        </span>
                    }
                    <br /><small class="text-muted">Check matches and set round numbers, then click Add. Use "Save Rounds" to update rounds for existing matches.</small>
                </div>
            }
        </div>
    </div>
</div>

<!-- Hidden form for Save Rounds -->
<form asp-controller="Tournaments" asp-action="SaveRounds" method="post" id="saveRoundsForm">
    <input type="hidden" name="tournamentId" value="@Model.Id" />
    <input type="hidden" name="filterMonth" value="@Model.FilterMonth" />
    <input type="hidden" name="filterYear" value="@Model.FilterYear" />
    @{ var saveIdx = 0; }
    @foreach (var m in Model.AvailableMatches.Where(x => x.IsSelected))
    {
        <input type="hidden" name="matchIds[@saveIdx]" value="@m.Id" class="save-round-match-id" data-match-id="@m.Id" />
        <input type="hidden" name="rounds[@saveIdx]" value="@m.Round" class="save-round-value" data-match-id="@m.Id" />
        saveIdx++;
    }
</form>

<!-- Hidden form for Shift Match Times -->
<form asp-controller="Tournaments" asp-action="ShiftMatchTimes" method="post" id="shiftTimesForm">
    <input type="hidden" name="tournamentId" value="@Model.Id" />
    <input type="hidden" name="filterMonth" value="@Model.FilterMonth" />
    <input type="hidden" name="filterYear" value="@Model.FilterYear" />
    <input type="hidden" name="hours" id="shiftHoursValue" value="0" />
    <div id="shiftMatchIds"></div>
</form>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        $(function() {
            // Select All functionality
            $('#selectAllMatches').on('change', function() {
                var isChecked = this.checked;
                $('.match-checkbox').each(function() {
                    this.checked = isChecked;
                });
            });
            
            // Update "Select All" checkbox state when individual checkboxes change
            $('.match-checkbox').on('change', function() {
                var allChecked = $('.match-checkbox').length === $('.match-checkbox:checked').length;
                $('#selectAllMatches').prop('checked', allChecked);
            });
            
            // Apply bulk round to selected matches
            $('#applyBulkRound').on('click', function() {
                var roundValue = $('#bulkRoundInput').val();
                if (roundValue === '') {
                    alert('Please enter a round number first.');
                    return;
                }
                
                $('.match-checkbox:checked').each(function() {
                    var index = $(this).data('index');
                    $('.round-input[data-index="' + index + '"]').val(roundValue);
                });
            });
            
            // Save Rounds button - sync values from main form and submit
            $('#saveRoundsBtn').on('click', function() {
                // Update hidden form values from the visible round inputs
                $('.save-round-value').each(function() {
                    var matchId = $(this).data('match-id');
                    // Find the corresponding round input by matching the checkbox value
                    var checkbox = $('input.match-checkbox[value="' + matchId + '"]');
                    if (checkbox.length > 0) {
                        var idx = checkbox.data('index');
                        var roundInput = $('.round-input[data-index="' + idx + '"]');
                        if (roundInput.length > 0) {
                            $(this).val(roundInput.val());
                        }
                    }
                });
                $('#saveRoundsForm').submit();
            });
            
            // Shift Match Times button - collect selected match IDs and submit
            $('#shiftTimesBtn').on('click', function() {
                var hours = parseInt($('#shiftHours').val()) || 0;
                if (hours === 0) {
                    alert('Please enter a non-zero number of hours.');
                    return;
                }
                
                // Get checked matches that are in the tournament (IsSelected)
                var matchIds = [];
                $('.match-checkbox:checked').each(function() {
                    var matchId = $(this).val();
                    // Only include matches that are already in the tournament
                    var isInTournament = $(this).closest('tr').find('.label-success').length > 0;
                    if (isInTournament) {
                        matchIds.push(matchId);
                    }
                });
                
                if (matchIds.length === 0) {
                    alert('Please select matches that are already in the tournament.');
                    return;
                }
                
                // Update hidden form
                $('#shiftHoursValue').val(hours);
                var container = $('#shiftMatchIds');
                container.empty();
                matchIds.forEach(function(id, idx) {
                    container.append('<input type="hidden" name="matchIds[' + idx + ']" value="' + id + '" />');
                });
                
                $('#shiftTimesForm').submit();
            });
        });
    </script>
}
