@using PlayerRatings.Localization
@model PlayerRatings.ViewModels.Tournament.TournamentEditViewModel

@{
    ViewData["Title"] = "Edit Tournament";
    
    var months = new[] {
        new { Value = 1, Text = "January" },
        new { Value = 2, Text = "February" },
        new { Value = 3, Text = "March" },
        new { Value = 4, Text = "April" },
        new { Value = 5, Text = "May" },
        new { Value = 6, Text = "June" },
        new { Value = 7, Text = "July" },
        new { Value = 8, Text = "August" },
        new { Value = 9, Text = "September" },
        new { Value = 10, Text = "October" },
        new { Value = 11, Text = "November" },
        new { Value = 12, Text = "December" }
    };
    
    var currentYear = DateTime.Now.Year;
    var years = Enumerable.Range(currentYear - 5, 7).Reverse().ToList();
}

<div class="form-horizontal">
    <h2>@LocString[nameof(LocalizationKey.Tournament)]: @Model.Name</h2>
    <h5 class="text-muted">@Model.LeagueName</h5>
    <hr />
    
    <div class="form-group">
        <div class="col-md-12">
            <a asp-action="Index" asp-route-leagueId="@Model.LeagueId" class="btn btn-default">
                ← Back to Tournaments
            </a>
            <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-default">
                View Details
            </a>
        </div>
    </div>
</div>

<div class="row" style="margin-top: 20px;">
    <!-- Left Column: Tournament Info -->
    <div class="col-md-5">
        <form asp-action="Edit" method="post" class="form-horizontal">
            <input type="hidden" asp-for="Id" />
            <input type="hidden" asp-for="LeagueId" />
            <input type="hidden" asp-for="FilterMonth" />
            <input type="hidden" asp-for="FilterYear" />
            
            <div class="panel panel-default">
                <div class="panel-heading">Tournament Information</div>
                <div class="panel-body">
                    <div class="form-group">
                        <label asp-for="Name" class="col-sm-3 control-label">Name</label>
                        <div class="col-sm-9">
                            <input asp-for="Name" class="form-control" />
                            <span asp-validation-for="Name" class="text-danger"></span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label asp-for="Ordinal" class="col-sm-3 control-label">Ordinal</label>
                        <div class="col-sm-9">
                            <input asp-for="Ordinal" class="form-control" placeholder="e.g., 4th or 2026" />
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label asp-for="Group" class="col-sm-3 control-label">Group</label>
                        <div class="col-sm-9">
                            <input asp-for="Group" class="form-control" />
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label asp-for="TournamentType" class="col-sm-3 control-label">Type</label>
                        <div class="col-sm-9">
                            <select asp-for="TournamentType" class="form-control">
                                <option value="">--</option>
                                @foreach (var type in PlayerRatings.ViewModels.Tournament.TournamentEditViewModel.CommonTypes)
                                {
                                    <option value="@type">@type</option>
                                }
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label asp-for="Organizer" class="col-sm-3 control-label">Organizer</label>
                        <div class="col-sm-9">
                            <input asp-for="Organizer" class="form-control" />
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label asp-for="Location" class="col-sm-3 control-label">Location</label>
                        <div class="col-sm-9">
                            <input asp-for="Location" class="form-control" />
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label asp-for="StartDate" class="col-sm-3 control-label">Start</label>
                        <div class="col-sm-9">
                            <input asp-for="StartDate" type="date" class="form-control" />
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label asp-for="EndDate" class="col-sm-3 control-label">End</label>
                        <div class="col-sm-9">
                            <input asp-for="EndDate" type="date" class="form-control" />
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label asp-for="Factor" class="col-sm-3 control-label">Factor</label>
                        <div class="col-sm-9">
                            <input asp-for="Factor" type="number" step="0.1" class="form-control" />
                        </div>
                    </div>
                </div>
                <div class="panel-footer">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </form>
        
        <!-- Players Section -->
        <div class="panel panel-default">
            <div class="panel-heading">Players (@Model.AvailablePlayers.Count)</div>
            <div class="panel-body" style="padding: 0;">
                @if (!Model.AvailablePlayers.Any())
                {
                    <p class="text-muted" style="padding: 15px; margin: 0;">Add matches to populate players.</p>
                }
                else
                {
                    <table class="table table-condensed" style="margin-bottom: 0;">
                        <thead>
                            <tr>
                                <th style="width: 60px;">Pos</th>
                                <th>Player</th>
                                <th style="width: 80px;">Promo</th>
                                <th style="width: 50px;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var p in Model.AvailablePlayers)
                            {
                                <tr>
                                    <td>
                                        <input type="number" class="form-control input-sm position-input" 
                                               data-player-id="@p.PlayerId" 
                                               value="@p.Position" 
                                               style="width: 50px;" />
                                    </td>
                                    <td>@p.PlayerName</td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(p.PromotionRanking))
                                        {
                                            <span class="label label-success">@p.PromotionRanking</span>
                                        }
                                    </td>
                                    <td>
                                        <form asp-action="RemovePlayer" method="post" style="display: inline;">
                                            <input type="hidden" name="tournamentId" value="@Model.Id" />
                                            <input type="hidden" name="playerId" value="@p.PlayerId" />
                                            <input type="hidden" name="filterMonth" value="@Model.FilterMonth" />
                                            <input type="hidden" name="filterYear" value="@Model.FilterYear" />
                                            <button type="submit" class="btn btn-xs btn-danger" title="Remove player">×</button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>
    </div>
    
    <!-- Right Column: Match Selection -->
    <div class="col-md-7">
        <div class="panel panel-default">
            <div class="panel-heading">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Select Matches</span>
                    <form asp-action="Edit" method="get" style="display: flex; gap: 5px;">
                        <input type="hidden" name="id" value="@Model.Id" />
                        <select name="filterMonth" class="form-control input-sm" style="width: 110px;">
                            @foreach (var m in months)
                            {
                                <option value="@m.Value" selected="@(m.Value == Model.FilterMonth)">@m.Text</option>
                            }
                        </select>
                        <select name="filterYear" class="form-control input-sm" style="width: 80px;">
                            @foreach (var y in years)
                            {
                                <option value="@y" selected="@(y == Model.FilterYear)">@y</option>
                            }
                        </select>
                        <button type="submit" class="btn btn-sm btn-default">Filter</button>
                    </form>
                </div>
            </div>
            <div class="panel-body" style="padding: 0;">
                <form asp-action="AddMatches" method="post" id="addMatchesForm">
                    <input type="hidden" name="tournamentId" value="@Model.Id" />
                    <input type="hidden" name="filterMonth" value="@Model.FilterMonth" />
                    <input type="hidden" name="filterYear" value="@Model.FilterYear" />
                    
                    @if (!Model.AvailableMatches.Any())
                    {
                        <p class="text-muted" style="padding: 15px; margin: 0;">No matches found for the selected month.</p>
                    }
                    else
                    {
                        <!-- Bulk Actions -->
                        <div style="padding: 10px; background: #f5f5f5; border-bottom: 1px solid #ddd;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <label style="margin: 0;">
                                    <input type="checkbox" id="selectAllMatches" /> Select All
                                </label>
                                <span style="color: #999;">|</span>
                                <label style="margin: 0;">Set Round for selected:</label>
                                <input type="number" id="bulkRoundInput" class="form-control input-sm" style="width: 60px;" placeholder="R#" />
                                <button type="button" id="applyBulkRound" class="btn btn-xs btn-default">Apply</button>
                            </div>
                        </div>
                        
                        <table class="table table-condensed table-hover" style="margin-bottom: 0;">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"></th>
                                    <th>Date</th>
                                    <th>Match</th>
                                    <th class="text-center">Score</th>
                                    <th style="width: 60px;">Round</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{ var index = 0; }
                                @foreach (var m in Model.AvailableMatches)
                                {
                                    var isInOther = m.CurrentTournamentId.HasValue && m.CurrentTournamentId != Model.Id;
                                    var isInThis = m.IsSelected;
                                    var rowClass = isInThis ? "success" : (isInOther ? "active" : "");
                                    
                                    <tr class="@rowClass">
                                        <td>
                                            @if (!isInOther)
                                            {
                                                <input type="checkbox" name="matchIds" value="@m.Id" class="match-checkbox" 
                                                       checked="@isInThis" data-index="@index" />
                                            }
                                        </td>
                                        <td>@m.Date.ToString("dd MMM")</td>
                                        <td>
                                            @m.FirstPlayerName vs @m.SecondPlayerName
                                            @if (!string.IsNullOrEmpty(m.MatchName))
                                            {
                                                <br /><small class="text-muted">@m.MatchName</small>
                                            }
                                        </td>
                                        <td class="text-center">@m.FirstPlayerScore : @m.SecondPlayerScore</td>
                                        <td>
                                            @if (!isInOther)
                                            {
                                                <input type="number" name="rounds" value="@m.Round" class="form-control input-sm round-input"
                                                       style="width: 50px;" data-index="@index" placeholder="R#" />
                                            }
                                        </td>
                                        <td>
                                            @if (isInThis)
                                            {
                                                <span class="label label-success">In Tournament</span>
                                                <form asp-action="RemoveMatch" method="post" style="display: inline;">
                                                    <input type="hidden" name="tournamentId" value="@Model.Id" />
                                                    <input type="hidden" name="matchId" value="@m.Id" />
                                                    <input type="hidden" name="filterMonth" value="@Model.FilterMonth" />
                                                    <input type="hidden" name="filterYear" value="@Model.FilterYear" />
                                                    <button type="submit" class="btn btn-xs btn-link text-danger" style="padding: 0;">Remove</button>
                                                </form>
                                            }
                                            else if (isInOther)
                                            {
                                                <span class="label label-default" title="@m.CurrentTournamentName">In Another</span>
                                            }
                                        </td>
                                    </tr>
                                    index++;
                                }
                            </tbody>
                        </table>
                    }
                </form>
            </div>
            @if (Model.AvailableMatches.Any(m => !m.CurrentTournamentId.HasValue || m.CurrentTournamentId == Model.Id))
            {
                <div class="panel-footer">
                    <button type="submit" form="addMatchesForm" class="btn btn-primary">Add Selected Matches</button>
                    <small class="text-muted" style="margin-left: 10px;">Check matches and set round numbers, then click Add.</small>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        $(function() {
            // Select All functionality
            $('#selectAllMatches').on('change', function() {
                var isChecked = this.checked;
                $('.match-checkbox').each(function() {
                    this.checked = isChecked;
                });
            });
            
            // Update "Select All" checkbox state when individual checkboxes change
            $('.match-checkbox').on('change', function() {
                var allChecked = $('.match-checkbox').length === $('.match-checkbox:checked').length;
                $('#selectAllMatches').prop('checked', allChecked);
            });
            
            // Apply bulk round to selected matches
            $('#applyBulkRound').on('click', function() {
                var roundValue = $('#bulkRoundInput').val();
                if (roundValue === '') {
                    alert('Please enter a round number first.');
                    return;
                }
                
                $('.match-checkbox:checked').each(function() {
                    var index = $(this).data('index');
                    $('.round-input[data-index="' + index + '"]').val(roundValue);
                });
            });
            
            // Update player position via AJAX
            $('.position-input').on('change', function() {
                var playerId = $(this).data('player-id');
                var position = $(this).val() || '';
                
                $.ajax({
                    url: '@Url.Action("UpdatePlayerPosition")',
                    method: 'POST',
                    data: {
                        tournamentId: '@Model.Id',
                        playerId: playerId,
                        position: position
                    },
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(data) {
                        if (!data.success) {
                            alert('Failed to update position: ' + data.message);
                        }
                    }
                });
            });
        });
    </script>
}
