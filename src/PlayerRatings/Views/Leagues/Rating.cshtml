@using PlayerRatings.Localization
@using PlayerRatings.Engine.Rating
@model PlayerRatings.ViewModels.League.RatingViewModel

@{
    ViewData["Title"] = LocString[nameof(LocalizationKey.Rating)];

    var leagueName = Model.LastMatches.FirstOrDefault()?.League?.Name ?? string.Empty;

    // Calculate current date, previous month and next month for navigation
    // Use last day of month for monthly navigation (aligns with Player page rating history)
    var currentDate = string.IsNullOrEmpty(Model.ByDate) 
        ? DateTime.Now 
        : DateTime.ParseExact(Model.ByDate, "dd/MM/yyyy", null);
    // Last day of previous month
    var prevMonthLastDay = new DateTime(currentDate.Year, currentDate.Month, 1).AddDays(-1);
    // Last day of next month
    var nextMonthLastDay = new DateTime(currentDate.Year, currentDate.Month, 1).AddMonths(2).AddDays(-1);
    var prevMonthStr = prevMonthLastDay.ToString("dd/MM/yyyy");
    var nextMonthStr = nextMonthLastDay.ToString("dd/MM/yyyy");
    var currentDateStr = currentDate.ToString("dd/MM/yyyy");
    var isViewingToday = currentDate.Date == DateTime.Now.Date;
    
    // Check if we have comparison data
    var hasComparison = Model.ComparisonDate.HasValue && Model.PreviousRatings.Any();
    var comparisonDateStr = Model.ComparisonDate?.ToString("dd/MM") ?? "";
    
    // Localized strings for NEW and RET
    var newLabel = @LocString[nameof(LocalizationKey.New)].Value;
    var retLabel = @LocString[nameof(LocalizationKey.Returning)].Value;
    
    // Helper to format position change (NEW for new players, RET for returning after inactivity, arrows for changes, empty for no change)
    string FormatPositionChange(int currentPos, int? prevPos, bool wasRankedBefore)
    {
        if (!prevPos.HasValue)
        {
            // Player not in previous rankings
            // - NEW: First time being ranked (including after completing performance estimation)
            // - RET: Was ranked before but dropped off due to inactivity, now returning
            if (wasRankedBefore)
                return $"<span style=\"color: #fd7e14; font-size: 0.85em;\">{retLabel}</span>";
            return $"<span style=\"color: #17a2b8; font-size: 0.85em;\">{newLabel}</span>";
        }
        var diff = prevPos.Value - currentPos; // positive = moved up
        if (diff > 0) return $"<span style=\"color: #28a745;\">↑{diff}</span>";
        if (diff < 0) return $"<span style=\"color: #dc3545;\">↓{Math.Abs(diff)}</span>";
        return ""; // No change - show empty
    }
    
    // Helper to format rating change (empty if no change or very small change)
    string FormatRatingChange(double currentRating, double? prevRating)
    {
        if (!prevRating.HasValue) return "";
        var diff = currentRating - prevRating.Value;
        if (Math.Abs(diff) < 0.1) return ""; // No significant change - show empty
        if (diff > 0) return $"<span style=\"color: #28a745;\">+{diff:F1}</span>";
        return $"<span style=\"color: #dc3545;\">{diff:F1}</span>";
    }
    
    // Helper to calculate promotion hint based on player rating and ranking
    // Shows the highest rank a player qualifies for based on their current rating
    (string tooltip, string style) GetPromotionHint(ApplicationUser player, double currentRating)
    {
        // Skip Pro players and players with unknown ranking
        if (player.IsProPlayer || string.IsNullOrEmpty(player.RankingBeforeCutoffDate))
            return (null, null);
        
        var currentRankingStr = player.RankingBeforeCutoffDate;
        
        // Parse current ranking
        var (currentGrade, currentOrg) = RatingCalculator.ParseRankingString(currentRankingStr);
        if (string.IsNullOrEmpty(currentGrade))
            return (null, null);
        
        currentGrade = currentGrade.ToUpper();
        
        // Extract rank number and type
        if (!System.Text.RegularExpressions.Regex.IsMatch(currentGrade, @"\d+[KDP]"))
            return (null, null);
        
        var match = System.Text.RegularExpressions.Regex.Match(currentGrade, @"(\d+)([KDP])");
        if (!match.Success)
            return (null, null);
        
        int rankNum = int.Parse(match.Groups[1].Value);
        char rankType = match.Groups[2].Value[0];
        
        // Find the highest rank the player qualifies for
        string highestQualifiedRank = null;
        int highestQualifiedRating = 0;
        
        // Check successive ranks until we find one they don't qualify for
        int checkRankNum = rankNum;
        char checkRankType = rankType;
        
        while (true)
        {
            // Calculate next rank
            string nextRankGrade = null;
            if (checkRankType == 'K' && checkRankNum > 1)
            {
                nextRankGrade = $"{checkRankNum - 1}K";
                checkRankNum--;
            }
            else if (checkRankType == 'K' && checkRankNum == 1)
            {
                nextRankGrade = "1D";
                checkRankType = 'D';
                checkRankNum = 1;
            }
            else if (checkRankType == 'D' && checkRankNum < 7)
            {
                nextRankGrade = $"{checkRankNum + 1}D";
                checkRankNum++;
            }
            else
            {
                // Reached 7D or Pro - no more promotions
                break;
            }
            
            // Calculate next rank's rating (use SWA for consistency)
            int nextRankRating = RatingCalculator.CalculateRating(nextRankGrade, "SWA", !Model.IsSgLeague);
            
            // Check if player qualifies for this rank
            if (currentRating >= nextRankRating)
            {
                highestQualifiedRank = nextRankGrade;
                highestQualifiedRating = nextRankRating;
            }
            else
            {
                // Player doesn't qualify for this rank, stop checking
                break;
            }
        }
        
        // If player qualifies for at least one promotion, show hint
        if (!string.IsNullOrEmpty(highestQualifiedRank))
        {
            return ($"Hint for Promotion to {highestQualifiedRank} (Target: {highestQualifiedRating}, Current: {currentRating:F1})", 
                    "font-weight: bold; color: #fd7e14;");
        }
        
        return (null, null);
    }
}

<style>
    /* Mobile-friendly styles */
    .rating-nav {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
        margin-bottom: 16px;
    }
    .rating-nav .btn {
        padding: 6px 10px;
        font-size: 0.9em;
    }
    .rating-nav input[type="text"] {
        width: 100px;
        padding: 6px 8px;
        font-size: 0.9em;
    }
    
    /* Collapsible section styles */
    .section-header {
        cursor: pointer;
        user-select: none;
        padding: 10px 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 6px;
        margin-bottom: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s ease;
    }
    .section-header:hover {
        filter: brightness(1.05);
    }
    .section-header.collapsed {
        border-radius: 6px;
        margin-bottom: 12px;
    }
    .section-header .toggle-icon {
        transition: transform 0.2s ease;
        font-size: 1.2em;
    }
    .section-header.collapsed .toggle-icon {
        transform: rotate(-90deg);
    }
    .section-content {
        border: 1px solid #e0e0e0;
        border-top: none;
        border-radius: 0 0 6px 6px;
        margin-bottom: 16px;
        overflow: hidden;
    }
    .section-content.collapsed {
        display: none;
    }
    .section-header.secondary {
        background: linear-gradient(135deg, #868e96 0%, #495057 100%);
    }
    .section-header.matches {
        background: linear-gradient(135deg, #20c997 0%, #087f5b 100%);
    }
    .section-header .badge {
        background: rgba(255,255,255,0.25);
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 0.85em;
        margin-left: 8px;
    }
    
    /* Mobile table adjustments */
    @@media (max-width: 768px) {
        .rating-nav {
            justify-content: flex-start;
        }
        .rating-nav .btn {
            flex: 0 1 auto;
            min-width: 40px;
        }
        .table-responsive {
            margin: 0 -15px;
        }
        .table th, .table td {
            padding: 6px 8px;
            font-size: 0.85em;
        }
        .section-header {
            padding: 8px 12px;
            font-size: 0.95em;
        }
        h3 {
            font-size: 1.4em;
        }
    }
    
    /* Hide less important columns on mobile */
    @@media (max-width: 576px) {
        .hide-mobile {
            display: none;
        }
        .table th, .table td {
            padding: 4px 6px;
            font-size: 0.8em;
        }
    }
</style>

<h3>@ViewData["Title"]</h3>

<form asp-action="Rating" method="get" class="rating-nav">
    <input type="hidden" name="id" value="@Model.LeagueId" />
    <a href="@Url.Action("Rating", new { id = Model.LeagueId, byDate = prevMonthStr })" class="btn btn-outline-primary">◀ @prevMonthLastDay.ToString("MMM", System.Globalization.CultureInfo.CurrentUICulture)</a>
    <input type="text" name="byDate" value="@currentDateStr" class="form-control text-center" placeholder="dd/MM/yyyy" />
    <button type="submit" class="btn btn-primary">@LocString[nameof(LocalizationKey.Go)]</button>
    @if (nextMonthLastDay <= DateTime.Now)
    {
        <a href="@Url.Action("Rating", new { id = Model.LeagueId, byDate = nextMonthStr })" class="btn btn-outline-primary">@nextMonthLastDay.ToString("MMM", System.Globalization.CultureInfo.CurrentUICulture) ▶</a>
    }
    else
    {
        <span class="btn btn-outline-secondary disabled">@nextMonthLastDay.ToString("MMM", System.Globalization.CultureInfo.CurrentUICulture) ▶</span>
    }
    @if (!isViewingToday)
    {
        <a href="@Url.Action("Rating", new { id = Model.LeagueId })" class="btn btn-success">@LocString[nameof(LocalizationKey.Today)]</a>
    }
    <a href="@Url.Action("Rating", new { id = Model.LeagueId, byDate = Model.ByDate, refresh = true })" class="btn btn-outline-secondary" title="@LocString[nameof(LocalizationKey.Refresh)]">⟳</a>
</form>

<!-- Active Players Section -->
<div class="section-header" onclick="toggleSection('active-players')">
    <span>
        @LocString[nameof(LocalizationKey.Rating)]
        <span class="badge">@Model.Users.Count()</span>
    </span>
    <span class="toggle-icon">▼</span>
</div>
<div id="active-players" class="section-content">
    <div class="table-responsive">
        <table class="table table-striped">
            <tr>
                <th style="@(hasComparison ? "padding-right: 2px;" : "")">
                    №
                </th>
                @if (hasComparison)
                {
                    <th title="Position change since @comparisonDateStr" style="text-align: center; padding-left: 2px;">↑↓</th>
                }
                <th>
                    @LocString[nameof(LocalizationKey.DisplayName)]
                </th>
                <th class="hide-mobile">
                    @LocString[nameof(LocalizationKey.BirthYear)]
                </th>
                <th>
                    @LocString[nameof(LocalizationKey.Ranking)]
                </th>
                @{ var statIndex = 0; }
                @foreach (var item in Model.Stats)
                {
                    <th style="@(hasComparison && statIndex == 0 ? "padding-right: 2px;" : "")" class="@(statIndex > 0 ? "hide-mobile" : "")">
                        @LocString[item.NameLocalizationKey]
                    </th>
                    @if (hasComparison && statIndex == 0)
                    {
                        <th title="Rating change since @comparisonDateStr" style="text-align: center; padding-left: 2px;">+/-</th>
                    }
                    statIndex++;
                }
            </tr>

            @{ 
                var actualPosition = 0;  // Actual count of non-pro players
                var displayPosition = 0; // Display position (handles ties)
                double? previousRating = null;
            }
            @foreach (var item in Model.Users)
            {
                var isFemale = item.DisplayName?.Contains("♀") ?? false;
                var prevRating = Model.PreviousRatings.TryGetValue(item.Id, out var pr) ? (double?)pr : null;
                var prevPosition = Model.PreviousPositions.TryGetValue(item.Id, out var pp) ? (int?)pp : null;
                var currentRating = Model.CurrentRatings.TryGetValue(item.Id, out var cr) ? cr : 0;
                // Player is "returning" only if they were previously ranked (had a position) but dropped off
                // Players completing performance estimation have ratings but no previous position - they're NEW
                var wasRankedBefore = prevPosition.HasValue;
                var isProPlayer = item.IsProPlayer;
                
                // Pro players show "Pro", non-pro players get position numbers with tie handling
                string positionDisplay;
                if (isProPlayer)
                {
                    positionDisplay = "Pro";
                }
                else
                {
                    // Increment actual position counter for non-pro players only
                    actualPosition++;
                    
                    // Check if this player has same rating as previous player (tie)
                    // First player or different rating: update display position
                    if (!previousRating.HasValue || currentRating != previousRating.Value)
                    {
                        displayPosition = actualPosition;
                    }
                    // Same rating: keep same display position (tie)
                    
                    positionDisplay = displayPosition.ToString();
                    previousRating = currentRating;
                }
                <tr>
                    <td style="@(hasComparison ? "padding-right: 2px;" : "")">
                        @positionDisplay
                    </td>
                    @if (hasComparison)
                    {
                        <td style="text-align: center; white-space: nowrap; font-size: 0.9em; padding-left: 2px;">
                            @if (!isProPlayer)
                            {
                                @Html.Raw(FormatPositionChange(displayPosition, prevPosition, wasRankedBefore))
                            }
                        </td>
                    }
                    <td>
                        <a href="@Url.Action("Player", new { id = Model.LeagueId, playerId = item.Id })" style="@(isFemale ? "color: #d63384;" : "")">@item.DisplayName</a>
                    </td>
                    <td class="hide-mobile">
                        @item.BirthYearU18
                    </td>
                    <td>
                        @item.RankingBeforeCutoffDate.ToUpper()
                    </td>
                    @{ 
                        var userStatIndex = 0;
                        var (promotionTooltip, promotionStyle) = GetPromotionHint(item, currentRating);
                    }
                    @foreach (var res in Model.Stats)
                    {
                        var cellStyle = (hasComparison && userStatIndex == 0 ? "padding-right: 2px;" : "");
                        if (userStatIndex == 0 && !string.IsNullOrEmpty(promotionStyle))
                        {
                            cellStyle += " " + promotionStyle;
                        }
                        <td style="@cellStyle" class="@(userStatIndex > 0 ? "hide-mobile" : "")" 
                            @if (userStatIndex == 0 && !string.IsNullOrEmpty(promotionTooltip)) { <text>title="@promotionTooltip"</text> }>
                            @res.GetResult(item)
                        </td>
                        @if (hasComparison && userStatIndex == 0)
                        {
                            <td style="text-align: center; white-space: nowrap; font-size: 0.9em; padding-left: 2px;">
                                @if (wasRankedBefore)
                                {
                                    @Html.Raw(FormatRatingChange(currentRating, prevRating))
                                }
                            </td>
                        }
                        userStatIndex++;
                    }
                </tr>
            }
        </table>
    </div>
</div>

@if (Model.NonLocalUsers.Any())
{
    <!-- Non-Local Players Section -->
    <div class="section-header secondary collapsed" onclick="toggleSection('non-local-players')">
        <span>
            @LocString[nameof(LocalizationKey.NonLocalPlayers)]
            <span class="badge">@Model.NonLocalUsers.Count()</span>
        </span>
        <span class="toggle-icon">▼</span>
    </div>
    <div id="non-local-players" class="section-content collapsed">
        <div class="table-responsive">
            <table class="table table-striped">
                @foreach (var item in Model.NonLocalUsers)
                {
                    var isFemale = item.DisplayName?.Contains("♀") ?? false;
                    var prevRating = Model.PreviousRatings.TryGetValue(item.Id, out var pr) ? (double?)pr : null;
                    var currentRating = double.TryParse(Model.Stats.First().GetResult(item), out var cr) ? cr : 0;
                    <tr style="background-color: #fafafa;">
                        <td style="color: #888; @(hasComparison ? "padding-right: 2px;" : "")">-</td>
                        @if (hasComparison)
                        {
                            <td style="padding-left: 2px;"></td>
                        }
                        <td>
                            <a href="@Url.Action("Player", new { id = Model.LeagueId, playerId = item.Id })" style="@(isFemale ? "color: #d63384;" : "")">@item.DisplayName</a>
                        </td>
                        <td class="hide-mobile">@item.BirthYearU18</td>
                        <td>@item.RankingBeforeCutoffDate.ToUpper()</td>
                        @{ 
                            var nlStatIndex = 0;
                            var (nlPromotionTooltip, nlPromotionStyle) = GetPromotionHint(item, currentRating);
                        }
                        @foreach (var res in Model.Stats)
                        {
                            var nlCellStyle = (hasComparison && nlStatIndex == 0 ? "padding-right: 2px;" : "");
                            if (nlStatIndex == 0 && !string.IsNullOrEmpty(nlPromotionStyle))
                            {
                                nlCellStyle += " " + nlPromotionStyle;
                            }
                            <td style="@nlCellStyle" class="@(nlStatIndex > 0 ? "hide-mobile" : "")"
                                @if (nlStatIndex == 0 && !string.IsNullOrEmpty(nlPromotionTooltip)) { <text>title="@nlPromotionTooltip"</text> }>
                                @res.GetResult(item)
                            </td>
                            @if (hasComparison && nlStatIndex == 0)
                            {
                                <td style="text-align: center; white-space: nowrap; font-size: 0.9em; padding-left: 2px;">
                                    @Html.Raw(FormatRatingChange(currentRating, prevRating))
                                </td>
                            }
                            nlStatIndex++;
                        }
                    </tr>
                }
            </table>
        </div>
    </div>
}

@if (Model.InactiveUsers.Any())
{
    <!-- Inactive Players Section -->
    <div class="section-header secondary collapsed" onclick="toggleSection('inactive-players')">
        <span>
            @LocString[nameof(LocalizationKey.InactivePlayers)]
            <span class="badge">@Model.InactiveUsers.Count()</span>
        </span>
        <span class="toggle-icon">▼</span>
    </div>
    <div id="inactive-players" class="section-content collapsed">
        <div class="table-responsive">
            <table class="table table-striped">
                @foreach (var item in Model.InactiveUsers)
                {
                    var isFemale = item.DisplayName?.Contains("♀") ?? false;
                    var prevRating = Model.PreviousRatings.TryGetValue(item.Id, out var pr) ? (double?)pr : null;
                    var currentRating = double.TryParse(Model.Stats.First().GetResult(item), out var cr) ? cr : 0;
                    <tr style="background-color: #fafafa;">
                        <td style="color: #999; @(hasComparison ? "padding-right: 2px;" : "")">-</td>
                        @if (hasComparison)
                        {
                            <td style="padding-left: 2px;"></td>
                        }
                        <td>
                            <a href="@Url.Action("Player", new { id = Model.LeagueId, playerId = item.Id })" style="@(isFemale ? "color: #d63384;" : "")">@item.DisplayName</a>
                        </td>
                        <td class="hide-mobile">@item.BirthYearU18</td>
                        <td>@item.RankingBeforeCutoffDate.ToUpper()</td>
                        @{ 
                            var inStatIndex = 0;
                            var (inPromotionTooltip, inPromotionStyle) = GetPromotionHint(item, currentRating);
                        }
                        @foreach (var res in Model.Stats)
                        {
                            var inCellStyle = "color: #999; " + (hasComparison && inStatIndex == 0 ? "padding-right: 2px;" : "");
                            if (inStatIndex == 0 && !string.IsNullOrEmpty(inPromotionStyle))
                            {
                                inCellStyle += " " + inPromotionStyle;
                            }
                            <td style="@inCellStyle" class="@(inStatIndex > 0 ? "hide-mobile" : "")"
                                @if (inStatIndex == 0 && !string.IsNullOrEmpty(inPromotionTooltip)) { <text>title="@inPromotionTooltip"</text> }>
                                @res.GetResult(item)
                            </td>
                            @if (hasComparison && inStatIndex == 0)
                            {
                                <td style="text-align: center; white-space: nowrap; font-size: 0.9em; padding-left: 2px;">
                                    @Html.Raw(FormatRatingChange(currentRating, prevRating))
                                </td>
                            }
                            inStatIndex++;
                        }
                    </tr>
                }
            </table>
        </div>
    </div>
}

@if (Model.PromotedPlayers.Any())
{
    <!-- Promoted Players Section -->
    <div class="section-header secondary collapsed" onclick="toggleSection('promoted-players')">
        <span>
            @LocString[nameof(LocalizationKey.Promotions)]
            <span class="badge">@Model.PromotedPlayers.Count()</span>
        </span>
        <span class="toggle-icon">▼</span>
    </div>
    <div id="promoted-players" class="section-content collapsed">
        <div class="table-responsive">
            <table class="table table-striped">
                @foreach (var item in Model.PromotedPlayers)
                {
                    <tr>
                        <td>
                            @item.ShorterName @item.Promotion
                        </td>
                    </tr>
                }
            </table>
        </div>
    </div>
}

<!-- Last Matches Section (hidden on mobile) -->
<div class="section-header matches collapsed hide-mobile" onclick="toggleSection('last-matches')">
    <span>
        @LocString[nameof(LocalizationKey.LastMatches)]
        <span class="badge">@Model.LastMatches.Count()</span>
    </span>
    <span class="toggle-icon">▼</span>
</div>
<div id="last-matches" class="section-content collapsed hide-mobile">
    <div class="table-responsive">
        <table class="table table-striped">
            <tr>
                <th>
                    @LocString[nameof(LocalizationKey.Match)]
                </th>
                <th>
                    @LocString[nameof(LocalizationKey.FirstPlayer)]
                </th>
                <th class="hide-mobile">
                    @LocString[nameof(LocalizationKey.SecondPlayer)]
                </th>
                <th>
                    @LocString[nameof(LocalizationKey.ShiftRating)]
                </th>
                <th class="hide-mobile">
                    @LocString[nameof(LocalizationKey.Date)]
                </th>
            </tr>

            @foreach (var item in Model.LastMatches)
            {
                <tr>
                    <td>
                        @if (item.TournamentId.HasValue && item.Tournament != null)
                        {
                            <a asp-controller="Tournaments" asp-action="Details" asp-route-id="@item.TournamentId" data-name="@item.Tournament.Name">@item.Tournament.FullName</a>
                            @if (item.Round.HasValue)
                            {
                                <text> R@(item.Round)</text>
                            }
                        }
                        else if (!string.IsNullOrEmpty(item.MatchName))
                        {
                        @item.MatchName
                        }
                    </td>
                    <td>
                        @if (item.FirstPlayer != null)
                        {
                            @item.FirstPlayer.DisplayName <text>(@item.OldFirstPlayerRating)</text>
                        }
                        else
                        {
                            <span class="text-muted" style="font-style: italic;">BYE</span>
                        }
                    </td>
                    <td class="hide-mobile">
                        @if (item.SecondPlayer != null)
                        {
                            @item.SecondPlayer.DisplayName <text>(@item.OldSecondPlayerRating)</text>
                        }
                        else
                        {
                            <span class="text-muted" style="font-style: italic;">BYE</span>
                        }
                    </td>
                    <td>
                        @item.ShiftRating
                    </td>
                    <td class="hide-mobile">
                        @item.StrDate
                    </td>
                </tr>
            }
        </table>
    </div>
</div>

<script>
    function toggleSection(sectionId) {
        var content = document.getElementById(sectionId);
        var header = content.previousElementSibling;
        
        if (content.classList.contains('collapsed')) {
            content.classList.remove('collapsed');
            header.classList.remove('collapsed');
        } else {
            content.classList.add('collapsed');
            header.classList.add('collapsed');
        }
    }
</script>
