@using PlayerRatings.Localization
@model PlayerRatings.ViewModels.League.RatingViewModel

@{
    ViewData["Title"] = LocString[nameof(LocalizationKey.Rating)];

    var number = 1;
    var leagueName = Model.LastMatches.FirstOrDefault()?.League?.Name ?? string.Empty;

    // Calculate current date, previous month and next month for navigation
    var currentDate = string.IsNullOrEmpty(Model.ByDate) 
        ? DateTime.Now 
        : DateTime.ParseExact(Model.ByDate, "dd/MM/yyyy", null);
    var prevMonth = new DateTime(currentDate.Year, currentDate.Month, 1).AddMonths(-1);
    var nextMonth = new DateTime(currentDate.Year, currentDate.Month, 1).AddMonths(1);
    var prevMonthStr = prevMonth.ToString("dd/MM/yyyy");
    var nextMonthStr = nextMonth.ToString("dd/MM/yyyy");
    var currentDateStr = currentDate.ToString("dd/MM/yyyy");
    var isViewingToday = currentDate.Date == DateTime.Now.Date;
}

<h3>@ViewData["Title"]</h3>

<form asp-action="Rating" method="get" class="mb-4">
    <input type="hidden" name="id" value="@Model.LeagueId" />
    <input type="hidden" id="swaOnlyHidden" name="swaOnly" value="@(Model.SwaOnly ? "true" : "false")" />
    <input type="hidden" id="promotionBonusHidden" name="promotionBonus" value="@(Model.PromotionBonus ? "true" : "false")" />
    <div style="display: inline-flex; flex-wrap: nowrap; gap: 4px; align-items: center;">
        <a href="@Url.Action("Rating", new { id = Model.LeagueId, byDate = prevMonthStr, swaOnly = Model.SwaOnly, promotionBonus = Model.PromotionBonus })" class="btn btn-outline-primary">◀ @prevMonth.ToString("MMM")</a>
        <input type="text" name="byDate" value="@currentDateStr" class="form-control text-center" style="width: 110px;" placeholder="dd/MM/yyyy" />
        <button type="submit" class="btn btn-primary">Go</button>
        @if (nextMonth <= DateTime.Now)
        {
            <a href="@Url.Action("Rating", new { id = Model.LeagueId, byDate = nextMonthStr, swaOnly = Model.SwaOnly, promotionBonus = Model.PromotionBonus })" class="btn btn-outline-primary">@nextMonth.ToString("MMM") ▶</a>
        }
        else
        {
            <span class="btn btn-outline-secondary disabled">@nextMonth.ToString("MMM") ▶</span>
        }
        @if (!isViewingToday)
        {
            <a href="@Url.Action("Rating", new { id = Model.LeagueId, swaOnly = Model.SwaOnly, promotionBonus = Model.PromotionBonus })" class="btn btn-success">Today</a>
        }
    </div>
    @if (!Model.IsIntlLeague)
    {
        <div class="mt-2" style="display: inline-flex; gap: 16px; align-items: center;">
            <div class="form-check form-switch" style="display: flex; align-items: center; gap: 6px;">
                <input class="form-check-input" type="checkbox" id="swaOnlyToggle" @(Model.SwaOnly ? "checked" : "") onchange="document.getElementById('swaOnlyHidden').value = this.checked; this.form.submit();" style="cursor: pointer;">
                <label class="form-check-label" for="swaOnlyToggle" style="cursor: pointer; white-space: nowrap;">SWA Tournaments Only</label>
            </div>
            <div class="form-check form-switch" style="display: flex; align-items: center; gap: 6px;">
                <input class="form-check-input" type="checkbox" id="promotionBonusToggle" @(Model.PromotionBonus ? "checked" : "") onchange="document.getElementById('promotionBonusHidden').value = this.checked; this.form.submit();" style="cursor: pointer;">
                <label class="form-check-label" for="promotionBonusToggle" style="cursor: pointer; white-space: nowrap;">Promotion Bonus</label>
            </div>
        </div>
    }
</form>

<div class="table-responsive">
    <table class="table table-striped">
        <tr>
            <th>
                №
            </th>
            <th>
                @LocString[nameof(LocalizationKey.DisplayName)]
            </th>
            <th>
                @LocString[nameof(LocalizationKey.BirthYear)]
            </th>
            <th>
                @LocString[nameof(LocalizationKey.Ranking)]
            </th>
            @foreach (var item in Model.Stats)
            {
                <th>
                    @LocString[item.NameLocalizationKey]
                </th>
            }
            @if (Model.Stats.Count() > 2)
            {
                <th>
                    @LocString[nameof(LocalizationKey.OriRanking)]
                </th>
            }
        </tr>

        @foreach (var item in Model.Users)
        {
            <tr>
                <td>
                    @item.GetPosition(ref number, leagueName)
                </td>
                <td>
                    <a href="@Url.Action("Player", new { id = Model.LeagueId, playerId = item.Id, swaOnly = Model.SwaOnly, promotionBonus = Model.PromotionBonus })">@item.DisplayName</a>
                </td>
                <td>
                    @item.BirthYearU18
                </td>
                <td>
                    @item.RankingBeforeCutoffDate.ToUpper()
                </td>
                @foreach (var res in Model.Stats)
                {
                    <td>
                        @res.GetResult(item)
                    </td>
                }
                @if (Model.Stats.Count() > 2)
                {
                    <td>
                        @item.InitRanking
                    </td>
                }
            </tr>
        }

    </table>
</div>

<div class="table-responsive">
    <table class="table table-striped">
        @foreach (var item in Model.PromotedPlayers)
        {
            <tr>
                <td>
                    @item.ShorterName @item.Promotion
                </td>
            </tr>
        }

    </table>
</div>

<h3>@LocString[nameof(LocalizationKey.LastMatches)]</h3>
<div class="table-responsive">
    <table class="table table-striped table-responsive">
        <tr>
            <th>
                @LocString[nameof(LocalizationKey.Match)]
            </th>
            <th>
                @LocString[nameof(LocalizationKey.FirstPlayer)]
            </th>
            <th>
                @LocString[nameof(LocalizationKey.SecondPlayer)]
            </th>
            <th>
                @LocString[nameof(LocalizationKey.ShiftRating)]
            </th>
            <th>
                @LocString[nameof(LocalizationKey.Date)]
            </th>
        </tr>

        @foreach (var item in Model.LastMatches)
        {
            <tr>
                <td>
                    @item.MatchName
                </td>
                <td>
                    @item.FirstPlayer.DisplayName (@item.OldFirstPlayerRating)
                </td>
                <td>
                    @item.SecondPlayer.DisplayName (@item.OldSecondPlayerRating)
                </td>
                <td>
                    @item.ShiftRating
                </td>
                <td>
                    @item.StrDate
                </td>
            </tr>
        }
    </table>
</div>

@* <h3>@LocString[nameof(LocalizationKey.Forecast)]</h3>
<div class="table-responsive">
    <table class="table table-striped table-responsive">
        <tr>
            <th>
            </th>
            @foreach (var item in Model.Users)
            {
                <th>
                    @item.DisplayName
                </th>
            }
        </tr>

        @foreach (var userVer in Model.Users)
        {
            <tr>
                <td>
                    @userVer.DisplayName
                </td>
                @foreach (var userHor in Model.Users)
                {
                    <td>
                        @if (userHor != userVer)
                    {
                            @Model.Forecast[userVer.Id][userHor.Id]
                        }
                    </td>
                }
            </tr>
        }
    </table>
</div> *@
