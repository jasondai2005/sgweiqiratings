@using PlayerRatings.Localization
@model PlayerRatings.ViewModels.League.RatingViewModel

@{
    ViewData["Title"] = LocString[nameof(LocalizationKey.Rating)];

    var leagueName = Model.LastMatches.FirstOrDefault()?.League?.Name ?? string.Empty;

    // Calculate current date, previous month and next month for navigation
    // Use last day of month for monthly navigation (aligns with Player page rating history)
    var currentDate = string.IsNullOrEmpty(Model.ByDate) 
        ? DateTime.Now 
        : DateTime.ParseExact(Model.ByDate, "dd/MM/yyyy", null);
    // Last day of previous month
    var prevMonthLastDay = new DateTime(currentDate.Year, currentDate.Month, 1).AddDays(-1);
    // Last day of next month
    var nextMonthLastDay = new DateTime(currentDate.Year, currentDate.Month, 1).AddMonths(2).AddDays(-1);
    var prevMonthStr = prevMonthLastDay.ToString("dd/MM/yyyy");
    var nextMonthStr = nextMonthLastDay.ToString("dd/MM/yyyy");
    var currentDateStr = currentDate.ToString("dd/MM/yyyy");
    var isViewingToday = currentDate.Date == DateTime.Now.Date;
    
    // Check if we have comparison data
    var hasComparison = Model.ComparisonDate.HasValue && Model.PreviousRatings.Any();
    var comparisonDateStr = Model.ComparisonDate?.ToString("dd/MM") ?? "";
    
    // Localized strings for NEW and RET
    var newLabel = @LocString[nameof(LocalizationKey.New)].Value;
    var retLabel = @LocString[nameof(LocalizationKey.Returning)].Value;
    
    // Helper to format position change (NEW for new players, RET for returning after inactivity, arrows for changes, empty for no change)
    string FormatPositionChange(int currentPos, int? prevPos, bool wasRankedBefore)
    {
        if (!prevPos.HasValue)
        {
            // Player not in previous rankings
            // - NEW: First time being ranked (including after completing performance estimation)
            // - RET: Was ranked before but dropped off due to inactivity, now returning
            if (wasRankedBefore)
                return $"<span style=\"color: #fd7e14; font-size: 0.85em;\">{retLabel}</span>";
            return $"<span style=\"color: #17a2b8; font-size: 0.85em;\">{newLabel}</span>";
        }
        var diff = prevPos.Value - currentPos; // positive = moved up
        if (diff > 0) return $"<span style=\"color: #28a745;\">↑{diff}</span>";
        if (diff < 0) return $"<span style=\"color: #dc3545;\">↓{Math.Abs(diff)}</span>";
        return ""; // No change - show empty
    }
    
    // Helper to format rating change (empty if no change or very small change)
    string FormatRatingChange(double currentRating, double? prevRating)
    {
        if (!prevRating.HasValue) return "";
        var diff = currentRating - prevRating.Value;
        if (Math.Abs(diff) < 0.1) return ""; // No significant change - show empty
        if (diff > 0) return $"<span style=\"color: #28a745;\">+{diff:F1}</span>";
        return $"<span style=\"color: #dc3545;\">{diff:F1}</span>";
    }
}

<h3>@ViewData["Title"]</h3>

<form asp-action="Rating" method="get" class="mb-4">
    <input type="hidden" name="id" value="@Model.LeagueId" />
    <input type="hidden" id="swaOnlyHidden" name="swaOnly" value="@(Model.SwaOnly ? "true" : "false")" />
    <div style="display: inline-flex; flex-wrap: nowrap; gap: 4px; align-items: center;">
        <a href="@Url.Action("Rating", new { id = Model.LeagueId, byDate = prevMonthStr, swaOnly = Model.SwaOnly })" class="btn btn-outline-primary">◀ @prevMonthLastDay.ToString("MMM", System.Globalization.CultureInfo.CurrentUICulture)</a>
        <input type="text" name="byDate" value="@currentDateStr" class="form-control text-center" style="width: 110px;" placeholder="dd/MM/yyyy" />
        <button type="submit" class="btn btn-primary">@LocString[nameof(LocalizationKey.Go)]</button>
        @if (nextMonthLastDay <= DateTime.Now)
        {
            <a href="@Url.Action("Rating", new { id = Model.LeagueId, byDate = nextMonthStr, swaOnly = Model.SwaOnly })" class="btn btn-outline-primary">@nextMonthLastDay.ToString("MMM", System.Globalization.CultureInfo.CurrentUICulture) ▶</a>
        }
        else
        {
            <span class="btn btn-outline-secondary disabled">@nextMonthLastDay.ToString("MMM", System.Globalization.CultureInfo.CurrentUICulture) ▶</span>
        }
        @if (!isViewingToday)
        {
            <a href="@Url.Action("Rating", new { id = Model.LeagueId, swaOnly = Model.SwaOnly })" class="btn btn-success">@LocString[nameof(LocalizationKey.Today)]</a>
        }
        <a href="@Url.Action("Rating", new { id = Model.LeagueId, byDate = Model.ByDate, swaOnly = Model.SwaOnly, refresh = true })" class="btn btn-outline-secondary" title="Reload data from database">⟳</a>
    </div>
    @if (Model.IsSgLeague)
    {
        <div class="mt-2" style="display: inline-flex; gap: 16px; align-items: center;">
            <div class="form-check form-switch" style="display: flex; align-items: center; gap: 6px;">
                <input class="form-check-input" type="checkbox" id="swaOnlyToggle" @(Model.SwaOnly ? "checked" : "") onchange="document.getElementById('swaOnlyHidden').value = this.checked; this.form.submit();" style="cursor: pointer;">
                <label class="form-check-label" for="swaOnlyToggle" style="cursor: pointer; white-space: nowrap;">@LocString[nameof(LocalizationKey.SWATournamentsOnly)]</label>
            </div>
        </div>
    }
</form>

<div class="table-responsive">
    <table class="table table-striped">
        <tr>
            <th style="@(hasComparison ? "padding-right: 2px;" : "")">
                №
            </th>
            @if (hasComparison)
            {
                <th title="Position change since @comparisonDateStr" style="text-align: center; padding-left: 2px;">↑↓</th>
            }
            <th>
                @LocString[nameof(LocalizationKey.DisplayName)]
            </th>
            <th>
                @LocString[nameof(LocalizationKey.BirthYear)]
            </th>
            <th>
                @LocString[nameof(LocalizationKey.Ranking)]
            </th>
            @{ var statIndex = 0; }
            @foreach (var item in Model.Stats)
            {
                <th style="@(hasComparison && statIndex == 0 ? "padding-right: 2px;" : "")">
                    @LocString[item.NameLocalizationKey]
                </th>
                @if (hasComparison && statIndex == 0)
                {
                    <th title="Rating change since @comparisonDateStr" style="text-align: center; padding-left: 2px;">+/-</th>
                }
                statIndex++;
            }
        </tr>

        @{ var currentPosition = 0; }
        @foreach (var item in Model.Users)
        {
            var isFemale = item.DisplayName?.Contains("♀") ?? false;
            var prevRating = Model.PreviousRatings.TryGetValue(item.Id, out var pr) ? (double?)pr : null;
            var prevPosition = Model.PreviousPositions.TryGetValue(item.Id, out var pp) ? (int?)pp : null;
            var currentRating = double.TryParse(Model.Stats.First().GetResult(item), out var cr) ? cr : 0;
            // Player is "returning" only if they were previously ranked (had a position) but dropped off
            // Players completing performance estimation have ratings but no previous position - they're NEW
            var wasRankedBefore = prevPosition.HasValue;
            var isProPlayer = item.IsProPlayer;
            // Pro players show "Pro", others get sequential position numbers
            string positionDisplay;
            if (isProPlayer)
            {
                positionDisplay = "Pro";
            }
            else
            {
                currentPosition++;
                positionDisplay = currentPosition.ToString();
            }
            <tr>
                <td style="@(hasComparison ? "padding-right: 2px;" : "")">
                    @positionDisplay
                </td>
                @if (hasComparison)
                {
                    <td style="text-align: center; white-space: nowrap; font-size: 0.9em; padding-left: 2px;">
                        @if (!isProPlayer)
                        {
                            @Html.Raw(FormatPositionChange(currentPosition, prevPosition, wasRankedBefore))
                        }
                    </td>
                }
                <td>
                    <a href="@Url.Action("Player", new { id = Model.LeagueId, playerId = item.Id, swaOnly = Model.SwaOnly, })" style="@(isFemale ? "color: #d63384;" : "")">@item.DisplayName</a>
                </td>
                <td>
                    @item.BirthYearU18
                </td>
                <td>
                    @item.RankingBeforeCutoffDate.ToUpper()
                </td>
                @{ var userStatIndex = 0; }
                @foreach (var res in Model.Stats)
                {
                    <td style="@(hasComparison && userStatIndex == 0 ? "padding-right: 2px;" : "")">
                        @res.GetResult(item)
                    </td>
                    @if (hasComparison && userStatIndex == 0)
                    {
                        <td style="text-align: center; white-space: nowrap; font-size: 0.9em; padding-left: 2px;">
                            @if (wasRankedBefore)
                            {
                                @Html.Raw(FormatRatingChange(currentRating, prevRating))
                            }
                        </td>
                    }
                    userStatIndex++;
                }
            </tr>
        }

        @if (Model.NonLocalUsers.Any())
        {
            <tr><td colspan="@(hasComparison ? 12 : 10)" style="background-color: #f0f0f0; font-weight: bold; padding: 8px;">@LocString[nameof(LocalizationKey.NonLocalPlayers)]</td></tr>
            @foreach (var item in Model.NonLocalUsers)
            {
            var isFemale = item.DisplayName?.Contains("♀") ?? false;
            var prevRating = Model.PreviousRatings.TryGetValue(item.Id, out var pr) ? (double?)pr : null;
            var currentRating = double.TryParse(Model.Stats.First().GetResult(item), out var cr) ? cr : 0;
            <tr style="background-color: #fafafa;">
                <td style="color: #888; @(hasComparison ? "padding-right: 2px;" : "")">-</td>
                @if (hasComparison)
                {
                    <td style="padding-left: 2px;"></td>
                }
                <td>
                    <a href="@Url.Action("Player", new { id = Model.LeagueId, playerId = item.Id, swaOnly = Model.SwaOnly, })" style="@(isFemale ? "color: #d63384;" : "")">@item.DisplayName</a>
                </td>
                <td>@item.BirthYearU18</td>
                <td>@item.RankingBeforeCutoffDate.ToUpper()</td>
                @{ var nlStatIndex = 0; }
                @foreach (var res in Model.Stats)
                {
                    <td style="@(hasComparison && nlStatIndex == 0 ? "padding-right: 2px;" : "")">@res.GetResult(item)</td>
                    @if (hasComparison && nlStatIndex == 0)
                    {
                        <td style="text-align: center; white-space: nowrap; font-size: 0.9em; padding-left: 2px;">
                            @Html.Raw(FormatRatingChange(currentRating, prevRating))
                        </td>
                    }
                    nlStatIndex++;
                }
            </tr>
            }
        }

        @if (Model.InactiveUsers.Any())
        {
            <tr><td colspan="@(hasComparison ? 12 : 10)" style="background-color: #f5f5f5; font-weight: bold; padding: 8px;">@LocString[nameof(LocalizationKey.InactivePlayers)]</td></tr>
            @foreach (var item in Model.InactiveUsers)
            {
            var isFemale = item.DisplayName?.Contains("♀") ?? false;
            var prevRating = Model.PreviousRatings.TryGetValue(item.Id, out var pr) ? (double?)pr : null;
            var currentRating = double.TryParse(Model.Stats.First().GetResult(item), out var cr) ? cr : 0;
            <tr style="background-color: #fafafa;">
                <td style="color: #999; @(hasComparison ? "padding-right: 2px;" : "")">-</td>
                @if (hasComparison)
                {
                    <td style="padding-left: 2px;"></td>
                }
                <td>
                    <a href="@Url.Action("Player", new { id = Model.LeagueId, playerId = item.Id, swaOnly = Model.SwaOnly, })" style="@(isFemale ? "color: #d63384;" : "")">@item.DisplayName</a>
                </td>
                <td>@item.BirthYearU18</td>
                <td>@item.RankingBeforeCutoffDate.ToUpper()</td>
                @{ var inStatIndex = 0; }
                @foreach (var res in Model.Stats)
                {
                    <td style="color: #999; @(hasComparison && inStatIndex == 0 ? "padding-right: 2px;" : "")">@res.GetResult(item)</td>
                    @if (hasComparison && inStatIndex == 0)
                    {
                        <td style="text-align: center; white-space: nowrap; font-size: 0.9em; padding-left: 2px;">
                            @Html.Raw(FormatRatingChange(currentRating, prevRating))
                        </td>
                    }
                    inStatIndex++;
                }
            </tr>
            }
        }

    </table>
</div>

<div class="table-responsive">
    <table class="table table-striped">
        @foreach (var item in Model.PromotedPlayers)
        {
            <tr>
                <td>
                    @item.ShorterName @item.Promotion
                </td>
            </tr>
        }

    </table>
</div>

<h3>@LocString[nameof(LocalizationKey.LastMatches)]</h3>
<div class="table-responsive">
    <table class="table table-striped table-responsive">
        <tr>
            <th>
                @LocString[nameof(LocalizationKey.Match)]
            </th>
            <th>
                @LocString[nameof(LocalizationKey.FirstPlayer)]
            </th>
            <th>
                @LocString[nameof(LocalizationKey.SecondPlayer)]
            </th>
            <th>
                @LocString[nameof(LocalizationKey.ShiftRating)]
            </th>
            <th>
                @LocString[nameof(LocalizationKey.Date)]
            </th>
        </tr>

        @foreach (var item in Model.LastMatches)
        {
            <tr>
                <td>
                    @if (item.TournamentId.HasValue && item.Tournament != null)
                    {
                        <a asp-controller="Tournaments" asp-action="Details" asp-route-id="@item.TournamentId">@item.Tournament.FullName</a>
                        @if (item.Round.HasValue)
                        {
                            <text> R@(item.Round)</text>
                        }
                    }
                    else if (!string.IsNullOrEmpty(item.MatchName))
                    {
                        @item.MatchName
                    }
                </td>
                <td>
                    @item.FirstPlayer.DisplayName (@item.OldFirstPlayerRating)
                </td>
                <td>
                    @item.SecondPlayer.DisplayName (@item.OldSecondPlayerRating)
                </td>
                <td>
                    @item.ShiftRating
                </td>
                <td>
                    @item.StrDate
                </td>
            </tr>
        }
    </table>
</div>
