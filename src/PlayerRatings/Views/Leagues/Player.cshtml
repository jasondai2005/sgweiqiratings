@using PlayerRatings.Localization
@using PlayerRatings.Models
@using PlayerRatings.ViewModels.Player
@model PlayerRatings.ViewModels.Player.PlayerRatingHistoryViewModel

@{
    ViewData["Title"] = Model.Player.DisplayName;
    var sortedRatings = Model.MonthlyRatings.OrderBy(r => r.Month).ToList();
    var playerRankings = Model.Player.Rankings?.OrderByDescending(r => r.RankingDate ?? DateTimeOffset.MinValue).ToList() 
        ?? new List<PlayerRanking>();
}

<div class="row">
    <div class="col-md-8">
        <h3 id="playerDisplayName">@Model.Player.DisplayName <span style="font-size: 0.6em; color: #999; font-weight: normal;">@Model.Player.UserName</span></h3>
        
        <!-- Player Info Section -->
        <div class="panel panel-default" style="margin-bottom: 15px;">
            <div class="panel-heading" style="display: flex; justify-content: space-between; align-items: center;">
                <span><strong>@LocString[nameof(LocalizationKey.PlayerInformation)]</strong></span>
                <button class="btn btn-sm btn-primary" type="button" data-toggle="collapse" data-target="#editPlayerInfo">
                    @LocString[nameof(LocalizationKey.Edit)]
                </button>
            </div>
            <div class="panel-body">
                <div class="row">
                    @if (!string.IsNullOrEmpty(Model.Player.Photo))
                    {
                    <div class="col-xs-3 col-sm-2" id="playerPhotoContainer">
                        <img id="playerPhoto" src="@(Model.Player.Photo)@(Model.Player.Photo.Contains("?") ? "&" : "?")v=@DateTime.UtcNow.Ticks" alt="@Model.Player.DisplayName" style="max-width: 120px; max-height: 120px; border-radius: 8px; cursor: pointer;" onclick="showPhotoModal(this.src)" title="Click to enlarge" />
                    </div>
                    }
                    <div class="@(string.IsNullOrEmpty(Model.Player.Photo) ? "col-xs-12" : "col-xs-9 col-sm-10")" id="playerInfoContainer">
                        <p style="margin-bottom: 5px; @(Model.Player.BirthYearValue == null ? "display:none;" : "")" id="birthYearRow"><strong>@LocString[nameof(LocalizationKey.BirthYear)]:</strong> <span id="displayBirthYear">@Model.Player.BirthYear</span></p>
                        <p style="margin-bottom: 5px;"><strong>@LocString[nameof(LocalizationKey.Residence)]:</strong> <span id="displayResidence">@(string.IsNullOrEmpty(Model.Player.CurrentResidence) ? "Singapore" : Model.Player.CurrentResidence)</span></p>
                        <p style="margin-bottom: 5px;"><strong>@LocString[nameof(LocalizationKey.CurrentRanking)]:</strong> @Model.Player.LatestRanking</p>
                        @if (Model.Position > 0)
                        {
                        <p style="margin-bottom: 5px;"><strong>@LocString[nameof(LocalizationKey.Position)]:</strong> @Model.PositionDisplay <span style="color: #666; font-size: 0.9em;">/ @Model.TotalPlayers</span></p>
                        }
                    </div>
                </div>
                
                @if (Model.TotalGames > 0)
                {
                <!-- Statistics Section -->
                <hr style="margin: 10px 0;" />
                <div class="row">
                    <div class="col-xs-12">
                        <strong>@LocString[nameof(LocalizationKey.Statistics)]</strong>
                    </div>
                </div>
                <div class="row" style="margin-top: 8px;">
                    <div class="col-sm-4">
                        <div style="color: #666;">@LocString[nameof(LocalizationKey.Overall)]:</div>
                        <div>
                            <strong>@Model.TotalGames</strong> @LocString[nameof(LocalizationKey.Games)]
                            <span style="color: #5cb85c; margin-left: 8px;">@Model.TotalWins W</span>
                            <span style="color: #d9534f; margin-left: 4px;">@Model.TotalLosses L</span>
                            <span style="margin-left: 8px; font-weight: bold;">(@Model.OverallWinRate.ToString("F1")%)</span>
                        </div>
                    </div>
                    @if (Model.CurrentYearGames > 0)
                    {
                    <div class="col-sm-4">
                        <div style="color: #666;">@LocString[nameof(LocalizationKey.ThisYear)] (@DateTime.Now.Year):</div>
                        <div>
                            <strong>@Model.CurrentYearGames</strong> @LocString[nameof(LocalizationKey.Games)]
                            <span style="color: #5cb85c; margin-left: 8px;">@Model.CurrentYearWins W</span>
                            <span style="color: #d9534f; margin-left: 4px;">@Model.CurrentYearLosses L</span>
                            <span style="margin-left: 8px; font-weight: bold;">(@Model.CurrentYearWinRate.ToString("F1")%)</span>
                        </div>
                    </div>
                    }
                    @if (Model.LastYearGames > 0)
                    {
                    <div class="col-sm-4">
                        <div style="color: #666;">@LocString[nameof(LocalizationKey.LastYear)] (@(DateTime.Now.Year - 1)):</div>
                        <div>
                            <strong>@Model.LastYearGames</strong> @LocString[nameof(LocalizationKey.Games)]
                            <span style="color: #5cb85c; margin-left: 8px;">@Model.LastYearWins W</span>
                            <span style="color: #d9534f; margin-left: 4px;">@Model.LastYearLosses L</span>
                            <span style="margin-left: 8px; font-weight: bold;">(@Model.LastYearWinRate.ToString("F1")%)</span>
                        </div>
                    </div>
                    }
                </div>
                }
                
                <!-- Edit Player Info Form (collapsed by default) -->
                <div class="collapse" id="editPlayerInfo" style="margin-top: 15px;">
                    <hr />
                    <form asp-action="UpdatePlayerInfo" method="post" id="playerInfoForm">
                        <input type="hidden" name="PlayerId" value="@Model.Player.Id" />
                        <input type="hidden" name="LeagueId" value="@Model.LeagueId" />
                        <div class="row">
                            <div class="col-md-6 form-group">
                                <label>@LocString[nameof(LocalizationKey.DisplayName)]</label>
                                <input type="text" class="form-control" name="DisplayName" value="@Model.Player.DisplayName" />
                            </div>
                            <div class="col-md-3 form-group">
                                <label>@LocString[nameof(LocalizationKey.BirthYear)]</label>
                                <input type="number" class="form-control" name="BirthYearValue" value="@Model.Player.BirthYearValue" min="1900" max="2100" />
                            </div>
                            <div class="col-md-3 form-group">
                                <label>@LocString[nameof(LocalizationKey.Residence)]</label>
                                <input type="text" class="form-control" name="Residence" value="@Model.Player.Residence" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 form-group">
                                <label>@LocString[nameof(LocalizationKey.PhotoUrl)]</label>
                                <input type="text" class="form-control" name="Photo" value="@Model.Player.Photo" placeholder="https://... or /pic/..." />
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <button type="submit" class="btn btn-primary btn-sm">@LocString[nameof(LocalizationKey.SaveChanges)]</button>
                            <button type="button" class="btn btn-default btn-sm" data-toggle="collapse" data-target="#editPlayerInfo">@LocString[nameof(LocalizationKey.Cancel)]</button>
                        </div>
                    </form>
                    
                    <!-- Photo Upload Form -->
                    <hr />
                    <form asp-action="UploadPlayerPhoto" method="post" enctype="multipart/form-data" id="photoUploadForm">
                        <input type="hidden" name="PlayerId" value="@Model.Player.Id" />
                        <input type="hidden" name="LeagueId" value="@Model.LeagueId" />
                        <div class="row">
                            <div class="col-md-6 form-group">
                                <label>@LocString[nameof(LocalizationKey.UploadPhoto)]</label>
                                <input type="file" class="form-control" name="photoFile" accept="image/*" required />
                                <p class="help-block" style="font-size: 0.85em; color: #666;">@LocString[nameof(LocalizationKey.SupportedFormats)]: JPG, PNG, GIF, WebP</p>
                            </div>
                            <div class="col-md-6 form-group" style="padding-top: 25px;">
                                <button type="submit" class="btn btn-primary btn-sm">@LocString[nameof(LocalizationKey.Upload)]</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Rankings Management Section (collapsed by default) -->
        <div style="margin-bottom: 15px;">
            <button class="btn btn-sm btn-default" type="button" data-toggle="collapse" data-target="#rankingManagement">
                ‚úèÔ∏è @LocString[nameof(LocalizationKey.EditRankingHistory)]
            </button>
        </div>
        <div class="collapse" id="rankingManagement">
            <div class="panel panel-default" style="margin-bottom: 15px;">
                <div class="panel-heading" style="display: flex; justify-content: space-between; align-items: center;">
                    <span><strong>@LocString[nameof(LocalizationKey.RankingHistory)]</strong></span>
                    <button class="btn btn-sm btn-success" type="button" data-toggle="collapse" data-target="#addRankingForm">
                        + @LocString[nameof(LocalizationKey.AddRanking)]
                    </button>
                </div>
                <div class="panel-body">
                    <!-- Add Ranking Form (collapsed by default) -->
                    <div class="collapse" id="addRankingForm" style="margin-bottom: 15px;">
                        <form asp-action="AddRanking" method="post" class="well">
                            <input type="hidden" name="PlayerId" value="@Model.Player.Id" />
                            <input type="hidden" name="LeagueId" value="@Model.LeagueId" />
                            <div class="row">
                                <div class="col-md-2 form-group">
                                    <label>@LocString[nameof(LocalizationKey.Ranking)]</label>
                                    <input type="text" class="form-control" name="Ranking" placeholder="e.g., 1D, 2K?" required pattern="^\d{1,2}[DKP]\??$" />
                                </div>
                                <div class="col-md-3 form-group">
                                    <label>@LocString[nameof(LocalizationKey.Organization)]</label>
                                    <select class="form-control" name="Organization" required>
                                        @foreach (var org in EditRankingViewModel.CommonOrganizations)
                                        {
                                            <option value="@org">@org</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-3 form-group">
                                    <label>@LocString[nameof(LocalizationKey.Date)]</label>
                                    <input type="date" class="form-control" name="RankingDate" />
                                </div>
                                <div class="col-md-4 form-group">
                                    <label>@LocString[nameof(LocalizationKey.Note)]</label>
                                    <input type="text" class="form-control" name="RankingNote" />
                                </div>
                            </div>
                            <div style="margin-top: 10px;">
                                <button type="submit" class="btn btn-success btn-sm">@LocString[nameof(LocalizationKey.AddRanking)]</button>
                                <button type="button" class="btn btn-default btn-sm" data-toggle="collapse" data-target="#addRankingForm">@LocString[nameof(LocalizationKey.Cancel)]</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Rankings List -->
                <p class="text-muted" style="margin-bottom: 0; @(playerRankings.Any() ? "display:none;" : "")" id="noRankingsMsg"></p>
                <div class="table-responsive" @(!playerRankings.Any() ? "style=\"display:none;\"" : "")>
                    <table class="table table-condensed table-hover" style="margin-bottom: 0;" id="rankingsTable">
                            <thead>
                                <tr>
                                    <th>@LocString[nameof(LocalizationKey.Ranking)]</th>
                                    <th>@LocString[nameof(LocalizationKey.Organization)]</th>
                                    <th>@LocString[nameof(LocalizationKey.Date)]</th>
                                    <th>@LocString[nameof(LocalizationKey.Note)]</th>
                                    <th style="width: 100px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var ranking in playerRankings)
                                {
                                    var editFormId = $"editRanking_{ranking.RankingId}";
                                    <tr data-ranking-id="@ranking.RankingId">
                                        <td>
                                            <span style="color: rgb(255, 99, 132); font-weight: bold;">@ranking.Ranking</span>
                                        </td>
                                        <td>@ranking.Organization</td>
                                        <td>@(ranking.RankingDate?.ToString("dd/MM/yyyy") ?? "-")</td>
                                        <td style="font-size: 0.85em; color: #666;">@ranking.RankingNote</td>
                                        <td>
                                            <button class="btn btn-primary btn-xs" type="button" data-toggle="collapse" data-target="#@editFormId" title="Edit">
                                                ‚úèÔ∏è
                                            </button>
                                            <form asp-action="DeleteRanking" method="post" style="display: inline;" class="delete-ranking-form">
                                                <input type="hidden" name="rankingId" value="@ranking.RankingId" />
                                                <input type="hidden" name="playerId" value="@Model.Player.Id" />
                                                <input type="hidden" name="leagueId" value="@Model.LeagueId" />
                                                <button type="submit" class="btn btn-danger btn-xs" title="Delete">üóëÔ∏è</button>
                                            </form>
                                        </td>
                                    </tr>
                                    <tr class="collapse" id="@editFormId">
                                        <td colspan="5" style="background-color: #f5f5f5; padding: 10px;">
                                            <form asp-action="EditRanking" method="post" class="edit-ranking-form">
                                                <input type="hidden" name="RankingId" value="@ranking.RankingId" />
                                                <input type="hidden" name="PlayerId" value="@Model.Player.Id" />
                                                <input type="hidden" name="LeagueId" value="@Model.LeagueId" />
                                                <div class="row">
                                                    <div class="col-md-2">
                                                        <input type="text" class="form-control input-sm" name="Ranking" value="@ranking.Ranking" required pattern="^\d{1,2}[DKP]\??$" />
                                                    </div>
                                                    <div class="col-md-2">
                                                        <select class="form-control input-sm" name="Organization" required>
                                                            @foreach (var org in EditRankingViewModel.CommonOrganizations)
                                                            {
                                                                var isSelected = ranking.Organization == org || 
                                                                    (string.IsNullOrEmpty(ranking.Organization) && org == "Other");
                                                                if (isSelected)
                                                                {
                                                                    <option value="@org" selected>@org</option>
                                                                }
                                                                else
                                                                {
                                                                    <option value="@org">@org</option>
                                                                }
                                                            }
                                                        </select>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <input type="date" class="form-control input-sm" name="RankingDate" value="@(ranking.RankingDate?.ToString("yyyy-MM-dd"))" />
                                                    </div>
                                                    <div class="col-md-3">
                                                        <input type="text" class="form-control input-sm" name="RankingNote" value="@ranking.RankingNote" />
                                                    </div>
                                                    <div class="col-md-3">
                                                        <button type="submit" class="btn btn-primary btn-xs">Save</button>
                                                        <button type="button" class="btn btn-default btn-xs" data-toggle="collapse" data-target="#@editFormId">Cancel</button>
                                                    </div>
                                                </div>
                                            </form>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@{

    // Build ranking labels for each month - show ranking when it changes
    // Use playerRankings from Rankings table directly

    // Get the first match date to identify early rankings
    var firstMatchDate = Model.MonthlyRatings.Any() 
        ? Model.MonthlyRatings.Min(r => r.Month) 
        : DateTime.MaxValue;

    // Map each month to list of rankings with full date and sort date (multiple promotions per month supported)
    var monthRankingLabels = new Dictionary<string, List<(string ranking, string date, DateTimeOffset sortDate, string org)>>();

    // Rankings before first match (to show at bottom of table)
    var earlyRankings = new List<(string ranking, string date, DateTimeOffset sortDate, string org)>();

    // Process all rankings from the Rankings table
    foreach (var ranking in playerRankings)
    {
        if (string.IsNullOrEmpty(ranking.Ranking))
            continue;

        // Format ranking with organization indicator using the centralized method
        string displayRanking = ApplicationUser.FormatRankingForDisplay(ranking);
        
        var rankingDate = ranking.RankingDate ?? DateTimeOffset.MinValue;
        var fullDate = rankingDate != DateTimeOffset.MinValue ? rankingDate.ToString("dd/MM/yyyy") : "";
        
        if (rankingDate == DateTimeOffset.MinValue)
        {
            // Rankings without known dates go to early rankings
            earlyRankings.Add((displayRanking, "", DateTimeOffset.MinValue, ranking.Organization ?? ""));
        }
        else
        {
            // Use end of month to match with MonthlyRatings.Month format
            var effectiveMonth = new DateTime(rankingDate.Year, rankingDate.Month, 1).AddMonths(1).AddSeconds(-1);
            var monthKey = effectiveMonth.ToString("MMM yyyy");
            
            // Check if this ranking is before the first match month (compare same month by using the month key)
            var firstMatchMonthKey = firstMatchDate.ToString("MMM yyyy");
            if (effectiveMonth < firstMatchDate && monthKey != firstMatchMonthKey)
            {
                earlyRankings.Add((displayRanking, fullDate, rankingDate, ranking.Organization ?? ""));
            }
            else
            {
                if (!monthRankingLabels.ContainsKey(monthKey))
                {
                    monthRankingLabels[monthKey] = new List<(string ranking, string date, DateTimeOffset sortDate, string org)>();
                }
                monthRankingLabels[monthKey].Add((displayRanking, fullDate, rankingDate, ranking.Organization ?? ""));
            }
        }
    }
    
    // For chart labels, combine multiple rankings into single string (sorted by date)
    var chartRankingLabels = monthRankingLabels.ToDictionary(
        kvp => kvp.Key,
        kvp => (
            ranking: string.Join(", ", kvp.Value.OrderBy(r => r.sortDate).Select(r => r.ranking)),
            date: string.Join(", ", kvp.Value.OrderBy(r => r.sortDate).Select(r => r.date))
        )
    );
}

<div class="mb-3" style="display: inline-flex; gap: 8px; align-items: center;">
    <a href="@Url.Action("Rating", new { id = Model.LeagueId, swaOnly = Model.SwaOnly })" class="btn btn-outline-secondary">‚Üê @LocString[nameof(LocalizationKey.BackToRating)]</a>
    <a href="@Url.Action("Player", new { id = Model.LeagueId, playerId = Model.Player.Id, swaOnly = Model.SwaOnly, refresh = true })" class="btn btn-outline-secondary" title="Reload data from database">‚ü≥</a>
    
    @if (!string.IsNullOrEmpty(Model.PreviousPlayerId) || !string.IsNullOrEmpty(Model.NextPlayerId))
    {
        <span style="margin-left: 16px; color: #666;">|</span>
        @if (!string.IsNullOrEmpty(Model.PreviousPlayerId))
        {
            <a href="@Url.Action("Player", new { id = Model.LeagueId, playerId = Model.PreviousPlayerId, swaOnly = Model.SwaOnly })" 
               class="btn btn-outline-primary btn-sm" title="@LocString[nameof(LocalizationKey.PreviousPlayer)]">
                ‚óÄ @LocString[nameof(LocalizationKey.Prev)]
            </a>
        }
        else
        {
            <button class="btn btn-outline-secondary btn-sm" disabled>‚óÄ @LocString[nameof(LocalizationKey.Prev)]</button>
        }
        @if (Model.Position > 0)
        {
            <span style="font-size: 0.9em; color: #666; min-width: 60px; text-align: center;">@Model.PositionDisplay</span>
        }
        else
        {
            <span style="font-size: 0.9em; color: #999; min-width: 60px; text-align: center; font-style: italic;">-</span>
        }
        @if (!string.IsNullOrEmpty(Model.NextPlayerId))
        {
            <a href="@Url.Action("Player", new { id = Model.LeagueId, playerId = Model.NextPlayerId, swaOnly = Model.SwaOnly })" 
               class="btn btn-outline-primary btn-sm" title="@LocString[nameof(LocalizationKey.NextPlayer)]">
                @LocString[nameof(LocalizationKey.Next)] ‚ñ∂
            </a>
        }
        else
        {
            <button class="btn btn-outline-secondary btn-sm" disabled>@LocString[nameof(LocalizationKey.Next)] ‚ñ∂</button>
        }
    }
</div>

@if (Model.IsSgLeague && Model.MonthlyRatings.Any())
{
<form asp-action="Player" method="get" class="mb-3">
    <input type="hidden" name="id" value="@Model.LeagueId" />
    <input type="hidden" name="playerId" value="@Model.Player.Id" />
    <input type="hidden" id="swaOnlyHidden" name="swaOnly" value="@(Model.SwaOnly ? "true" : "false")" />
    <div style="display: inline-flex; gap: 16px; align-items: center;">
        <div class="form-check form-switch" style="display: flex; align-items: center; gap: 6px;">
            <input class="form-check-input" type="checkbox" id="swaOnlyToggle" @(Model.SwaOnly ? "checked" : "") onchange="document.getElementById('swaOnlyHidden').value = this.checked; this.form.submit();" style="cursor: pointer;">
            <label class="form-check-label" for="swaOnlyToggle" style="cursor: pointer; white-space: nowrap;">@LocString[nameof(LocalizationKey.SWATournamentsOnly)]</label>
        </div>
    </div>
</form>
}

@if (Model.MonthlyRatings.Any())
{
<h4>@LocString[nameof(LocalizationKey.RatingHistoryChart)]</h4>
<div style="max-width: 800px; margin-bottom: 30px;">
    <canvas id="ratingChart"></canvas>
</div>
}

<h4>@LocString[nameof(LocalizationKey.MonthlyRatingHistory)]</h4>
<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>@LocString[nameof(LocalizationKey.Month)]</th>
                <th>‚Ññ</th>
                <th>@LocString[nameof(LocalizationKey.Rating)]</th>
                <th>@LocString[nameof(LocalizationKey.Matches)]</th>
                <th>@LocString[nameof(LocalizationKey.Ranking)]</th>
            </tr>
        </thead>
        <tbody>
            @{
                var positionCutoffDate = new DateTime(2024, 1, 1);
            }
            @foreach (var item in Model.MonthlyRatings.OrderByDescending(r => r.Month))
            {
                var hasRankings = monthRankingLabels.TryGetValue(item.MonthDisplay, out var rankingList);
                // Only show rows with matches, ranking changes, or promotion bonuses
                if (item.MatchesInMonth == 0 && !hasRankings && !item.HasPromotionBonus)
                {
                    continue;
                }
                var showPosition = item.Month >= positionCutoffDate && item.Position > 0;
                <tr>
                    <td>@item.MonthDisplay</td>
                    <td>@if (showPosition) { <span>@item.Position<span style="color: #999; font-size: 0.85em;">/@item.TotalPlayers</span></span> } else { <span>-</span> }</td>
                    <td>@item.RatingDisplay</td>
                    <td>
                        @if (item.MatchNames.Any())
                        {
                            @foreach (var matchName in item.MatchNames)
                            {
                                <div style="font-size: 0.85em;">@matchName</div>
                            }
                        }
                        else
                        {
                            <span>-</span>
                        }
                    </td>
                    <td>
                        @{
                            // Track which bonuses have been displayed to show orphans at the end
                            var displayedBonuses = new HashSet<int>();
                        }
                        @if (hasRankings)
                        {
                            @foreach (var rankingInfo in rankingList.OrderByDescending(r => r.sortDate))
                            {
                                <div>
                                    <span style="color: rgb(255, 99, 132); font-weight: bold;">@rankingInfo.ranking</span>
                                    <span style="color: #666; font-size: 0.85em;">(@rankingInfo.date)</span>
                                </div>
                                @if (item.HasPromotionBonus)
                                {
                                    // Match bonus to ranking by DATE (more reliable than matching ranking names)
                                    // The bonus was recorded with the ranking's date at calculation time
                                    for (int i = 0; i < item.PromotionBonuses.Count; i++)
                                    {
                                        var bonus = item.PromotionBonuses[i];
                                        // Match if bonus date equals ranking date
                                        if (bonus.PromotionDate.HasValue && 
                                            rankingInfo.date == bonus.PromotionDate.Value.ToString("dd/MM/yyyy"))
                                        {
                                            displayedBonuses.Add(i);
                                            var fromDisplay = ApplicationUser.FormatRankingForDisplay(bonus.FromRanking, bonus.FromOrg);
                                            var toDisplay = ApplicationUser.FormatRankingForDisplay(bonus.ToRanking, bonus.ToOrg);
                                            <div style="margin-left: 8px;">
                                                <span style="color: #5cb85c; font-size: 0.85em; font-weight: bold;" title="Promotion bonus applied">
                                                    +@bonus.BonusAmount.ToString("F1")
                                                </span>
                                                <span style="color: #888; font-size: 0.8em;">
                                                    (@fromDisplay‚Üí@toDisplay)
                                                </span>
                                            </div>
                                        }
                                    }
                                }
                            }
                        }
                        @if (item.HasPromotionBonus)
                        {
                            @* Show any orphan promotion bonuses (no matching ranking record) *@
                            for (int i = 0; i < item.PromotionBonuses.Count; i++)
                            {
                                if (!displayedBonuses.Contains(i))
                                {
                                    var bonus = item.PromotionBonuses[i];
                                    var fromDisplay = ApplicationUser.FormatRankingForDisplay(bonus.FromRanking, bonus.FromOrg);
                                    var toDisplay = ApplicationUser.FormatRankingForDisplay(bonus.ToRanking, bonus.ToOrg);
                                    <div>
                                        <span style="color: #5cb85c; font-size: 0.85em; font-weight: bold;" title="Promotion bonus applied">
                                            +@bonus.BonusAmount.ToString("F1")
                                        </span>
                                        <span style="color: #888; font-size: 0.8em;">
                                            (@fromDisplay‚Üí@toDisplay)
                                        </span>
                                    </div>
                                }
                            }
                        }
                    </td>
                </tr>
            }
            @{
                // For players with no matches, show their current ranking rating
                var preEntryRating = !Model.MonthlyRatings.Any() && Model.Player.Rankings != null && Model.Player.Rankings.Any()
                    ? Model.Player.GetRatingBeforeDate(DateTimeOffset.MaxValue).ToString()
                    : null;
                
                // Get matches before the first month shown in the rating history
                var preEntryMatches = new List<string>();
                if (Model.MonthlyRatings.Any())
                {
                    var firstRatedMonth = Model.MonthlyRatings.Min(r => r.Month);
                    preEntryMatches = Model.GameRecords
                        .Where(g => g.Date.Year < firstRatedMonth.Year || 
                                   (g.Date.Year == firstRatedMonth.Year && g.Date.Month < firstRatedMonth.Month))
                        .Select(g => g.MatchName)
                        .Distinct()
                        .Reverse()
                        .ToList();
                }
                
                // Only show Pre-entry row if there's something meaningful to display
                var showPreEntry = earlyRankings.Any() || preEntryMatches.Any() || preEntryRating != null;
            }
            @if (showPreEntry)
            {
                <tr style="background-color: #f8f9fa;">
                    <td style="color: #666; font-style: italic;">@LocString[nameof(LocalizationKey.PreEntry)]</td>
                    <td>-</td>
                    <td>@(preEntryRating ?? "-")</td>
                    <td>
                        @if (preEntryMatches.Any())
                        {
                            @foreach (var matchName in preEntryMatches)
                            {
                                <div style="font-size: 0.85em; color: #888;">@matchName</div>
                            }
                        }
                        else
                        {
                            <span>-</span>
                        }
                    </td>
                    <td>
                        @if (earlyRankings.Any())
                        {
                            @foreach (var rankingInfo in earlyRankings.OrderByDescending(r => r.sortDate))
                            {
                                <div>
                                    <span style="color: rgb(255, 99, 132); font-weight: bold;">@rankingInfo.ranking</span>
                                    @if (!string.IsNullOrEmpty(rankingInfo.date))
                                    {
                                        <span style="color: #666; font-size: 0.85em;">(@rankingInfo.date)</span>
                                    }
                                </div>
                            }
                        }
                        else
                        {
                            <span>-</span>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@{
    // Matches before this date are not included in rating calculations
    var ratingStartDate = new DateTimeOffset(2023, 1, 1, 0, 0, 0, TimeSpan.Zero);
    var hasOldMatches = Model.GameRecords.Any(g => g.Date < ratingStartDate);
}

<h4 class="mt-4">@LocString[nameof(LocalizationKey.GameRecords)]</h4>
@if (hasOldMatches)
{
    <p class="text-muted" style="font-size: 0.9em; margin-bottom: 10px;">
        <em>@LocString[nameof(LocalizationKey.MatchesBeforeNotIncluded)]</em>
    </p>
}
<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>@LocString[nameof(LocalizationKey.Date)]</th>
                <th>@LocString[nameof(LocalizationKey.Match)]</th>
                <th>@LocString[nameof(LocalizationKey.Opponent)]</th>
                <th>@LocString[nameof(LocalizationKey.Result)]</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var game in Model.GameRecords.OrderByDescending(g => g.Date))
            {
                var isOldMatch = game.Date < ratingStartDate;
                var isNotRated = game.Factor == 0;
                var isGrayedOut = isOldMatch || isNotRated;
                <tr style="@(isGrayedOut ? "opacity: 0.5; background-color: #f5f5f5;" : "")">
                    <td>@game.DateDisplay</td>
                    <td>
                        @game.MatchName
                        @if (isNotRated)
                        {
                            <span style="font-size: 0.75em; color: #999; margin-left: 4px; font-style: italic;">(@LocString[nameof(LocalizationKey.NotRated)])</span>
                        }
                    </td>
                    <td>
                        <a href="@Url.Action("Player", new { id = Model.LeagueId, playerId = game.OpponentId, swaOnly = Model.SwaOnly, })" style="@(isGrayedOut ? "color: #888;" : "")">@game.OpponentName</a>
                        @if (!string.IsNullOrEmpty(game.OpponentRanking))
                        {
                            <span style="font-size: 0.8em; color: #666;">@game.OpponentRanking</span>
                        }
                    </td>
                    <td style="color: @(isGrayedOut ? "#888" : game.Result == "Win" ? "green" : game.Result == "Loss" ? "red" : "gray"); font-weight: bold;">
                        @game.Result
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@section Scripts {
@if (Model.MonthlyRatings.Any())
{
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script>
        const ctx = document.getElementById('ratingChart').getContext('2d');
        
        // All months for continuous axis
        // Position data only shown from Jan 2024 onwards (too few players before that)
        const positionCutoff = new Date(2024, 0, 1);
        const labels = [@Html.Raw(string.Join(",", sortedRatings.Select(r => $"'{r.MonthDisplay}'")))];
        const ratings = [@Html.Raw(string.Join(",", sortedRatings.Select(r => r.Rating.ToString("F1", System.Globalization.CultureInfo.InvariantCulture))))];
        const positions = [@Html.Raw(string.Join(",", sortedRatings.Select(r => r.Month >= new DateTime(2024, 1, 1) && r.Position > 0 ? r.Position.ToString() : "null")))];
        const totalPlayers = [@Html.Raw(string.Join(",", sortedRatings.Select(r => r.Month >= new DateTime(2024, 1, 1) && r.TotalPlayers > 0 ? r.TotalPlayers.ToString() : "null")))];
        
        // Track which months have activity (matches or ranking changes)
        const hasActivity = [@Html.Raw(string.Join(",", sortedRatings.Select(r => (r.MatchesInMonth > 0 || monthRankingLabels.ContainsKey(r.MonthDisplay)).ToString().ToLower())))];
        
        // Ranking labels for each month (only where ranking changed)
        // Contains ranking and full date (combined if multiple)
        const rankingLabels = {
            @Html.Raw(string.Join(",", chartRankingLabels.Select(kvp => $"'{kvp.Key}': {{ ranking: '{kvp.Value.ranking}', date: '{kvp.Value.date}' }}")))
        };
        
        // Calculate min/max for better Y-axis scaling
        const minRating = Math.min(...ratings);
        const maxRating = Math.max(...ratings);
        const padding = (maxRating - minRating) * 0.1 || 50;
        
        // Calculate position axis range (inverted - lower position number = better)
        const validPositions = positions.filter(p => p !== null);
        const maxPosition = validPositions.length > 0 ? Math.max(...validPositions) : 100;
        const minPosition = validPositions.length > 0 ? Math.min(...validPositions) : 1;
        
        // Register the datalabels plugin
        Chart.register(ChartDataLabels);
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Rating',
                    data: ratings,
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    fill: true,
                    tension: 0,
                    yAxisID: 'y',
                    pointRadius: function(context) {
                        const idx = context.dataIndex;
                        if (!hasActivity[idx]) return 0; // Hide point for inactive months
                        const label = labels[idx];
                        return rankingLabels[label] ? 8 : 4;
                    },
                    pointBackgroundColor: function(context) {
                        const label = labels[context.dataIndex];
                        return rankingLabels[label] ? 'rgb(255, 99, 132)' : 'rgb(54, 162, 235)';
                    },
                    pointBorderColor: function(context) {
                        const label = labels[context.dataIndex];
                        return rankingLabels[label] ? 'rgb(255, 99, 132)' : 'rgb(54, 162, 235)';
                    },
                    pointHoverRadius: 8
                },
                {
                    label: 'Position',
                    data: positions,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0,
                    spanGaps: true,
                    yAxisID: 'y1',
                    pointRadius: function(context) {
                        const idx = context.dataIndex;
                        if (!hasActivity[idx] || positions[idx] === null) return 0;
                        return 4;
                    },
                    pointBackgroundColor: 'rgb(75, 192, 192)',
                    pointBorderColor: 'rgb(75, 192, 192)',
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const idx = context.dataIndex;
                                const label = labels[idx];
                                if (context.dataset.label === 'Rating') {
                                    const rankingInfo = rankingLabels[label];
                                    let result = 'Rating: ' + context.parsed.y.toFixed(1);
                                    if (rankingInfo) {
                                        result += ' (Promoted to ' + rankingInfo.ranking + ' on ' + rankingInfo.date + ')';
                                    }
                                    return result;
                                } else if (context.dataset.label === 'Position') {
                                    const pos = positions[idx];
                                    const total = totalPlayers[idx];
                                    if (pos !== null && total !== null) {
                                        return 'Position: ‚Ññ' + pos + ' / ' + total;
                                    }
                                    return null;
                                }
                                return context.parsed.y;
                            }
                        }
                    },
                    datalabels: {
                        align: 'top',
                        anchor: 'end',
                        offset: 4,
                        font: {
                            weight: 'bold',
                            size: 10
                        },
                        color: 'rgb(255, 99, 132)',
                        formatter: function(value, context) {
                            // Only show ranking labels for the Rating dataset
                            if (context.dataset.label !== 'Rating') return null;
                            const label = labels[context.dataIndex];
                            const rankingInfo = rankingLabels[label];
                            if (rankingInfo) {
                                return rankingInfo.ranking + '\n(' + rankingInfo.date + ')';
                            }
                            return null;
                        },
                        display: function(context) {
                            if (context.dataset.label !== 'Rating') return false;
                            const label = labels[context.dataIndex];
                            return !!rankingLabels[label];
                        },
                        textAlign: 'center'
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        position: 'left',
                        min: Math.floor(minRating - padding),
                        max: Math.ceil(maxRating + padding),
                        title: {
                            display: true,
                            text: 'Rating'
                        }
                    },
                    y1: {
                        type: 'linear',
                        position: 'right',
                        reverse: true, // Lower position number = better, so at top
                        min: Math.max(0.7, minPosition - 5), // Start from 0.7 or below min position for spacing
                        max: maxPosition + 5,
                        title: {
                            display: true,
                            text: 'Position (‚Ññ)'
                        },
                        grid: {
                            drawOnChartArea: false // Don't show grid lines for this axis
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Month'
                        }
                    }
                }
            }
        });
    </script>
}
    <script>
        // AJAX form handling for player info and rankings
        $(document).ready(function() {
            // Show status message
            function showMessage(message, isSuccess) {
                var alertClass = isSuccess ? 'alert-success' : 'alert-danger';
                var $alert = $('<div class="alert ' + alertClass + '" style="position: fixed; top: 60px; right: 20px; z-index: 9999; padding: 10px 20px;">' + message + '</div>');
                $('body').append($alert);
                setTimeout(function() { $alert.fadeOut(function() { $(this).remove(); }); }, 2000);
            }
            
            // Handle player info form
            $('#playerInfoForm').on('submit', function(e) {
                e.preventDefault();
                var $form = $(this);
                var $btn = $form.find('button[type="submit"]');
                $btn.prop('disabled', true).text('Saving...');
                
                $.ajax({
                    url: $form.attr('action'),
                    type: 'POST',
                    data: $form.serialize(),
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    success: function(response) {
                        if (response.success) {
                            showMessage(response.message, true);
                            // Update displayed values
                            var displayName = $form.find('[name="DisplayName"]').val();
                            if (displayName) {
                                $('#playerDisplayName').text(displayName);
                            }
                            var birthYear = $form.find('[name="BirthYearValue"]').val();
                            if (birthYear) {
                                $('#displayBirthYear').text(birthYear);
                                $('#birthYearRow').show();
                            } else {
                                $('#birthYearRow').hide();
                            }
                            // Extract current residence (first entry without year)
                            var fullResidence = $form.find('[name="Residence"]').val() || '';
                            var currentResidence = 'Singapore';
                            if (fullResidence) {
                                var firstEntry = fullResidence.split(';')[0].trim();
                                var parenIndex = firstEntry.lastIndexOf('(');
                                currentResidence = parenIndex > 0 ? firstEntry.substring(0, parenIndex).trim() : firstEntry;
                            }
                            $('#displayResidence').text(currentResidence || 'Singapore');
                            var photoUrl = $form.find('[name="Photo"]').val();
                            var $photoContainer = $('#playerPhotoContainer');
                            var $infoContainer = $('#playerInfoContainer');
                            if (photoUrl) {
                                if ($photoContainer.length === 0) {
                                    // Create photo container if it doesn't exist
                                    $infoContainer.before('<div class="col-xs-3 col-sm-2" id="playerPhotoContainer"><img id="playerPhoto" src="' + photoUrl + '" style="max-width: 120px; max-height: 120px; border-radius: 8px; cursor: pointer;" onclick="showPhotoModal(this.src)" title="Click to enlarge" /></div>');
                                    $infoContainer.removeClass('col-xs-12').addClass('col-xs-9 col-sm-10');
                                } else {
                                    $('#playerPhoto').attr('src', photoUrl);
                                }
                            } else {
                                // Remove photo container if URL is cleared
                                $photoContainer.remove();
                                $infoContainer.removeClass('col-xs-9 col-sm-10').addClass('col-xs-12');
                            }
                        } else {
                            showMessage(response.message || 'Error saving', false);
                        }
                    },
                    error: function() { showMessage('Error saving', false); },
                    complete: function() { $btn.prop('disabled', false).text('Save Changes'); }
                });
            });
            
            // Handle add ranking form
            $('#addRankingForm form').on('submit', function(e) {
                e.preventDefault();
                var $form = $(this);
                var $btn = $form.find('button[type="submit"]');
                $btn.prop('disabled', true).text('Adding...');
                
                $.ajax({
                    url: $form.attr('action'),
                    type: 'POST',
                    data: $form.serialize(),
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    success: function(response) {
                        if (response.success) {
                            showMessage(response.message, true);
                            // Add new row to table
                            var r = response.ranking;
                            var newRow = '<tr data-ranking-id="' + r.rankingId + '">' +
                                '<td><span style="color: rgb(255, 99, 132); font-weight: bold;">' + r.rankingGrade + '</span></td>' +
                                '<td>' + r.organization + '</td>' +
                                '<td>' + r.date + '</td>' +
                                '<td style="font-size: 0.85em; color: #666;">' + r.note + '</td>' +
                                '<td><button class="btn btn-danger btn-xs delete-ranking-btn" data-ranking-id="' + r.rankingId + '">üóëÔ∏è</button></td>' +
                                '</tr>';
                            $('#rankingsTable tbody').prepend(newRow);
                            $('#noRankingsMsg').hide();
                            $('#rankingsTable').show();
                            // Clear form
                            $form[0].reset();
                            $('#addRankingForm').collapse('hide');
                        } else {
                            showMessage(response.message || 'Error adding', false);
                        }
                    },
                    error: function() { showMessage('Error adding ranking', false); },
                    complete: function() { $btn.prop('disabled', false).text('Add Ranking'); }
                });
            });
            
            // Handle edit ranking forms
            $(document).on('submit', '.edit-ranking-form', function(e) {
                e.preventDefault();
                var $form = $(this);
                var $btn = $form.find('button[type="submit"]');
                var rankingId = $form.find('[name="RankingId"]').val();
                $btn.prop('disabled', true).text('Saving...');
                
                $.ajax({
                    url: $form.attr('action'),
                    type: 'POST',
                    data: $form.serialize(),
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    success: function(response) {
                        if (response.success) {
                            showMessage(response.message, true);
                            // Update the row
                            var r = response.ranking;
                            var $row = $('tr[data-ranking-id="' + rankingId + '"]');
                            $row.find('td:eq(0) span').text(r.rankingGrade);
                            $row.find('td:eq(1)').text(r.organization);
                            $row.find('td:eq(2)').text(r.date);
                            $row.find('td:eq(3)').text(r.note);
                            // Collapse the edit form
                            $('#editRanking_' + rankingId).collapse('hide');
                        } else {
                            showMessage(response.message || 'Error saving', false);
                        }
                    },
                    error: function() { showMessage('Error saving ranking', false); },
                    complete: function() { $btn.prop('disabled', false).text('Save'); }
                });
            });
            
            // Handle delete ranking
            $(document).on('submit', '.delete-ranking-form', function(e) {
                e.preventDefault();
                if (!confirm('Delete this ranking?')) return;
                
                var $form = $(this);
                var rankingId = $form.find('[name="rankingId"]').val();
                
                $.ajax({
                    url: $form.attr('action'),
                    type: 'POST',
                    data: $form.serialize(),
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    success: function(response) {
                        if (response.success) {
                            showMessage(response.message, true);
                            // Remove the row and edit form row
                            $('tr[data-ranking-id="' + rankingId + '"]').remove();
                            $('#editRanking_' + rankingId).closest('tr').remove();
                        } else {
                            showMessage(response.message || 'Error deleting', false);
                        }
                    },
                    error: function() { showMessage('Error deleting ranking', false); }
                });
            });
            
            // Handle photo upload
            $('#photoUploadForm').on('submit', function(e) {
                e.preventDefault();
                var $form = $(this);
                var $btn = $form.find('button[type="submit"]');
                var formData = new FormData(this);
                
                $btn.prop('disabled', true).text('Uploading...');
                
                $.ajax({
                    url: $form.attr('action'),
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    success: function(response) {
                        if (response.success) {
                            showMessage(response.message, true);
                            // Update photo display
                            var $photoContainer = $('#playerPhotoContainer');
                            var $infoContainer = $('#playerInfoContainer');
                            var photoUrl = response.photoUrl + '?t=' + Date.now();
                            if ($photoContainer.length === 0) {
                                // Create container if it doesn't exist - insert before info container
                                $infoContainer.before('<div class="col-xs-3 col-sm-2" id="playerPhotoContainer"><img id="playerPhoto" src="' + photoUrl + '" style="max-width: 120px; max-height: 120px; border-radius: 8px; cursor: pointer;" onclick="showPhotoModal(this.src)" title="Click to enlarge" /></div>');
                                $infoContainer.removeClass('col-xs-12').addClass('col-xs-9 col-sm-10');
                            } else {
                                $('#playerPhoto').attr('src', photoUrl);
                            }
                            // Update the URL input
                            $('input[name="Photo"]').val(response.photoUrl);
                            // Clear the file input
                            $form.find('input[type="file"]').val('');
                        } else {
                            showMessage(response.message || 'Error uploading', false);
                        }
                    },
                    error: function() { showMessage('Error uploading photo', false); },
                    complete: function() { $btn.prop('disabled', false).text('@LocString[nameof(LocalizationKey.Upload)]'); }
                });
            });
        });
        
        // Photo modal functionality
        function showPhotoModal(src) {
            var modal = document.getElementById('photoModal');
            var modalImg = document.getElementById('photoModalImg');
            modal.style.display = 'flex';
            modalImg.src = src;
        }
        
        function closePhotoModal() {
            document.getElementById('photoModal').style.display = 'none';
        }
        
        // Close modal when clicking outside the image
        document.addEventListener('DOMContentLoaded', function() {
            var modal = document.getElementById('photoModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closePhotoModal();
                    }
                });
            }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closePhotoModal();
            }
        });
    </script>
}

<!-- Photo Modal -->
<div id="photoModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); z-index: 9999; justify-content: center; align-items: center; cursor: pointer;">
    <span style="position: absolute; top: 20px; right: 30px; color: #fff; font-size: 35px; font-weight: bold; cursor: pointer;" onclick="closePhotoModal()">&times;</span>
    <img id="photoModalImg" src="" alt="Player Photo" style="max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5);" />
</div>

