@using PlayerRatings.Localization
@using PlayerRatings.ViewModels.Player
@model PlayerRatings.ViewModels.Player.PlayerRatingHistoryViewModel

@{
    ViewData["Title"] = Model.Player.DisplayName + " - Rating History";
    var sortedRatings = Model.MonthlyRatings.OrderBy(r => r.Month).ToList();
    var playerRankings = Model.Player.Rankings?.OrderByDescending(r => r.RankingDate ?? DateTimeOffset.MinValue).ToList() 
        ?? new List<PlayerRatings.Models.PlayerRanking>();
}

<div class="row">
    <div class="col-md-8">
        <h3 id="playerDisplayName">@Model.Player.DisplayName</h3>
        
        <!-- Player Info Section -->
        <div class="panel panel-default" style="margin-bottom: 15px;">
            <div class="panel-heading" style="display: flex; justify-content: space-between; align-items: center;">
                <span><strong>@LocString[nameof(LocalizationKey.PlayerInformation)]</strong></span>
                <button class="btn btn-sm btn-primary" type="button" data-toggle="collapse" data-target="#editPlayerInfo">
                    @LocString[nameof(LocalizationKey.Edit)]
                </button>
            </div>
            <div class="panel-body">
                <div class="row">
                    @if (!string.IsNullOrEmpty(Model.Player.Photo))
                    {
                    <div class="col-xs-3 col-sm-2" id="playerPhotoContainer">
                        <img id="playerPhoto" src="@Model.Player.Photo" alt="@Model.Player.DisplayName" style="max-width: 120px; max-height: 120px; border-radius: 8px;" />
                    </div>
                    }
                    <div class="@(string.IsNullOrEmpty(Model.Player.Photo) ? "col-xs-12" : "col-xs-9 col-sm-10")" id="playerInfoContainer">
                        <p style="margin-bottom: 5px; @(Model.Player.BirthYearValue == null ? "display:none;" : "")" id="birthYearRow"><strong>@LocString[nameof(LocalizationKey.BirthYear)]:</strong> <span id="displayBirthYear">@Model.Player.BirthYear</span></p>
                        <p style="margin-bottom: 5px;"><strong>@LocString[nameof(LocalizationKey.Residence)]:</strong> <span id="displayResidence">@(Model.Player.Residence ?? "Singapore")</span></p>
                        <p style="margin-bottom: 0;"><strong>@LocString[nameof(LocalizationKey.CurrentRanking)]:</strong> @Model.Player.LatestRanking</p>
                    </div>
                </div>
                
                <!-- Edit Player Info Form (collapsed by default) -->
                <div class="collapse" id="editPlayerInfo" style="margin-top: 15px;">
                    <hr />
                    <form asp-action="UpdatePlayerInfo" method="post" id="playerInfoForm">
                        <input type="hidden" name="PlayerId" value="@Model.Player.Id" />
                        <input type="hidden" name="LeagueId" value="@Model.LeagueId" />
                        <div class="row">
                            <div class="col-md-6 form-group">
                                <label>@LocString[nameof(LocalizationKey.DisplayName)]</label>
                                <input type="text" class="form-control" name="DisplayName" value="@Model.Player.DisplayName" />
                            </div>
                            <div class="col-md-3 form-group">
                                <label>@LocString[nameof(LocalizationKey.BirthYear)]</label>
                                <input type="number" class="form-control" name="BirthYearValue" value="@Model.Player.BirthYearValue" min="1900" max="2100" />
                            </div>
                            <div class="col-md-3 form-group">
                                <label>@LocString[nameof(LocalizationKey.Residence)]</label>
                                <input type="text" class="form-control" name="Residence" value="@Model.Player.Residence" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 form-group">
                                <label>@LocString[nameof(LocalizationKey.PhotoUrl)]</label>
                                <input type="url" class="form-control" name="Photo" value="@Model.Player.Photo" placeholder="https://..." />
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <button type="submit" class="btn btn-primary btn-sm">@LocString[nameof(LocalizationKey.SaveChanges)]</button>
                            <button type="button" class="btn btn-default btn-sm" data-toggle="collapse" data-target="#editPlayerInfo">@LocString[nameof(LocalizationKey.Cancel)]</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Rankings Management Section (collapsed by default) -->
        <div style="margin-bottom: 15px;">
            <button class="btn btn-sm btn-default" type="button" data-toggle="collapse" data-target="#rankingManagement">
                ‚úèÔ∏è @LocString[nameof(LocalizationKey.EditRankingHistory)]
            </button>
        </div>
        <div class="collapse" id="rankingManagement">
            <div class="panel panel-default" style="margin-bottom: 15px;">
                <div class="panel-heading" style="display: flex; justify-content: space-between; align-items: center;">
                    <span><strong>@LocString[nameof(LocalizationKey.RankingHistory)]</strong></span>
                    <button class="btn btn-sm btn-success" type="button" data-toggle="collapse" data-target="#addRankingForm">
                        + @LocString[nameof(LocalizationKey.AddRanking)]
                    </button>
                </div>
                <div class="panel-body">
                    <!-- Add Ranking Form (collapsed by default) -->
                    <div class="collapse" id="addRankingForm" style="margin-bottom: 15px;">
                        <form asp-action="AddRanking" method="post" class="well">
                            <input type="hidden" name="PlayerId" value="@Model.Player.Id" />
                            <input type="hidden" name="LeagueId" value="@Model.LeagueId" />
                            <div class="row">
                                <div class="col-md-2 form-group">
                                    <label>@LocString[nameof(LocalizationKey.Ranking)]</label>
                                    <input type="text" class="form-control" name="Ranking" placeholder="e.g., 1D" required pattern="^\d{1,2}[DKP]$" />
                                </div>
                                <div class="col-md-3 form-group">
                                    <label>@LocString[nameof(LocalizationKey.Organization)]</label>
                                    <select class="form-control" name="Organization" required>
                                        @foreach (var org in EditRankingViewModel.CommonOrganizations)
                                        {
                                            <option value="@org">@org</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-3 form-group">
                                    <label>@LocString[nameof(LocalizationKey.Date)]</label>
                                    <input type="date" class="form-control" name="RankingDate" />
                                </div>
                                <div class="col-md-4 form-group">
                                    <label>@LocString[nameof(LocalizationKey.Note)]</label>
                                    <input type="text" class="form-control" name="RankingNote" />
                                </div>
                            </div>
                            <div style="margin-top: 10px;">
                                <button type="submit" class="btn btn-success btn-sm">@LocString[nameof(LocalizationKey.AddRanking)]</button>
                                <button type="button" class="btn btn-default btn-sm" data-toggle="collapse" data-target="#addRankingForm">@LocString[nameof(LocalizationKey.Cancel)]</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Rankings List -->
                <p class="text-muted" style="margin-bottom: 0; @(playerRankings.Any() ? "display:none;" : "")" id="noRankingsMsg"></p>
                <div class="table-responsive" @(!playerRankings.Any() ? "style=\"display:none;\"" : "")>
                    <table class="table table-condensed table-hover" style="margin-bottom: 0;" id="rankingsTable">
                            <thead>
                                <tr>
                                    <th>@LocString[nameof(LocalizationKey.Ranking)]</th>
                                    <th>@LocString[nameof(LocalizationKey.Organization)]</th>
                                    <th>@LocString[nameof(LocalizationKey.Date)]</th>
                                    <th>@LocString[nameof(LocalizationKey.Note)]</th>
                                    <th style="width: 100px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var ranking in playerRankings)
                                {
                                    var editFormId = $"editRanking_{ranking.RankingId}";
                                    <tr data-ranking-id="@ranking.RankingId">
                                        <td>
                                            <span style="color: rgb(255, 99, 132); font-weight: bold;">@ranking.Ranking</span>
                                        </td>
                                        <td>@ranking.Organization</td>
                                        <td>@(ranking.RankingDate?.ToString("dd/MM/yyyy") ?? "-")</td>
                                        <td style="font-size: 0.85em; color: #666;">@ranking.RankingNote</td>
                                        <td>
                                            <button class="btn btn-primary btn-xs" type="button" data-toggle="collapse" data-target="#@editFormId" title="Edit">
                                                ‚úèÔ∏è
                                            </button>
                                            <form asp-action="DeleteRanking" method="post" style="display: inline;" class="delete-ranking-form">
                                                <input type="hidden" name="rankingId" value="@ranking.RankingId" />
                                                <input type="hidden" name="playerId" value="@Model.Player.Id" />
                                                <input type="hidden" name="leagueId" value="@Model.LeagueId" />
                                                <button type="submit" class="btn btn-danger btn-xs" title="Delete">üóëÔ∏è</button>
                                            </form>
                                        </td>
                                    </tr>
                                    <tr class="collapse" id="@editFormId">
                                        <td colspan="5" style="background-color: #f5f5f5; padding: 10px;">
                                            <form asp-action="EditRanking" method="post" class="edit-ranking-form">
                                                <input type="hidden" name="RankingId" value="@ranking.RankingId" />
                                                <input type="hidden" name="PlayerId" value="@Model.Player.Id" />
                                                <input type="hidden" name="LeagueId" value="@Model.LeagueId" />
                                                <div class="row">
                                                    <div class="col-md-2">
                                                        <input type="text" class="form-control input-sm" name="Ranking" value="@ranking.Ranking" required pattern="^\d{1,2}[DKP]$" />
                                                    </div>
                                                    <div class="col-md-2">
                                                        <select class="form-control input-sm" name="Organization" required>
                                                            @foreach (var org in EditRankingViewModel.CommonOrganizations)
                                                            {
                                                                if (ranking.Organization == org)
                                                                {
                                                                    <option value="@org" selected>@org</option>
                                                                }
                                                                else
                                                                {
                                                                    <option value="@org">@org</option>
                                                                }
                                                            }
                                                        </select>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <input type="date" class="form-control input-sm" name="RankingDate" value="@(ranking.RankingDate?.ToString("yyyy-MM-dd"))" />
                                                    </div>
                                                    <div class="col-md-3">
                                                        <input type="text" class="form-control input-sm" name="RankingNote" value="@ranking.RankingNote" />
                                                    </div>
                                                    <div class="col-md-3">
                                                        <button type="submit" class="btn btn-primary btn-xs">Save</button>
                                                        <button type="button" class="btn btn-default btn-xs" data-toggle="collapse" data-target="#@editFormId">Cancel</button>
                                                    </div>
                                                </div>
                                            </form>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@{
    // Build ranking labels for each month - show ranking when it changes
    // Include rankings with known dates
    var rankingHistoryWithDates = Model.Player.RankingHistory
        .Where(x => x.Key != "BY" && !string.IsNullOrEmpty(x.Key) && x.Value != DateTimeOffset.MinValue)
        .OrderBy(x => x.Value)
        .ToList();
    
    // Also get rankings without known dates (to show as "before first match")
    var rankingHistoryWithoutDates = Model.Player.RankingHistory
        .Where(x => x.Key != "BY" && !string.IsNullOrEmpty(x.Key) && x.Value == DateTimeOffset.MinValue)
        .ToList();
    
    // Get the first match date to identify early rankings
    var firstMatchDate = Model.MonthlyRatings.Any() 
        ? Model.MonthlyRatings.Min(r => r.Month) 
        : DateTime.MaxValue;
    
    // Map each month to list of rankings with full date and sort date (multiple promotions per month supported)
    var monthRankingLabels = new Dictionary<string, List<(string ranking, string date, DateTimeOffset sortDate)>>();
    
    // Rankings before first match (to show at bottom of table)
    var earlyRankings = new List<(string ranking, string date, DateTimeOffset sortDate)>();
    
    // Add rankings without known dates first (they go to early rankings)
    foreach (var entry in rankingHistoryWithoutDates)
    {
        earlyRankings.Add((entry.Key.ToUpper(), "", DateTimeOffset.MinValue));
    }
    
    foreach (var entry in rankingHistoryWithDates)
    {
        // The ranking appears on the chart in the same month it was achieved
        // (since ratings are now shown at the end of each month)
        var effectiveMonth = new DateTime(entry.Value.Year, entry.Value.Month, 1);
        var monthKey = effectiveMonth.ToString("MMM yyyy");
        var fullDate = entry.Value.ToString("dd/MM/yyyy");
        
        // Check if this ranking is before the first match month
        if (effectiveMonth < firstMatchDate)
        {
            earlyRankings.Add((entry.Key.ToUpper(), fullDate, entry.Value));
        }
        else
        {
            if (!monthRankingLabels.ContainsKey(monthKey))
            {
                monthRankingLabels[monthKey] = new List<(string ranking, string date, DateTimeOffset sortDate)>();
            }
            monthRankingLabels[monthKey].Add((entry.Key.ToUpper(), fullDate, entry.Value));
        }
    }
    
    // For chart labels, combine multiple rankings into single string (sorted by date)
    var chartRankingLabels = monthRankingLabels.ToDictionary(
        kvp => kvp.Key,
        kvp => (
            ranking: string.Join(", ", kvp.Value.OrderBy(r => r.sortDate).Select(r => r.ranking)),
            date: string.Join(", ", kvp.Value.OrderBy(r => r.sortDate).Select(r => r.date))
        )
    );
}

<a href="@Url.Action("Rating", new { id = Model.LeagueId, swaOnly = Model.SwaOnly, promotionBonus = Model.PromotionBonus })" class="btn btn-outline-secondary mb-3">‚Üê @LocString[nameof(LocalizationKey.BackToRating)]</a>

@if (!Model.IsIntlLeague && Model.MonthlyRatings.Any())
{
<form asp-action="Player" method="get" class="mb-3">
    <input type="hidden" name="id" value="@Model.LeagueId" />
    <input type="hidden" name="playerId" value="@Model.Player.Id" />
    <input type="hidden" id="swaOnlyHidden" name="swaOnly" value="@(Model.SwaOnly ? "true" : "false")" />
    <input type="hidden" id="promotionBonusHidden" name="promotionBonus" value="@(Model.PromotionBonus ? "true" : "false")" />
    <div style="display: inline-flex; gap: 16px; align-items: center;">
        <div class="form-check form-switch" style="display: flex; align-items: center; gap: 6px;">
            <input class="form-check-input" type="checkbox" id="swaOnlyToggle" @(Model.SwaOnly ? "checked" : "") onchange="document.getElementById('swaOnlyHidden').value = this.checked; this.form.submit();" style="cursor: pointer;">
            <label class="form-check-label" for="swaOnlyToggle" style="cursor: pointer; white-space: nowrap;">@LocString[nameof(LocalizationKey.SWATournamentsOnly)]</label>
        </div>
        <div class="form-check form-switch" style="display: flex; align-items: center; gap: 6px;">
            <input class="form-check-input" type="checkbox" id="promotionBonusToggle" @(Model.PromotionBonus ? "checked" : "") onchange="document.getElementById('promotionBonusHidden').value = this.checked; this.form.submit();" style="cursor: pointer;">
            <label class="form-check-label" for="promotionBonusToggle" style="cursor: pointer; white-space: nowrap;">@LocString[nameof(LocalizationKey.PromotionBonus)]</label>
        </div>
    </div>
</form>
}

@if (Model.MonthlyRatings.Any())
{
<h4>@LocString[nameof(LocalizationKey.RatingHistoryChart)]</h4>
<div style="max-width: 800px; margin-bottom: 30px;">
    <canvas id="ratingChart"></canvas>
</div>
}

<h4>@LocString[nameof(LocalizationKey.MonthlyRatingHistory)]</h4>
<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>@LocString[nameof(LocalizationKey.Month)]</th>
                <th>@LocString[nameof(LocalizationKey.Rating)]</th>
                <th>@LocString[nameof(LocalizationKey.Matches)]</th>
                <th>@LocString[nameof(LocalizationKey.Ranking)]</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.MonthlyRatings.OrderByDescending(r => r.Month))
            {
                var hasRankings = monthRankingLabels.TryGetValue(item.MonthDisplay, out var rankingList);
                // Only show rows with matches or ranking changes
                if (item.MatchesInMonth == 0 && !hasRankings)
                {
                    continue;
                }
                <tr>
                    <td>@item.MonthDisplay</td>
                    <td>@item.RatingDisplay</td>
                    <td>
                        @if (item.MatchNames.Any())
                        {
                            @foreach (var matchName in item.MatchNames)
                            {
                                <div style="font-size: 0.85em;">@matchName</div>
                            }
                        }
                        else
                        {
                            <span>-</span>
                        }
                    </td>
                    <td>
                        @if (hasRankings)
                        {
                            @foreach (var rankingInfo in rankingList.OrderByDescending(r => r.sortDate))
                            {
                                <div>
                                    <span style="color: rgb(255, 99, 132); font-weight: bold;">@rankingInfo.ranking</span>
                                    <span style="color: #666; font-size: 0.85em;">(@rankingInfo.date)</span>
                                </div>
                            }
                        }
                    </td>
                </tr>
            }
            @{
                // Use the latest ranking before first match (most recent promotion before playing)
                var latestRankingBeforeFirstMatch = earlyRankings.Any() 
                    ? earlyRankings.OrderByDescending(r => r.sortDate).First().ranking 
                    : Model.Player.LatestRanking;
                // For players with no matches, show their current ranking rating
                var preEntryRating = !Model.MonthlyRatings.Any() && Model.Player.Rankings != null && Model.Player.Rankings.Any()
                    ? Model.Player.GetRatingByRanking(Model.Player.Rankings.OrderByDescending(r => r.RankingDate ?? DateTimeOffset.MinValue).First()).ToString()
                    : "-";
            }
            <tr style="background-color: #f8f9fa;">
                <td style="color: #666; font-style: italic;">@LocString[nameof(LocalizationKey.PreEntry)]</td>
                <td>@preEntryRating</td>
                <td>-</td>
                <td>
                    @if (earlyRankings.Any())
                    {
                        @foreach (var rankingInfo in earlyRankings.OrderByDescending(r => r.sortDate))
                        {
                            <div>
                                <span style="color: rgb(255, 99, 132); font-weight: bold;">@rankingInfo.ranking</span>
                                @if (!string.IsNullOrEmpty(rankingInfo.date))
                                {
                                    <span style="color: #666; font-size: 0.85em;">(@rankingInfo.date)</span>
                                }
                            </div>
                        }
                    }
                    else
                    {
                        <span style="color: rgb(255, 99, 132); font-weight: bold;">@latestRankingBeforeFirstMatch.ToUpper()</span>
                    }
                </td>
            </tr>
        </tbody>
    </table>
</div>

<h4 class="mt-4">@LocString[nameof(LocalizationKey.GameRecords)]</h4>
<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>@LocString[nameof(LocalizationKey.Date)]</th>
                <th>@LocString[nameof(LocalizationKey.Match)]</th>
                <th>@LocString[nameof(LocalizationKey.Opponent)]</th>
                <th>@LocString[nameof(LocalizationKey.Result)]</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var game in Model.GameRecords.OrderByDescending(g => g.Date))
            {
                <tr>
                    <td>@game.DateDisplay</td>
                    <td>@game.MatchName</td>
                    <td>
                        <a href="@Url.Action("Player", new { id = Model.LeagueId, playerId = game.OpponentId, swaOnly = Model.SwaOnly, promotionBonus = Model.PromotionBonus })">@game.OpponentName</a>
                        @if (!string.IsNullOrEmpty(game.OpponentRanking))
                        {
                            <span style="font-size: 0.8em; color: #666;">@game.OpponentRanking</span>
                        }
                    </td>
                    <td style="color: @(game.Result == "Win" ? "green" : game.Result == "Loss" ? "red" : "gray"); font-weight: bold;">
                        @game.Result
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@section Scripts {
@if (Model.MonthlyRatings.Any())
{
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script>
        const ctx = document.getElementById('ratingChart').getContext('2d');
        
        // All months for continuous axis
        const labels = [@Html.Raw(string.Join(",", sortedRatings.Select(r => $"'{r.MonthDisplay}'")))];
        const ratings = [@Html.Raw(string.Join(",", sortedRatings.Select(r => r.Rating.ToString("F1", System.Globalization.CultureInfo.InvariantCulture))))];
        
        // Track which months have activity (matches or ranking changes)
        const hasActivity = [@Html.Raw(string.Join(",", sortedRatings.Select(r => (r.MatchesInMonth > 0 || monthRankingLabels.ContainsKey(r.MonthDisplay)).ToString().ToLower())))];
        
        // Ranking labels for each month (only where ranking changed)
        // Contains ranking and full date (combined if multiple)
        const rankingLabels = {
            @Html.Raw(string.Join(",", chartRankingLabels.Select(kvp => $"'{kvp.Key}': {{ ranking: '{kvp.Value.ranking}', date: '{kvp.Value.date}' }}")))
        };
        
        // Calculate min/max for better Y-axis scaling
        const minRating = Math.min(...ratings);
        const maxRating = Math.max(...ratings);
        const padding = (maxRating - minRating) * 0.1 || 50;
        
        // Register the datalabels plugin
        Chart.register(ChartDataLabels);
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Rating',
                    data: ratings,
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    fill: true,
                    tension: 0,
                    pointRadius: function(context) {
                        const idx = context.dataIndex;
                        if (!hasActivity[idx]) return 0; // Hide point for inactive months
                        const label = labels[idx];
                        return rankingLabels[label] ? 8 : 4;
                    },
                    pointBackgroundColor: function(context) {
                        const label = labels[context.dataIndex];
                        return rankingLabels[label] ? 'rgb(255, 99, 132)' : 'rgb(54, 162, 235)';
                    },
                    pointBorderColor: function(context) {
                        const label = labels[context.dataIndex];
                        return rankingLabels[label] ? 'rgb(255, 99, 132)' : 'rgb(54, 162, 235)';
                    },
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = labels[context.dataIndex];
                                const rankingInfo = rankingLabels[label];
                                let result = 'Rating: ' + context.parsed.y.toFixed(1);
                                if (rankingInfo) {
                                    result += ' (Promoted to ' + rankingInfo.ranking + ' on ' + rankingInfo.date + ')';
                                }
                                return result;
                            }
                        }
                    },
                    datalabels: {
                        align: 'top',
                        anchor: 'end',
                        offset: 4,
                        font: {
                            weight: 'bold',
                            size: 10
                        },
                        color: 'rgb(255, 99, 132)',
                        formatter: function(value, context) {
                            const label = labels[context.dataIndex];
                            const rankingInfo = rankingLabels[label];
                            if (rankingInfo) {
                                return rankingInfo.ranking + '\n(' + rankingInfo.date + ')';
                            }
                            return null;
                        },
                        display: function(context) {
                            const label = labels[context.dataIndex];
                            return !!rankingLabels[label];
                        },
                        textAlign: 'center'
                    }
                },
                scales: {
                    y: {
                        min: Math.floor(minRating - padding),
                        max: Math.ceil(maxRating + padding),
                        title: {
                            display: true,
                            text: 'Rating'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Month'
                        }
                    }
                }
            }
        });
    </script>
}
    <script>
        // AJAX form handling for player info and rankings
        $(document).ready(function() {
            // Show status message
            function showMessage(message, isSuccess) {
                var alertClass = isSuccess ? 'alert-success' : 'alert-danger';
                var $alert = $('<div class="alert ' + alertClass + '" style="position: fixed; top: 60px; right: 20px; z-index: 9999; padding: 10px 20px;">' + message + '</div>');
                $('body').append($alert);
                setTimeout(function() { $alert.fadeOut(function() { $(this).remove(); }); }, 2000);
            }
            
            // Handle player info form
            $('#playerInfoForm').on('submit', function(e) {
                e.preventDefault();
                var $form = $(this);
                var $btn = $form.find('button[type="submit"]');
                $btn.prop('disabled', true).text('Saving...');
                
                $.ajax({
                    url: $form.attr('action'),
                    type: 'POST',
                    data: $form.serialize(),
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    success: function(response) {
                        if (response.success) {
                            showMessage(response.message, true);
                            // Update displayed values
                            var displayName = $form.find('[name="DisplayName"]').val();
                            if (displayName) {
                                $('#playerDisplayName').text(displayName);
                            }
                            var birthYear = $form.find('[name="BirthYearValue"]').val();
                            if (birthYear) {
                                $('#displayBirthYear').text(birthYear);
                                $('#birthYearRow').show();
                            } else {
                                $('#birthYearRow').hide();
                            }
                            $('#displayResidence').text($form.find('[name="Residence"]').val() || 'Singapore');
                            var photoUrl = $form.find('[name="Photo"]').val();
                            var $photoContainer = $('#playerPhotoContainer');
                            var $infoContainer = $('#playerInfoContainer');
                            if (photoUrl) {
                                if ($photoContainer.length === 0) {
                                    // Create photo container if it doesn't exist
                                    $infoContainer.before('<div class="col-xs-3 col-sm-2" id="playerPhotoContainer"><img id="playerPhoto" src="' + photoUrl + '" style="max-width: 120px; max-height: 120px; border-radius: 8px;" /></div>');
                                    $infoContainer.removeClass('col-xs-12').addClass('col-xs-9 col-sm-10');
                                } else {
                                    $('#playerPhoto').attr('src', photoUrl);
                                }
                            } else {
                                // Remove photo container if URL is cleared
                                $photoContainer.remove();
                                $infoContainer.removeClass('col-xs-9 col-sm-10').addClass('col-xs-12');
                            }
                        } else {
                            showMessage(response.message || 'Error saving', false);
                        }
                    },
                    error: function() { showMessage('Error saving', false); },
                    complete: function() { $btn.prop('disabled', false).text('Save Changes'); }
                });
            });
            
            // Handle add ranking form
            $('#addRankingForm form').on('submit', function(e) {
                e.preventDefault();
                var $form = $(this);
                var $btn = $form.find('button[type="submit"]');
                $btn.prop('disabled', true).text('Adding...');
                
                $.ajax({
                    url: $form.attr('action'),
                    type: 'POST',
                    data: $form.serialize(),
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    success: function(response) {
                        if (response.success) {
                            showMessage(response.message, true);
                            // Add new row to table
                            var r = response.ranking;
                            var newRow = '<tr data-ranking-id="' + r.rankingId + '">' +
                                '<td><span style="color: rgb(255, 99, 132); font-weight: bold;">' + r.rankingGrade + '</span></td>' +
                                '<td>' + r.organization + '</td>' +
                                '<td>' + r.date + '</td>' +
                                '<td style="font-size: 0.85em; color: #666;">' + r.note + '</td>' +
                                '<td><button class="btn btn-danger btn-xs delete-ranking-btn" data-ranking-id="' + r.rankingId + '">üóëÔ∏è</button></td>' +
                                '</tr>';
                            $('#rankingsTable tbody').prepend(newRow);
                            $('#noRankingsMsg').hide();
                            $('#rankingsTable').show();
                            // Clear form
                            $form[0].reset();
                            $('#addRankingForm').collapse('hide');
                        } else {
                            showMessage(response.message || 'Error adding', false);
                        }
                    },
                    error: function() { showMessage('Error adding ranking', false); },
                    complete: function() { $btn.prop('disabled', false).text('Add Ranking'); }
                });
            });
            
            // Handle edit ranking forms
            $(document).on('submit', '.edit-ranking-form', function(e) {
                e.preventDefault();
                var $form = $(this);
                var $btn = $form.find('button[type="submit"]');
                var rankingId = $form.find('[name="RankingId"]').val();
                $btn.prop('disabled', true).text('Saving...');
                
                $.ajax({
                    url: $form.attr('action'),
                    type: 'POST',
                    data: $form.serialize(),
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    success: function(response) {
                        if (response.success) {
                            showMessage(response.message, true);
                            // Update the row
                            var r = response.ranking;
                            var $row = $('tr[data-ranking-id="' + rankingId + '"]');
                            $row.find('td:eq(0) span').text(r.rankingGrade);
                            $row.find('td:eq(1)').text(r.organization);
                            $row.find('td:eq(2)').text(r.date);
                            $row.find('td:eq(3)').text(r.note);
                            // Collapse the edit form
                            $('#editRanking_' + rankingId).collapse('hide');
                        } else {
                            showMessage(response.message || 'Error saving', false);
                        }
                    },
                    error: function() { showMessage('Error saving ranking', false); },
                    complete: function() { $btn.prop('disabled', false).text('Save'); }
                });
            });
            
            // Handle delete ranking
            $(document).on('submit', '.delete-ranking-form', function(e) {
                e.preventDefault();
                if (!confirm('Delete this ranking?')) return;
                
                var $form = $(this);
                var rankingId = $form.find('[name="rankingId"]').val();
                
                $.ajax({
                    url: $form.attr('action'),
                    type: 'POST',
                    data: $form.serialize(),
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    success: function(response) {
                        if (response.success) {
                            showMessage(response.message, true);
                            // Remove the row and edit form row
                            $('tr[data-ranking-id="' + rankingId + '"]').remove();
                            $('#editRanking_' + rankingId).closest('tr').remove();
                        } else {
                            showMessage(response.message || 'Error deleting', false);
                        }
                    },
                    error: function() { showMessage('Error deleting ranking', false); }
                });
            });
        });
    </script>
}

