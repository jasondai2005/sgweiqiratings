@using PlayerRatings.Localization
@using PlayerRatings.Models
@using PlayerRatings.ViewModels.Player
@model PlayerRatings.ViewModels.Player.PlayerRatingHistoryViewModel
@inject ILanguageData LanguageData

@functions {
    // Helper class for combining rated and unrated tournaments
    public class TournamentDisplayItem
    {
        public Guid? TournamentId { get; set; }
        public string TournamentName { get; set; }
        public string TournamentShortName { get; set; } // Short name for mobile (bilingual only)
        public string MatchName { get; set; }
        public int? TournamentPosition { get; set; }
        public int? FemalePosition { get; set; }
        public int? TeamPosition { get; set; }
        public DateTimeOffset StartDate { get; set; }
        public bool HasMatches { get; set; }
        public bool IsRated { get; set; } // Based on tournament's Factor, not match factors
    }
}

@{
    ViewData["Title"] = Model.Player.DisplayName;
    var sortedRatings = Model.MonthlyRatings.OrderBy(r => r.Month).ToList();
    var playerRankings = Model.Player.Rankings?.OrderByDescending(r => r.RankingDate ?? DateTimeOffset.MinValue).ToList() 
        ?? new List<PlayerRanking>();
}

<div class="row">
    <div class="col-md-8">
        <h3 id="playerDisplayName">@Model.Player.DisplayName <span style="font-size: 0.6em; color: #999; font-weight: normal;">@Model.Player.UserName</span></h3>
        
        <div class="mb-3" style="display: inline-flex; gap: 4px; align-items: center;">
            <a href="@Url.Action("Rating", new { id = Model.LeagueId })" class="btn btn-outline-secondary btn-sm" title="@LocString[nameof(LocalizationKey.BackToRating)]">‚Ü©</a>
            <a href="@Url.Action("Player", new { id = Model.LeagueId, playerId = Model.Player.Id, refresh = true })" class="btn btn-outline-secondary btn-sm" title="Reload data from database">‚ü≥</a>
            
            @if (!string.IsNullOrEmpty(Model.PreviousPlayerId) || !string.IsNullOrEmpty(Model.NextPlayerId))
            {
                <span style="margin-left: 8px; color: #ccc;">|</span>
                @if (!string.IsNullOrEmpty(Model.PreviousPlayerId))
                {
                    <a href="@Url.Action("Player", new { id = Model.LeagueId, playerId = Model.PreviousPlayerId })" 
                       class="btn btn-outline-primary btn-sm" title="@LocString[nameof(LocalizationKey.PreviousPlayer)]">‚óÄ</a>
                }
                else
                {
                    <button class="btn btn-outline-secondary btn-sm" disabled>‚óÄ</button>
                }
                @if (Model.Position > 0)
                {
                    <span style="font-size: 0.85em; color: #666; min-width: 50px; text-align: center;">@Model.PositionDisplay</span>
                }
                else
                {
                    <span style="font-size: 0.85em; color: #999; min-width: 50px; text-align: center;">-</span>
                }
                @if (!string.IsNullOrEmpty(Model.NextPlayerId))
                {
                    <a href="@Url.Action("Player", new { id = Model.LeagueId, playerId = Model.NextPlayerId })" 
                       class="btn btn-outline-primary btn-sm" title="@LocString[nameof(LocalizationKey.NextPlayer)]">‚ñ∂</a>
                }
                else
                {
                    <button class="btn btn-outline-secondary btn-sm" disabled>‚ñ∂</button>
                }
            }
        </div>
        
        <style>
            /* Mobile photo row for player details */
            .player-photo-mobile-row {
                display: none;
                text-align: center;
                margin-bottom: 15px;
            }
            .player-photo-desktop {
                display: block;
            }
            @@media (max-width: 768px) {
                .player-photo-mobile-row {
                    display: block;
                }
                .player-photo-desktop {
                    display: none !important;
                }
                .player-info-full-width {
                    width: 100% !important;
                    flex: 0 0 100% !important;
                    max-width: 100% !important;
                }
            }
        </style>
        <!-- Player Info Section -->
        <div class="panel panel-default" style="margin-bottom: 15px;">
            <div class="panel-heading" style="display: flex; justify-content: space-between; align-items: center;">
                <span><strong>@LocString[nameof(LocalizationKey.PlayerInformation)]</strong></span>
                @if (Model.IsAdmin)
                {
                <button class="btn btn-sm btn-primary" type="button" data-toggle="collapse" data-target="#editPlayerInfo">
                    @LocString[nameof(LocalizationKey.Edit)]
                </button>
                }
            </div>
            <div class="panel-body">
                @if (!string.IsNullOrEmpty(Model.Player.Photo))
                {
                <!-- Mobile: Photo on its own row -->
                <div class="player-photo-mobile-row">
                    <img src="@(Model.Player.Photo)@(Model.Player.Photo.Contains("?") ? "&" : "?")v=@DateTime.UtcNow.Ticks" alt="@Model.Player.DisplayName" style="max-width: 150px; max-height: 150px; border-radius: 8px; cursor: pointer;" onclick="showPhotoModal(this.src)" title="Click to enlarge" />
                </div>
                }
                <div class="row">
                    @if (!string.IsNullOrEmpty(Model.Player.Photo))
                    {
                    <!-- Desktop: Photo inline -->
                    <div class="col-xs-3 col-sm-2 player-photo-desktop" id="playerPhotoContainer">
                        <img id="playerPhoto" src="@(Model.Player.Photo)@(Model.Player.Photo.Contains("?") ? "&" : "?")v=@DateTime.UtcNow.Ticks" alt="@Model.Player.DisplayName" style="max-width: 120px; max-height: 120px; border-radius: 8px; cursor: pointer;" onclick="showPhotoModal(this.src)" title="Click to enlarge" />
                    </div>
                    }
                    <div class="@(string.IsNullOrEmpty(Model.Player.Photo) ? "col-xs-12" : "col-xs-9 col-sm-10 player-info-full-width")" id="playerInfoContainer">
                        @{
                            // Show birth year if admin, or if player is U18
                            var showBirthYear = Model.IsAdmin 
                                ? Model.Player.BirthYearValue != null 
                                : !string.IsNullOrEmpty(Model.Player.BirthYearU18);
                            var displayBirthYear = Model.IsAdmin ? Model.Player.BirthYear : Model.Player.BirthYearU18;
                        }
                        <p style="margin-bottom: 5px; @(showBirthYear ? "" : "display:none;")" id="birthYearRow"><strong>@LocString[nameof(LocalizationKey.BirthYear)]:</strong> <span id="displayBirthYear">@displayBirthYear</span></p>
                        <p style="margin-bottom: 5px;"><strong>@LocString[nameof(LocalizationKey.Residence)]:</strong> <span id="displayResidence">@(string.IsNullOrEmpty(Model.Player.CurrentResidence) ? "Singapore" : Model.Player.CurrentResidence)</span></p>
                        <p style="margin-bottom: 5px;"><strong>@LocString[nameof(LocalizationKey.CurrentRanking)]:</strong> @Model.Player.LatestRanking</p>
                        @if (Model.Position > 0)
                        {
                        <p style="margin-bottom: 5px;"><strong>@LocString[nameof(LocalizationKey.Position)]:</strong> @Model.PositionDisplay <span style="color: #666; font-size: 0.9em;">/ @Model.TotalPlayers</span></p>
                        }
                        @if (Model.ActiveTitles.Any())
                        {
                        <p style="margin-bottom: 5px;"><strong style="color: #8b0000;">@LocString[nameof(LocalizationKey.Title)]:</strong>
                            @foreach (var title in Model.ActiveTitles)
                            {
                                <span style="color: #8b0000; font-weight: bold;">@title.GetLocalizedTitle(LanguageData.CurrentLanguage)</span>
                                <span style="color: #666; font-size: 0.85em;">(@title.WonDate.ToString("yyyy"))</span>
                            }
                        </p>
                        }
                        @if (Model.FormerTitles.Any())
                        {
                        <p style="margin-bottom: 5px;"><strong style="color: #666;">@LocString[nameof(LocalizationKey.FormerTitle)]:</strong>
                            @foreach (var title in Model.FormerTitles)
                            {
                                <span style="color: #666;">@title.GetLocalizedTitle(LanguageData.CurrentLanguage)</span>
                                <span style="font-size: 0.85em;">(@title.WonDate.ToString("yyyy"))</span>
                            }
                        </p>
                        }
                    </div>
                </div>
                
                @if (Model.TotalGames > 0 || Model.TotalTournaments > 0)
                {
                <!-- Statistics Section -->
                <hr style="margin: 10px 0;" />
                <div class="row">
                    <div class="col-xs-12">
                        <strong>@LocString[nameof(LocalizationKey.Statistics)]</strong>
                    </div>
                </div>
                <div class="row" style="margin-top: 8px;">
                    <div class="col-sm-4">
                        <div style="color: #666; margin-bottom: 4px;">@LocString[nameof(LocalizationKey.Overall)]:</div>
                        @if (Model.TotalTournaments > 0)
                        {
                            <div><strong>@Model.TotalTournaments</strong> @LocString[nameof(LocalizationKey.Tournaments)]</div>
                        }
                        @if (Model.TotalGames > 0)
                        {
                            <div>
                                <strong>@Model.TotalGames</strong> @LocString[nameof(LocalizationKey.Games)]
                                <span style="color: #5cb85c; margin-left: 8px;">@Model.TotalWins W</span>
                                <span style="color: #d9534f; margin-left: 4px;">@Model.TotalLosses L</span>
                                <span style="margin-left: 8px; font-weight: bold;">(@Model.OverallWinRate.ToString("F1")%)</span>
                            </div>
                        }
                        @if (Model.ChampionshipCount > 0)
                        {
                            <div><span style="color: #f0ad4e;">üèÜ</span> <strong style="color: #f0ad4e;">@Model.ChampionshipCount</strong> <span style="color: #666;">@(Model.ChampionshipCount == 1 ? "Champion" : "Champions")</span></div>
                        }
                        @if (Model.TeamChampionshipCount > 0)
                        {
                            <div><span style="color: #337ab7;">üèÖ</span> <strong style="color: #337ab7;">@Model.TeamChampionshipCount</strong> <span style="color: #666;">Team @(Model.TeamChampionshipCount == 1 ? "Champion" : "Champions")</span></div>
                        }
                        @if (Model.FemaleChampionshipCount > 0)
                        {
                            <div><span style="color: #d63384;">üëë</span> <strong style="color: #d63384;">@Model.FemaleChampionshipCount</strong> <span style="color: #666;">Female @(Model.FemaleChampionshipCount == 1 ? "Champion" : "Champions")</span></div>
                        }
                        @if (Model.IntlSelectionCount > 0)
                        {
                            <div><span style="color: #9932cc;">üåç</span> <strong style="color: #9932cc;">@Model.IntlSelectionCount</strong> <span style="color: #666;">Selected to Intl @(Model.IntlSelectionCount == 1 ? "Event" : "Events")</span></div>
                        }
                    </div>
                    @if (Model.CurrentYearGames > 0 || Model.CurrentYearTournaments > 0)
                    {
                    <div class="col-sm-4">
                        <div style="color: #666; margin-bottom: 4px;">@LocString[nameof(LocalizationKey.ThisYear)] (@DateTime.Now.Year):</div>
                        @if (Model.CurrentYearTournaments > 0)
                        {
                            <div><strong>@Model.CurrentYearTournaments</strong> @LocString[nameof(LocalizationKey.Tournaments)]</div>
                        }
                        @if (Model.CurrentYearGames > 0)
                        {
                            <div>
                                <strong>@Model.CurrentYearGames</strong> @LocString[nameof(LocalizationKey.Games)]
                                <span style="color: #5cb85c; margin-left: 8px;">@Model.CurrentYearWins W</span>
                                <span style="color: #d9534f; margin-left: 4px;">@Model.CurrentYearLosses L</span>
                                <span style="margin-left: 8px; font-weight: bold;">(@Model.CurrentYearWinRate.ToString("F1")%)</span>
                            </div>
                        }
                        @if (Model.CurrentYearChampionships > 0)
                        {
                            <div><span style="color: #f0ad4e;">üèÜ</span> <strong style="color: #f0ad4e;">@Model.CurrentYearChampionships</strong> <span style="color: #666;">@(Model.CurrentYearChampionships == 1 ? "Champion" : "Champions")</span></div>
                        }
                        @if (Model.CurrentYearTeamChampionships > 0)
                        {
                            <div><span style="color: #337ab7;">üèÖ</span> <strong style="color: #337ab7;">@Model.CurrentYearTeamChampionships</strong> <span style="color: #666;">Team @(Model.CurrentYearTeamChampionships == 1 ? "Champion" : "Champions")</span></div>
                        }
                        @if (Model.CurrentYearFemaleChampionships > 0)
                        {
                            <div><span style="color: #d63384;">üëë</span> <strong style="color: #d63384;">@Model.CurrentYearFemaleChampionships</strong> <span style="color: #666;">Female @(Model.CurrentYearFemaleChampionships == 1 ? "Champion" : "Champions")</span></div>
                        }
                        @if (Model.CurrentYearIntlSelectionCount > 0)
                        {
                            <div><span style="color: #9932cc;">üåç</span> <strong style="color: #9932cc;">@Model.CurrentYearIntlSelectionCount</strong> <span style="color: #666;">Selected to Intl @(Model.CurrentYearIntlSelectionCount == 1 ? "Event" : "Events")</span></div>
                        }
                    </div>
                    }
                    @if (Model.LastYearGames > 0 || Model.LastYearTournaments > 0)
                    {
                    <div class="col-sm-4">
                        <div style="color: #666; margin-bottom: 4px;">@LocString[nameof(LocalizationKey.LastYear)] (@(DateTime.Now.Year - 1)):</div>
                        @if (Model.LastYearTournaments > 0)
                        {
                            <div><strong>@Model.LastYearTournaments</strong> @LocString[nameof(LocalizationKey.Tournaments)]</div>
                        }
                        @if (Model.LastYearGames > 0)
                        {
                            <div>
                                <strong>@Model.LastYearGames</strong> @LocString[nameof(LocalizationKey.Games)]
                                <span style="color: #5cb85c; margin-left: 8px;">@Model.LastYearWins W</span>
                                <span style="color: #d9534f; margin-left: 4px;">@Model.LastYearLosses L</span>
                                <span style="margin-left: 8px; font-weight: bold;">(@Model.LastYearWinRate.ToString("F1")%)</span>
                            </div>
                        }
                        @if (Model.LastYearChampionships > 0)
                        {
                            <div><span style="color: #f0ad4e;">üèÜ</span> <strong style="color: #f0ad4e;">@Model.LastYearChampionships</strong> <span style="color: #666;">@(Model.LastYearChampionships == 1 ? "Champion" : "Champions")</span></div>
                        }
                        @if (Model.LastYearTeamChampionships > 0)
                        {
                            <div><span style="color: #337ab7;">üèÖ</span> <strong style="color: #337ab7;">@Model.LastYearTeamChampionships</strong> <span style="color: #666;">Team @(Model.LastYearTeamChampionships == 1 ? "Champion" : "Champions")</span></div>
                        }
                        @if (Model.LastYearFemaleChampionships > 0)
                        {
                            <div><span style="color: #d63384;">üëë</span> <strong style="color: #d63384;">@Model.LastYearFemaleChampionships</strong> <span style="color: #666;">Female @(Model.LastYearFemaleChampionships == 1 ? "Champion" : "Champions")</span></div>
                        }
                        @if (Model.LastYearIntlSelectionCount > 0)
                        {
                            <div><span style="color: #9932cc;">üåç</span> <strong style="color: #9932cc;">@Model.LastYearIntlSelectionCount</strong> <span style="color: #666;">Selected to Intl @(Model.LastYearIntlSelectionCount == 1 ? "Event" : "Events")</span></div>
                        }
                    </div>
                    }
                </div>
                }
                
                @if (Model.IsAdmin)
                {
                <!-- Edit Player Info Form (collapsed by default) -->
                <div class="collapse" id="editPlayerInfo" style="margin-top: 15px;">
                    <hr />
                    <form asp-action="UpdatePlayerInfo" method="post" id="playerInfoForm">
                        <input type="hidden" name="PlayerId" value="@Model.Player.Id" />
                        <input type="hidden" name="LeagueId" value="@Model.LeagueId" />
                        <div class="row">
                            <div class="col-md-6 form-group">
                                <label>@LocString[nameof(LocalizationKey.DisplayName)]</label>
                                <input type="text" class="form-control" name="DisplayName" value="@Model.Player.DisplayName" />
                            </div>
                            <div class="col-md-3 form-group">
                                <label>@LocString[nameof(LocalizationKey.BirthYear)]</label>
                                <input type="number" class="form-control" name="BirthYearValue" value="@Model.Player.BirthYearValue" min="1900" max="2100" />
                            </div>
                            <div class="col-md-3 form-group">
                                <label>@LocString[nameof(LocalizationKey.Residence)]</label>
                                <input type="text" class="form-control" name="Residence" value="@Model.Player.Residence" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 form-group">
                                <label>@LocString[nameof(LocalizationKey.PhotoUrl)]</label>
                                <input type="text" class="form-control" name="Photo" value="@Model.Player.Photo" placeholder="https://... or /pic/..." />
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <button type="submit" class="btn btn-primary btn-sm">@LocString[nameof(LocalizationKey.SaveChanges)]</button>
                            <button type="button" class="btn btn-default btn-sm" data-toggle="collapse" data-target="#editPlayerInfo">@LocString[nameof(LocalizationKey.Cancel)]</button>
                        </div>
                    </form>
                    
                    <!-- Photo Upload Form -->
                    <hr />
                    <form asp-action="UploadPlayerPhoto" method="post" enctype="multipart/form-data" id="photoUploadForm">
                        <input type="hidden" name="PlayerId" value="@Model.Player.Id" />
                        <input type="hidden" name="LeagueId" value="@Model.LeagueId" />
                        <div class="row">
                            <div class="col-md-6 form-group">
                                <label>@LocString[nameof(LocalizationKey.UploadPhoto)]</label>
                                <input type="file" class="form-control" name="photoFile" accept="image/*" required />
                                <p class="help-block" style="font-size: 0.85em; color: #666;">@LocString[nameof(LocalizationKey.SupportedFormats)]: JPG, PNG, GIF, WebP</p>
                            </div>
                            <div class="col-md-6 form-group" style="padding-top: 25px;">
                                <button type="submit" class="btn btn-primary btn-sm">@LocString[nameof(LocalizationKey.Upload)]</button>
                            </div>
                        </div>
                    </form>
                </div>
                }
            </div>
        </div>
        
    </div>
</div>

@{
    // Build a lookup of tournaments without matches by month (for display in Monthly Rating History)
    var tournamentsWithoutMatchesByMonth = Model.TournamentParticipations
        .Where(t => !t.HasMatches)
        .GroupBy(t => new DateTime(t.StartDate.Year, t.StartDate.Month, 1).AddMonths(1).AddSeconds(-1).ToString("MM/yyyy"))
        .ToDictionary(g => g.Key, g => g.ToList());
    
    // Build a lookup for tournament IsRated status
    // When SWA Only mode is on, also check if the tournament is from SWA or is an international tournament
    var tournamentIsRatedLookup = Model.TournamentParticipations
        .ToDictionary(t => t.TournamentId, t => t.IsRated && (!Model.SwaOnly || t.IsRatedForSwaOnly));

    // Build ranking labels for each month - show ranking when it changes
    // Use playerRankings from Rankings table directly

    // Get the first match date to identify early rankings
    var firstMatchDate = Model.MonthlyRatings.Any() 
        ? Model.MonthlyRatings.Min(r => r.Month) 
        : DateTime.MaxValue;

    // Map each month to list of rankings with full date, sort date, org, and tournament info
    var monthRankingLabels = new Dictionary<string, List<(string ranking, string date, DateTimeOffset sortDate, string org, string tournamentDisplay)>>();

    // Rankings before first match (to show at bottom of table)
    var earlyRankings = new List<(string ranking, string date, DateTimeOffset sortDate, string org, string tournamentDisplay)>();

    // Helper to get tournament display string: "Ordinal + Name + Group (Position)"
    string GetTournamentDisplay(PlayerRanking ranking)
    {
        if (ranking.Tournament == null)
            return "";
        
        var parts = new List<string>();
        if (!string.IsNullOrEmpty(ranking.Tournament.Ordinal))
            parts.Add(ranking.Tournament.Ordinal);
        parts.Add(ranking.Tournament.Name);
        if (!string.IsNullOrEmpty(ranking.Tournament.Group))
            parts.Add(ranking.Tournament.Group);
        
        var tournamentName = string.Join(" ", parts);
        
        // Try to get player's position in the tournament
        var tournamentPlayer = ranking.Tournament.TournamentPlayers?
            .FirstOrDefault(tp => tp.PlayerId == ranking.PlayerId);
        if (tournamentPlayer?.Position != null)
        {
            return $"{tournamentName} (#{tournamentPlayer.Position})";
        }
        return tournamentName;
    }

    // Process all rankings from the Rankings table
    foreach (var ranking in playerRankings)
    {
        if (string.IsNullOrEmpty(ranking.Ranking))
            continue;

        // Format ranking with organization indicator using the centralized method
        string displayRanking = ApplicationUser.FormatRankingForDisplay(ranking);
        
        var rankingDate = ranking.RankingDate ?? DateTimeOffset.MinValue;
        var fullDate = rankingDate != DateTimeOffset.MinValue ? rankingDate.ToString("dd/MM/yyyy") : "";
        var tournamentDisplay = GetTournamentDisplay(ranking);
        
        if (rankingDate == DateTimeOffset.MinValue)
        {
            // Rankings without known dates go to early rankings
            earlyRankings.Add((displayRanking, "", DateTimeOffset.MinValue, ranking.Organization ?? "", tournamentDisplay));
        }
        else
        {
            // Use end of month to match with MonthlyRatings.Month format
            var effectiveMonth = new DateTime(rankingDate.Year, rankingDate.Month, 1).AddMonths(1).AddSeconds(-1);
            var monthKey = effectiveMonth.ToString("MM/yyyy");
            
            // Check if this ranking is before the first match month (compare same month by using the month key)
            var firstMatchMonthKey = firstMatchDate.ToString("MM/yyyy");
            if (effectiveMonth < firstMatchDate && monthKey != firstMatchMonthKey)
            {
                earlyRankings.Add((displayRanking, fullDate, rankingDate, ranking.Organization ?? "", tournamentDisplay));
            }
            else
            {
                if (!monthRankingLabels.ContainsKey(monthKey))
                {
                    monthRankingLabels[monthKey] = new List<(string ranking, string date, DateTimeOffset sortDate, string org, string tournamentDisplay)>();
                }
                monthRankingLabels[monthKey].Add((displayRanking, fullDate, rankingDate, ranking.Organization ?? "", tournamentDisplay));
            }
        }
    }
    
    // For chart labels, combine multiple rankings into single string (sorted by date)
    var chartRankingLabels = monthRankingLabels.ToDictionary(
        kvp => kvp.Key,
        kvp => (
            ranking: string.Join(", ", kvp.Value.OrderBy(r => r.sortDate).Select(r => r.ranking)),
            date: string.Join(", ", kvp.Value.OrderBy(r => r.sortDate).Select(r => r.date))
        )
    );
}

@if (Model.MonthlyRatings.Any())
{
<h4>@LocString[nameof(LocalizationKey.RatingHistoryChart)]</h4>
<div style="max-width: 800px; margin-bottom: 30px;">
    <canvas id="ratingChart"></canvas>
</div>
}

<h4>@LocString[nameof(LocalizationKey.MonthlyRatingHistory)]</h4>
<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>@LocString[nameof(LocalizationKey.Month)]</th>
                <th>‚Ññ</th>
                <th>@LocString[nameof(LocalizationKey.Rating)]</th>
                <th>@LocString[nameof(LocalizationKey.Tournaments)]</th>
                <th>
                    @LocString[nameof(LocalizationKey.Ranking)]
                    @if (Model.IsAdmin)
                    {
                    <a asp-action="EditRankingHistory" asp-route-id="@Model.LeagueId" asp-route-playerId="@Model.Player.Id" 
                       target="_blank" class="btn btn-xs btn-default" style="margin-left: 3px; padding: 0px 4px;" title="@LocString[nameof(LocalizationKey.EditRankingHistory)]">‚úèÔ∏è</a>
                    }
                </th>
            </tr>
        </thead>
        <tbody>
            @{
                var positionCutoffDate = new DateTime(2024, 1, 1);
            }
            @foreach (var item in Model.MonthlyRatings.OrderByDescending(r => r.Month))
            {
                var hasRankings = monthRankingLabels.TryGetValue(item.MonthDisplay, out var rankingList);
                var hasTournamentsWithoutMatches = tournamentsWithoutMatchesByMonth.TryGetValue(item.MonthDisplay, out var noMatchTournaments);
                // Only show rows with matches, ranking changes, promotion bonuses, or tournaments without matches
                if (item.MatchesInMonth == 0 && !hasRankings && !item.HasPromotionBonus && !hasTournamentsWithoutMatches)
                {
                    continue;
                }
                var showPosition = item.Month >= positionCutoffDate && item.Position > 0;
                <tr>
                    <td>@item.MonthDisplay</td>
                    <td>@if (showPosition) { <span>@item.Position<span style="color: #999; font-size: 0.85em;">/@item.TotalPlayers</span></span> } else { <span>-</span> }</td>
                    <td>@item.RatingDisplay</td>
                    <td>
                        @if (item.Matches.Any() || (hasTournamentsWithoutMatches && noMatchTournaments.Any()))
                        {
                            @* Combine rated and unrated tournaments, order by start date descending *@
                            var allTournaments = item.Matches
                                .Select(m => new TournamentDisplayItem {
                                    TournamentId = m.TournamentId,
                                    TournamentName = m.TournamentName,
                                    TournamentShortName = m.TournamentShortName,
                                    MatchName = m.MatchName,
                                    TournamentPosition = m.TournamentPosition,
                                    FemalePosition = m.FemalePosition,
                                    TeamPosition = m.TeamPosition,
                                    StartDate = m.TournamentStartDate ?? DateTimeOffset.MinValue,
                                    HasMatches = true,
                                    IsRated = m.TournamentId.HasValue && tournamentIsRatedLookup.TryGetValue(m.TournamentId.Value, out var isRated) && isRated
                                })
                                .Concat(hasTournamentsWithoutMatches 
                                    ? noMatchTournaments.Select(tp => new TournamentDisplayItem {
                                        TournamentId = tp.TournamentId,
                                        TournamentName = tp.TournamentName,
                                        TournamentShortName = tp.TournamentShortName,
                                        MatchName = null,
                                        TournamentPosition = tp.Position,
                                        FemalePosition = tp.FemalePosition,
                                        TeamPosition = tp.TeamPosition,
                                        StartDate = tp.StartDate,
                                        HasMatches = false,
                                        IsRated = tournamentIsRatedLookup.TryGetValue(tp.TournamentId, out var isRatedNoMatch) && isRatedNoMatch
                                    })
                                    : Enumerable.Empty<TournamentDisplayItem>())
                                .OrderByDescending(t => t.StartDate)
                                .ToList();
                            
                            @foreach (var t in allTournaments)
                            {
                                // Style based on IsRated (tournament's Factor != 0 and StartDate >= 2023)
                                var style = t.IsRated ? "font-size: 0.85em;" : "font-size: 0.85em; color: #888; font-style: italic;";
                                var linkStyle = t.IsRated ? "" : "color: #888;";
                                <div style="@style">
                                    @if (t.TournamentId.HasValue)
                                    {
                                        <a asp-controller="Tournaments" asp-action="Details" asp-route-id="@t.TournamentId" style="@linkStyle" data-name="@t.TournamentShortName">@t.TournamentName</a>
                                        @if (t.TournamentPosition.HasValue)
                                        {
                                            <span style="color: #f0ad4e; margin-left: 4px;">No. @t.TournamentPosition</span>
                                        }
                                        @if (t.FemalePosition.HasValue)
                                        {
                                            <span style="color: #d63384; margin-left: 4px;">Female No. @t.FemalePosition</span>
                                        }
                                        @if (t.TeamPosition.HasValue)
                                        {
                                            <span style="color: #337ab7; margin-left: 4px;">Team No. @t.TeamPosition</span>
                                        }
                                    }
                                    else if (!string.IsNullOrEmpty(t.MatchName))
                                    {
                                        @t.MatchName
                                    }
                                </div>
                            }
                        }
                        else
                        {
                            <span>-</span>
                        }
                    </td>
                    <td>
                        @{
                            // Track which bonuses have been displayed to show orphans at the end
                            var displayedBonuses = new HashSet<int>();
                        }
                        @if (hasRankings)
                        {
                            @foreach (var rankingInfo in rankingList.OrderByDescending(r => r.sortDate))
                            {
                                <div>
                                    <span style="color: rgb(255, 99, 132); font-weight: bold;">@rankingInfo.ranking</span>
                                    <span style="color: #666; font-size: 0.85em;">(@rankingInfo.date)</span>
                                </div>
                                @if (item.HasPromotionBonus)
                                {
                                    // Match bonus to ranking by DATE (more reliable than matching ranking names)
                                    // The bonus was recorded with the ranking's date at calculation time
                                    for (int i = 0; i < item.PromotionBonuses.Count; i++)
                                    {
                                        var bonus = item.PromotionBonuses[i];
                                        // Match if bonus date equals ranking date
                                        if (bonus.PromotionDate.HasValue && 
                                            rankingInfo.date == bonus.PromotionDate.Value.ToString("dd/MM/yyyy"))
                                        {
                                            displayedBonuses.Add(i);
                                            var fromDisplay = ApplicationUser.FormatRankingForDisplay(bonus.FromRanking, bonus.FromOrg);
                                            var toDisplay = ApplicationUser.FormatRankingForDisplay(bonus.ToRanking, bonus.ToOrg);
                                            <div style="margin-left: 8px;">
                                                <span style="color: #5cb85c; font-size: 0.85em; font-weight: bold;" title="Promotion bonus applied">
                                                    +@bonus.BonusAmount.ToString("F1")
                                                </span>
                                                <span style="color: #888; font-size: 0.8em;">
                                                    (@fromDisplay‚Üí@toDisplay)
                                                </span>
                                            </div>
                                        }
                                    }
                                }
                            }
                        }
                        @if (item.HasPromotionBonus)
                        {
                            @* Show any orphan promotion bonuses (no matching ranking record) *@
                            for (int i = 0; i < item.PromotionBonuses.Count; i++)
                            {
                                if (!displayedBonuses.Contains(i))
                                {
                                    var bonus = item.PromotionBonuses[i];
                                    var fromDisplay = ApplicationUser.FormatRankingForDisplay(bonus.FromRanking, bonus.FromOrg);
                                    var toDisplay = ApplicationUser.FormatRankingForDisplay(bonus.ToRanking, bonus.ToOrg);
                                    <div>
                                        <span style="color: #5cb85c; font-size: 0.85em; font-weight: bold;" title="Promotion bonus applied">
                                            +@bonus.BonusAmount.ToString("F1")
                                        </span>
                                        <span style="color: #888; font-size: 0.8em;">
                                            (@fromDisplay‚Üí@toDisplay)
                                        </span>
                                    </div>
                                }
                            }
                        }
                    </td>
                </tr>
            }
            @{
                // For players with no matches, show their current ranking rating
                var preEntryRating = !Model.MonthlyRatings.Any() && Model.Player.Rankings != null && Model.Player.Rankings.Any()
                    ? Model.Player.GetRatingBeforeDate(DateTimeOffset.MaxValue).ToString()
                    : null;
                
                // Get unique tournaments/matches before the first month shown in the rating history
                var firstRatedMonth = Model.MonthlyRatings.Any() ? Model.MonthlyRatings.Min(r => r.Month) : DateTime.MaxValue;
                
                // Build tournament start date lookup from TournamentParticipations
                var tournamentStartDates = Model.TournamentParticipations
                    .ToDictionary(tp => tp.TournamentId, tp => tp.StartDate);
                
                var preEntryMatches = Model.GameRecords
                    .Where(g => g.Date.Year < firstRatedMonth.Year || 
                               (g.Date.Year == firstRatedMonth.Year && g.Date.Month < firstRatedMonth.Month))
                    .GroupBy(g => g.TournamentId?.ToString() ?? g.MatchName ?? "")
                    .Select(grp => grp.First())
                    .Select(g => new PlayerRatings.ViewModels.Player.MatchInfo
                    {
                        MatchName = g.MatchName,
                        TournamentId = g.TournamentId,
                        TournamentName = g.TournamentName,
                        TournamentShortName = g.TournamentShortName,
                        TournamentPosition = g.TournamentPosition,
                        FemalePosition = g.FemalePosition,
                        TeamPosition = g.TeamPosition,
                        TournamentStartDate = g.TournamentId.HasValue && tournamentStartDates.TryGetValue(g.TournamentId.Value, out var startDate) 
                            ? startDate 
                            : g.Date
                    })
                    .ToList();
                
                // Get tournaments without matches that are before the first rated month
                var preEntryTournamentIds = new HashSet<Guid>(preEntryMatches.Where(m => m.TournamentId.HasValue).Select(m => m.TournamentId.Value));
                var preEntryTournamentsWithoutMatches = Model.TournamentParticipations
                    .Where(t => !t.HasMatches && 
                           (t.StartDate.Year < firstRatedMonth.Year || 
                            (t.StartDate.Year == firstRatedMonth.Year && t.StartDate.Month < firstRatedMonth.Month)) &&
                           !preEntryTournamentIds.Contains(t.TournamentId))
                    .ToList();
                
                // Only show Pre-entry row if there's something meaningful to display
                var showPreEntry = earlyRankings.Any() || preEntryMatches.Any() || preEntryTournamentsWithoutMatches.Any() || preEntryRating != null;
            }
            @if (showPreEntry)
            {
                <tr style="background-color: #f8f9fa;">
                    <td style="color: #666; font-style: italic;">@LocString[nameof(LocalizationKey.PreEntry)]</td>
                    <td>-</td>
                    <td>@(preEntryRating ?? "-")</td>
                    <td>
                        @if (preEntryMatches.Any() || preEntryTournamentsWithoutMatches.Any())
                        {
                            @* Combine rated and unrated tournaments, order by start date descending *@
                            var preEntryAllTournaments = preEntryMatches
                                .Select(m => new TournamentDisplayItem {
                                    TournamentId = m.TournamentId,
                                    TournamentName = m.TournamentName,
                                    TournamentShortName = m.TournamentShortName,
                                    MatchName = m.MatchName,
                                    TournamentPosition = m.TournamentPosition,
                                    FemalePosition = m.FemalePosition,
                                    TeamPosition = m.TeamPosition,
                                    StartDate = m.TournamentStartDate ?? DateTimeOffset.MinValue,
                                    HasMatches = true,
                                    IsRated = m.TournamentId.HasValue && tournamentIsRatedLookup.TryGetValue(m.TournamentId.Value, out var isRatedPre) && isRatedPre
                                })
                                .Concat(preEntryTournamentsWithoutMatches.Select(tp => new TournamentDisplayItem {
                                    TournamentId = tp.TournamentId,
                                    TournamentName = tp.TournamentName,
                                    TournamentShortName = tp.TournamentShortName,
                                    MatchName = null,
                                    TournamentPosition = tp.Position,
                                    FemalePosition = tp.FemalePosition,
                                    TeamPosition = tp.TeamPosition,
                                    StartDate = tp.StartDate,
                                    HasMatches = false,
                                    IsRated = tournamentIsRatedLookup.TryGetValue(tp.TournamentId, out var isRatedPreEntry) && isRatedPreEntry
                                }))
                                .OrderByDescending(t => t.StartDate)
                                .ToList();
                            
                            @foreach (var t in preEntryAllTournaments)
                            {
                                // Pre-entry tournaments are always shown in muted style, but unrated ones are italic
                                var style = t.IsRated ? "font-size: 0.85em; color: #888;" : "font-size: 0.85em; color: #888; font-style: italic;";
                                var linkStyle = t.IsRated ? "" : "color: #888;";
                                <div style="@style">
                                    @if (t.TournamentId.HasValue)
                                    {
                                        <a asp-controller="Tournaments" asp-action="Details" asp-route-id="@t.TournamentId" style="@linkStyle" data-name="@t.TournamentShortName">@t.TournamentName</a>
                                        @if (t.TournamentPosition.HasValue)
                                        {
                                            <span style="color: #f0ad4e; margin-left: 4px;">No. @t.TournamentPosition</span>
                                        }
                                        @if (t.FemalePosition.HasValue)
                                        {
                                            @if (t.FemalePosition == 1)
                                            {
                                                <span style="color: #d63384; margin-left: 4px;" title="Female Champion">üëë</span>
                                            }
                                            else
                                            {
                                                <span style="color: #d63384; margin-left: 4px;">Female No. @t.FemalePosition</span>
                                            }
                                        }
                                        @if (t.TeamPosition.HasValue)
                                        {
                                            <span style="color: #337ab7; margin-left: 4px;">Team No. @t.TeamPosition</span>
                                        }
                                    }
                                    else if (!string.IsNullOrEmpty(t.MatchName))
                                    {
                                        @t.MatchName
                                    }
                                </div>
                            }
                        }
                        else
                        {
                            <span>-</span>
                        }
                    </td>
                    <td>
                        @if (earlyRankings.Any())
                        {
                            @foreach (var rankingInfo in earlyRankings.OrderByDescending(r => r.sortDate))
                            {
                                <div>
                                    <span style="color: rgb(255, 99, 132); font-weight: bold;">@rankingInfo.ranking</span>
                                    @if (!string.IsNullOrEmpty(rankingInfo.date))
                                    {
                                        <span style="color: #666; font-size: 0.85em;">(@rankingInfo.date)</span>
                                    }
                                </div>
                            }
                        }
                        else
                        {
                            <span>-</span>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@{
    // Matches before this date are not included in rating calculations
    var ratingStartDate = new DateTimeOffset(2023, 1, 1, 0, 0, 0, TimeSpan.Zero);
    var hasOldMatches = Model.GameRecords.Any(g => g.Date < ratingStartDate);
}

<h4 class="mt-4">@LocString[nameof(LocalizationKey.GameRecords)]</h4>
@if (hasOldMatches)
{
    <p class="text-muted" style="font-size: 0.9em; margin-bottom: 10px;">
        <em>@LocString[nameof(LocalizationKey.MatchesBeforeNotIncluded)]</em>
    </p>
}
<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>@LocString[nameof(LocalizationKey.Date)]</th>
                <th>@LocString[nameof(LocalizationKey.Match)]</th>
                <th>@LocString[nameof(LocalizationKey.Opponent)]</th>
                <th>@LocString[nameof(LocalizationKey.Result)]</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var game in Model.GameRecords.OrderByDescending(g => g.Date))
            {
                var isOldMatch = game.Date < ratingStartDate;
                var isNotRated = game.Factor == 0;
                var isGrayedOut = isOldMatch || isNotRated;
                <tr style="@(isGrayedOut ? "opacity: 0.5; background-color: #f5f5f5;" : "")">
                    <td>@game.DateDisplay</td>
                    <td>
                        @if (game.TournamentId.HasValue)
                        {
                            <a asp-controller="Tournaments" asp-action="Details" asp-route-id="@game.TournamentId" data-name="@game.TournamentShortName">@game.TournamentName</a>
                            @if (game.Round.HasValue)
                            {
                                <span class="hide-mobile"> R@(game.Round)</span>
                            }
                        }
                        else if (!string.IsNullOrEmpty(game.MatchName))
                        {
                            @game.MatchName
                        }
                        @if (isNotRated)
                        {
                            <span class="hide-mobile" style="font-size: 0.75em; color: #999; margin-left: 4px; font-style: italic;">(@LocString[nameof(LocalizationKey.NotRated)])</span>
                        }
                    </td>
                    <td>
                        <a href="@Url.Action("Player", new { id = Model.LeagueId, playerId = game.OpponentId })" style="@(isGrayedOut ? "color: #888;" : "")">@game.OpponentName</a>
                        @if (!string.IsNullOrEmpty(game.OpponentRanking))
                        {
                            <span style="font-size: 0.8em; color: #666;">@game.OpponentRanking</span>
                        }
                    </td>
                    <td style="color: @(isGrayedOut ? "#888" : game.Result == "Win" ? "green" : game.Result == "Loss" ? "red" : "gray"); font-weight: bold;">
                        @game.Result
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@section Scripts {
@if (Model.MonthlyRatings.Any())
{
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script>
        const ctx = document.getElementById('ratingChart').getContext('2d');
        
        // All months for continuous axis
        // Position data only shown from Jan 2024 onwards (too few players before that)
        const positionCutoff = new Date(2024, 0, 1);
        const labels = [@Html.Raw(string.Join(",", sortedRatings.Select(r => $"'{r.MonthDisplay}'")))];
        const ratings = [@Html.Raw(string.Join(",", sortedRatings.Select(r => r.Rating.ToString("F1", System.Globalization.CultureInfo.InvariantCulture))))];
        const positions = [@Html.Raw(string.Join(",", sortedRatings.Select(r => r.Month >= new DateTime(2024, 1, 1) && r.Position > 0 ? r.Position.ToString() : "null")))];
        const totalPlayers = [@Html.Raw(string.Join(",", sortedRatings.Select(r => r.Month >= new DateTime(2024, 1, 1) && r.TotalPlayers > 0 ? r.TotalPlayers.ToString() : "null")))];
        
        // Track which months have activity (matches or ranking changes)
        const hasActivity = [@Html.Raw(string.Join(",", sortedRatings.Select(r => (r.MatchesInMonth > 0 || monthRankingLabels.ContainsKey(r.MonthDisplay)).ToString().ToLower())))];
        
        // Ranking labels for each month (only where ranking changed)
        // Contains ranking and full date (combined if multiple)
        const rankingLabels = {
            @Html.Raw(string.Join(",", chartRankingLabels.Select(kvp => $"'{kvp.Key}': {{ ranking: '{kvp.Value.ranking}', date: '{kvp.Value.date}' }}")))
        };
        
        // Calculate min/max for better Y-axis scaling
        const minRating = Math.min(...ratings);
        const maxRating = Math.max(...ratings);
        const padding = (maxRating - minRating) * 0.1 || 50;
        
        // Calculate position axis range (inverted - lower position number = better)
        const validPositions = positions.filter(p => p !== null);
        const maxPosition = validPositions.length > 0 ? Math.max(...validPositions) : 100;
        const minPosition = validPositions.length > 0 ? Math.min(...validPositions) : 1;
        
        // Register the datalabels plugin
        Chart.register(ChartDataLabels);
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Rating',
                    data: ratings,
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    fill: true,
                    tension: 0,
                    yAxisID: 'y',
                    pointRadius: function(context) {
                        const idx = context.dataIndex;
                        if (!hasActivity[idx]) return 0; // Hide point for inactive months
                        const label = labels[idx];
                        return rankingLabels[label] ? 8 : 4;
                    },
                    pointBackgroundColor: function(context) {
                        const label = labels[context.dataIndex];
                        return rankingLabels[label] ? 'rgb(255, 99, 132)' : 'rgb(54, 162, 235)';
                    },
                    pointBorderColor: function(context) {
                        const label = labels[context.dataIndex];
                        return rankingLabels[label] ? 'rgb(255, 99, 132)' : 'rgb(54, 162, 235)';
                    },
                    pointHoverRadius: 8
                },
                {
                    label: 'Position',
                    data: positions,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0,
                    spanGaps: true,
                    yAxisID: 'y1',
                    pointRadius: function(context) {
                        const idx = context.dataIndex;
                        if (!hasActivity[idx] || positions[idx] === null) return 0;
                        return 4;
                    },
                    pointBackgroundColor: 'rgb(75, 192, 192)',
                    pointBorderColor: 'rgb(75, 192, 192)',
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const idx = context.dataIndex;
                                const label = labels[idx];
                                if (context.dataset.label === 'Rating') {
                                    const rankingInfo = rankingLabels[label];
                                    let result = 'Rating: ' + context.parsed.y.toFixed(1);
                                    if (rankingInfo) {
                                        result += ' (Promoted to ' + rankingInfo.ranking + ' on ' + rankingInfo.date + ')';
                                    }
                                    return result;
                                } else if (context.dataset.label === 'Position') {
                                    const pos = positions[idx];
                                    const total = totalPlayers[idx];
                                    if (pos !== null && total !== null) {
                                        return 'Position: ‚Ññ' + pos + ' / ' + total;
                                    }
                                    return null;
                                }
                                return context.parsed.y;
                            }
                        }
                    },
                    datalabels: {
                        align: 'top',
                        anchor: 'end',
                        offset: 4,
                        font: {
                            weight: 'bold',
                            size: 10
                        },
                        color: 'rgb(255, 99, 132)',
                        formatter: function(value, context) {
                            // Only show ranking labels for the Rating dataset
                            if (context.dataset.label !== 'Rating') return null;
                            const label = labels[context.dataIndex];
                            const rankingInfo = rankingLabels[label];
                            if (rankingInfo) {
                                return rankingInfo.ranking + '\n(' + rankingInfo.date + ')';
                            }
                            return null;
                        },
                        display: function(context) {
                            if (context.dataset.label !== 'Rating') return false;
                            const label = labels[context.dataIndex];
                            return !!rankingLabels[label];
                        },
                        textAlign: 'center'
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        position: 'left',
                        min: Math.floor(minRating - padding),
                        max: Math.ceil(maxRating + padding),
                        title: {
                            display: true,
                            text: 'Rating'
                        }
                    },
                    y1: {
                        type: 'linear',
                        position: 'right',
                        reverse: true, // Lower position number = better, so at top
                        min: Math.max(0.7, minPosition - 5), // Start from 0.7 or below min position for spacing
                        max: maxPosition + 5,
                        title: {
                            display: true,
                            text: 'Position (‚Ññ)'
                        },
                        grid: {
                            drawOnChartArea: false // Don't show grid lines for this axis
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Month'
                        }
                    }
                }
            }
        });
    </script>
}
    <script>
        // AJAX form handling for player info and rankings
        $(document).ready(function() {
            // Show status message
            function showMessage(message, isSuccess) {
                var alertClass = isSuccess ? 'alert-success' : 'alert-danger';
                var $alert = $('<div class="alert ' + alertClass + '" style="position: fixed; top: 60px; right: 20px; z-index: 9999; padding: 10px 20px;">' + message + '</div>');
                $('body').append($alert);
                setTimeout(function() { $alert.fadeOut(function() { $(this).remove(); }); }, 2000);
            }
            
            // Handle player info form
            $('#playerInfoForm').on('submit', function(e) {
                e.preventDefault();
                var $form = $(this);
                var $btn = $form.find('button[type="submit"]');
                $btn.prop('disabled', true).text('Saving...');
                
                $.ajax({
                    url: $form.attr('action'),
                    type: 'POST',
                    data: $form.serialize(),
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    success: function(response) {
                        if (response.success) {
                            showMessage(response.message, true);
                            // Update displayed values
                            var displayName = $form.find('[name="DisplayName"]').val();
                            if (displayName) {
                                $('#playerDisplayName').text(displayName);
                            }
                            var birthYear = $form.find('[name="BirthYearValue"]').val();
                            if (birthYear) {
                                $('#displayBirthYear').text(birthYear);
                                $('#birthYearRow').show();
                            } else {
                                $('#birthYearRow').hide();
                            }
                            // Extract current residence (first entry without year)
                            var fullResidence = $form.find('[name="Residence"]').val() || '';
                            var currentResidence = 'Singapore';
                            if (fullResidence) {
                                var firstEntry = fullResidence.split(';')[0].trim();
                                var parenIndex = firstEntry.lastIndexOf('(');
                                currentResidence = parenIndex > 0 ? firstEntry.substring(0, parenIndex).trim() : firstEntry;
                            }
                            $('#displayResidence').text(currentResidence || 'Singapore');
                            var photoUrl = $form.find('[name="Photo"]').val();
                            var $photoContainer = $('#playerPhotoContainer');
                            var $infoContainer = $('#playerInfoContainer');
                            if (photoUrl) {
                                if ($photoContainer.length === 0) {
                                    // Create photo container if it doesn't exist
                                    $infoContainer.before('<div class="col-xs-3 col-sm-2" id="playerPhotoContainer"><img id="playerPhoto" src="' + photoUrl + '" style="max-width: 120px; max-height: 120px; border-radius: 8px; cursor: pointer;" onclick="showPhotoModal(this.src)" title="Click to enlarge" /></div>');
                                    $infoContainer.removeClass('col-xs-12').addClass('col-xs-9 col-sm-10');
                                } else {
                                    $('#playerPhoto').attr('src', photoUrl);
                                }
                            } else {
                                // Remove photo container if URL is cleared
                                $photoContainer.remove();
                                $infoContainer.removeClass('col-xs-9 col-sm-10').addClass('col-xs-12');
                            }
                        } else {
                            showMessage(response.message || 'Error saving', false);
                        }
                    },
                    error: function() { showMessage('Error saving', false); },
                    complete: function() { $btn.prop('disabled', false).text('Save Changes'); }
                });
            });
            
            // Handle add ranking form
            $('#addRankingForm form').on('submit', function(e) {
                e.preventDefault();
                var $form = $(this);
                var $btn = $form.find('button[type="submit"]');
                $btn.prop('disabled', true).text('Adding...');
                
                $.ajax({
                    url: $form.attr('action'),
                    type: 'POST',
                    data: $form.serialize(),
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    success: function(response) {
                        if (response.success) {
                            showMessage(response.message, true);
                            // Add new row to table
                            var r = response.ranking;
                            var newRow = '<tr data-ranking-id="' + r.rankingId + '">' +
                                '<td><span style="color: rgb(255, 99, 132); font-weight: bold;">' + r.rankingGrade + '</span></td>' +
                                '<td>' + r.organization + '</td>' +
                                '<td>' + r.date + '</td>' +
                                '<td style="font-size: 0.85em; color: #666;">' + r.note + '</td>' +
                                '<td><button class="btn btn-danger btn-xs delete-ranking-btn" data-ranking-id="' + r.rankingId + '">üóëÔ∏è</button></td>' +
                                '</tr>';
                            $('#rankingsTable tbody').prepend(newRow);
                            $('#noRankingsMsg').hide();
                            $('#rankingsTable').show();
                            // Clear form
                            $form[0].reset();
                            $('#addRankingForm').collapse('hide');
                        } else {
                            showMessage(response.message || 'Error adding', false);
                        }
                    },
                    error: function() { showMessage('Error adding ranking', false); },
                    complete: function() { $btn.prop('disabled', false).text('Add Ranking'); }
                });
            });
            
            // Handle edit ranking forms
            $(document).on('submit', '.edit-ranking-form', function(e) {
                e.preventDefault();
                var $form = $(this);
                var $btn = $form.find('button[type="submit"]');
                var rankingId = $form.find('[name="RankingId"]').val();
                $btn.prop('disabled', true).text('Saving...');
                
                $.ajax({
                    url: $form.attr('action'),
                    type: 'POST',
                    data: $form.serialize(),
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    success: function(response) {
                        if (response.success) {
                            showMessage(response.message, true);
                            // Update the row
                            var r = response.ranking;
                            var $row = $('tr[data-ranking-id="' + rankingId + '"]');
                            $row.find('td:eq(0) span').text(r.rankingGrade);
                            $row.find('td:eq(1)').text(r.organization);
                            $row.find('td:eq(2)').text(r.date);
                            $row.find('td:eq(3)').text(r.note);
                            // Collapse the edit form
                            $('#editRanking_' + rankingId).collapse('hide');
                        } else {
                            showMessage(response.message || 'Error saving', false);
                        }
                    },
                    error: function() { showMessage('Error saving ranking', false); },
                    complete: function() { $btn.prop('disabled', false).text('Save'); }
                });
            });
            
            // Handle delete ranking
            $(document).on('submit', '.delete-ranking-form', function(e) {
                e.preventDefault();
                if (!confirm('Delete this ranking?')) return;
                
                var $form = $(this);
                var rankingId = $form.find('[name="rankingId"]').val();
                
                $.ajax({
                    url: $form.attr('action'),
                    type: 'POST',
                    data: $form.serialize(),
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    success: function(response) {
                        if (response.success) {
                            showMessage(response.message, true);
                            // Remove the row and edit form row
                            $('tr[data-ranking-id="' + rankingId + '"]').remove();
                            $('#editRanking_' + rankingId).closest('tr').remove();
                        } else {
                            showMessage(response.message || 'Error deleting', false);
                        }
                    },
                    error: function() { showMessage('Error deleting ranking', false); }
                });
            });
            
            // Handle photo upload
            $('#photoUploadForm').on('submit', function(e) {
                e.preventDefault();
                var $form = $(this);
                var $btn = $form.find('button[type="submit"]');
                var formData = new FormData(this);
                
                $btn.prop('disabled', true).text('Uploading...');
                
                $.ajax({
                    url: $form.attr('action'),
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    success: function(response) {
                        if (response.success) {
                            showMessage(response.message, true);
                            // Update photo display
                            var $photoContainer = $('#playerPhotoContainer');
                            var $infoContainer = $('#playerInfoContainer');
                            var photoUrl = response.photoUrl + '?t=' + Date.now();
                            if ($photoContainer.length === 0) {
                                // Create container if it doesn't exist - insert before info container
                                $infoContainer.before('<div class="col-xs-3 col-sm-2" id="playerPhotoContainer"><img id="playerPhoto" src="' + photoUrl + '" style="max-width: 120px; max-height: 120px; border-radius: 8px; cursor: pointer;" onclick="showPhotoModal(this.src)" title="Click to enlarge" /></div>');
                                $infoContainer.removeClass('col-xs-12').addClass('col-xs-9 col-sm-10');
                            } else {
                                $('#playerPhoto').attr('src', photoUrl);
                            }
                            // Update the URL input
                            $('input[name="Photo"]').val(response.photoUrl);
                            // Clear the file input
                            $form.find('input[type="file"]').val('');
                        } else {
                            showMessage(response.message || 'Error uploading', false);
                        }
                    },
                    error: function() { showMessage('Error uploading photo', false); },
                    complete: function() { $btn.prop('disabled', false).text('@LocString[nameof(LocalizationKey.Upload)]'); }
                });
            });
        });
        
        // Photo modal functionality
        function showPhotoModal(src) {
            var modal = document.getElementById('photoModal');
            var modalImg = document.getElementById('photoModalImg');
            modal.style.display = 'flex';
            modalImg.src = src;
        }
        
        function closePhotoModal() {
            document.getElementById('photoModal').style.display = 'none';
        }
        
        // Close modal when clicking outside the image
        document.addEventListener('DOMContentLoaded', function() {
            var modal = document.getElementById('photoModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closePhotoModal();
                    }
                });
            }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closePhotoModal();
            }
        });
    </script>
}

<!-- Photo Modal -->
<div id="photoModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); z-index: 9999; justify-content: center; align-items: center; cursor: pointer;">
    <span style="position: absolute; top: 20px; right: 30px; color: #fff; font-size: 35px; font-weight: bold; cursor: pointer;" onclick="closePhotoModal()">&times;</span>
    <img id="photoModalImg" src="" alt="Player Photo" style="max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5);" />
</div>


