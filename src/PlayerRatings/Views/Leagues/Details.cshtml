@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Mvc.Localization
@using PlayerRatings.Localization
@using PlayerRatings.Util
@using PlayerRatings.Models
@model PlayerRatings.ViewModels.League.LeagueDetailsViewModel

@inject UserManager<ApplicationUser> UserManager;
@{
    ViewData["Title"] = LocString[nameof(LocalizationKey.Details)];

    var appUser = await User.GetApplicationUser(UserManager);
    var number = 1;
    
    string GetStatusDisplayName(PlayerStatus status)
    {
        return status switch
        {
            PlayerStatus.Normal => "Normal",
            PlayerStatus.Blocked => "Blocked",
            PlayerStatus.Hidden => "Hidden",
            PlayerStatus.AlwaysShown => "Always Shown",
            _ => status.ToString()
        };
    }
}

<h2>@ViewData["Title"]</h2>

<div>
    <h2>@Html.DisplayFor(model => model.League.Name)</h2>
    
@if (Model.SwaRankedPlayersOnly)
{
    <form asp-action="SetProtectedRatingsOption" asp-route-supportProtectedRatings="false" asp-route-id = "@Model.League.Id" method="post" role="form">
        <button type="submit" class="btn btn-link" name="language" title="@LocString[nameof(LocalizationKey.ShowAllRankings)]">
            @LocString[nameof(LocalizationKey.ShowAllRankings)]
        </button>
    </form>
}
else
{
    <form asp-action="SetProtectedRatingsOption" asp-route-supportProtectedRatings="true" asp-route-id = "@Model.League.Id" method="post" role="form">
        <button type="submit" class="btn btn-link" name="language" value="true" title="@LocString[nameof(LocalizationKey.ShowSinRankingsOnly)]">
            @LocString[nameof(LocalizationKey.ShowSinRankingsOnly)]
        </button>
    </form>
}
    <table class="table">
        <tr>
            <th>
                №
            </th>
            <th>
                @LocString[nameof(LocalizationKey.DisplayName)]
            </th>
            <th>
                @LocString[nameof(LocalizationKey.BirthYear)]
            </th>
            <th>
                @LocString[nameof(LocalizationKey.Ranking)]
            </th>
            <th>
                @LocString[nameof(LocalizationKey.RankedDate)]
            </th>
            <th>
                @LocString[nameof(LocalizationKey.RankingHistory)]
            </th>
            @if (Model.IsAdmin)
            {
                <th>
                    @LocString[nameof(LocalizationKey.Status)]
                </th>
            }
        </tr>

        @foreach (var player in Model.Players)
        {
            <tr>
                <td>
                    @(number++)
                </td>
                <td>
                    <a href="@Url.Action("Player", new { id = Model.League.Id, playerId = player.User.Id })">@player.User.DisplayName</a>
                </td>
                <td>
                    @player.User.BirthYear
                </td>
                <td>
                    @(Model.SwaRankedPlayersOnly ? player.User.LatestSwaRanking : player.User.LatestRanking)
                </td>
                <td>
                    @(Model.SwaRankedPlayersOnly ? player.User.LatestSwaRankedDate : player.User.LatestRankedDate)
                </td>
                <td title=@(Model.SwaRankedPlayersOnly ? string.Empty : player.User.FormatedRankingHistory)>
                    @player.User.LatestRankingHistory(2, Model.SwaRankedPlayersOnly)
                </td>
                @if (Model.IsAdmin)
                {
                    <td>
                        <form asp-action="SetPlayerStatus" method="post" style="display: inline;">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="playerId" value="@player.Id" />
                            <select name="status" class="form-control input-sm" style="width: auto; display: inline-block;" onchange="this.form.submit()">
                                @foreach (PlayerStatus status in Enum.GetValues(typeof(PlayerStatus)))
                                {
                                    if (status == player.Status)
                                    {
                                        <option value="@((int)status)" selected>@GetStatusDisplayName(status)</option>
                                    }
                                    else
                                    {
                                        <option value="@((int)status)">@GetStatusDisplayName(status)</option>
                                    }
                                }
                            </select>
                        </form>
                    </td>
                }
            </tr>
        }
    </table>
</div>

@if (Model.NonLocalPlayers.Any())
{
    var nonLocalNumber = 1;
    <div style="margin-top: 30px;">
        <h3>@LocString[nameof(LocalizationKey.NonLocalPlayers)]</h3>
        <table class="table">
            <tr>
                <th>№</th>
                <th>@LocString[nameof(LocalizationKey.DisplayName)]</th>
                <th>@LocString[nameof(LocalizationKey.Residence)]</th>
                <th>@LocString[nameof(LocalizationKey.Ranking)]</th>
                <th>@LocString[nameof(LocalizationKey.RankedDate)]</th>
                <th>@LocString[nameof(LocalizationKey.RankingHistory)]</th>
                @if (Model.IsAdmin)
                {
                    <th>@LocString[nameof(LocalizationKey.Status)]</th>
                }
            </tr>
            @foreach (var player in Model.NonLocalPlayers)
            {
                <tr>
                    <td>@(nonLocalNumber++)</td>
                    <td>
                        <a href="@Url.Action("Player", new { id = Model.League.Id, playerId = player.User.Id })">@player.User.DisplayName</a>
                    </td>
                    <td>@player.User.CurrentResidence</td>
                    <td>@(Model.SwaRankedPlayersOnly ? player.User.LatestSwaRanking : player.User.LatestRanking)</td>
                    <td>@(Model.SwaRankedPlayersOnly ? player.User.LatestSwaRankedDate : player.User.LatestRankedDate)</td>
                    <td title=@(Model.SwaRankedPlayersOnly ? string.Empty : player.User.FormatedRankingHistory)>
                        @player.User.LatestRankingHistory(2, Model.SwaRankedPlayersOnly)
                    </td>
                    @if (Model.IsAdmin)
                    {
                        <td>
                            <form asp-action="SetPlayerStatus" method="post" style="display: inline;">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="playerId" value="@player.Id" />
                                <select name="status" class="form-control input-sm" style="width: auto; display: inline-block;" onchange="this.form.submit()">
                                    @foreach (PlayerStatus status in Enum.GetValues(typeof(PlayerStatus)))
                                    {
                                        if (status == player.Status)
                                        {
                                            <option value="@((int)status)" selected>@GetStatusDisplayName(status)</option>
                                        }
                                        else
                                        {
                                            <option value="@((int)status)">@GetStatusDisplayName(status)</option>
                                        }
                                    }
                                </select>
                            </form>
                        </td>
                    }
                </tr>
            }
        </table>
    </div>
}

<p>
    <a asp-action="Edit" asp-route-id="@Model.League.Id">@LocString[nameof(LocalizationKey.Edit)]</a> |
    <a asp-action="Index">@LocString[nameof(LocalizationKey.BackToList)]</a>
</p>
